{
  "version": 3,
  "sources": ["../bundle-JRcDkR/checked-fetch.js", "../bundle-JRcDkR/strip-cf-connecting-ip-header.js", "wrangler-modules-watch:wrangler:modules-watch", "../../../node_modules/wrangler/templates/modules-watch-stub.js", "../../../src/types/index.ts", "../../../src/data/generals.ts", "../bundle-JRcDkR/middleware-loader.entry.ts", "../bundle-JRcDkR/middleware-insertion-facade.js", "../../../src/index.ts", "../../../src/durable-objects/GameRoom.ts", "../../../src/data/map.ts", "../../../src/services/combat.ts", "../../../src/services/skill.ts", "../../../src/services/movement.ts", "../../../src/services/vision.ts", "../../../src/middleware/auth.ts", "../../../src/db/tidb.ts", "../../../node_modules/@tidbcloud/serverless/dist/index.js", "../../../src/handlers/game.ts", "../../../src/handlers/action.ts", "../../../src/handlers/query.ts", "../../../node_modules/wrangler/templates/middleware/middleware-ensure-req-body-drained.ts", "../../../node_modules/wrangler/templates/middleware/middleware-miniflare3-json-error.ts", "../../../node_modules/wrangler/templates/middleware/common.ts"],
  "sourceRoot": "/Users/chenyusen/clawd/three-kingdoms-slg/.wrangler/tmp/dev-PyCE04",
  "sourcesContent": ["const urls = new Set();\n\nfunction checkURL(request, init) {\n\tconst url =\n\t\trequest instanceof URL\n\t\t\t? request\n\t\t\t: new URL(\n\t\t\t\t\t(typeof request === \"string\"\n\t\t\t\t\t\t? new Request(request, init)\n\t\t\t\t\t\t: request\n\t\t\t\t\t).url\n\t\t\t\t);\n\tif (url.port && url.port !== \"443\" && url.protocol === \"https:\") {\n\t\tif (!urls.has(url.toString())) {\n\t\t\turls.add(url.toString());\n\t\t\tconsole.warn(\n\t\t\t\t`WARNING: known issue with \\`fetch()\\` requests to custom HTTPS ports in published Workers:\\n` +\n\t\t\t\t\t` - ${url.toString()} - the custom port will be ignored when the Worker is published using the \\`wrangler deploy\\` command.\\n`\n\t\t\t);\n\t\t}\n\t}\n}\n\nglobalThis.fetch = new Proxy(globalThis.fetch, {\n\tapply(target, thisArg, argArray) {\n\t\tconst [request, init] = argArray;\n\t\tcheckURL(request, init);\n\t\treturn Reflect.apply(target, thisArg, argArray);\n\t},\n});\n", "function stripCfConnectingIPHeader(input, init) {\n\tconst request = new Request(input, init);\n\trequest.headers.delete(\"CF-Connecting-IP\");\n\treturn request;\n}\n\nglobalThis.fetch = new Proxy(globalThis.fetch, {\n\tapply(target, thisArg, argArray) {\n\t\treturn Reflect.apply(target, thisArg, [\n\t\t\tstripCfConnectingIPHeader.apply(null, argArray),\n\t\t]);\n\t},\n});\n", "", "// `esbuild` doesn't support returning `watch*` options from `onStart()`\n// plugin callbacks. Instead, we define an empty virtual module that is\n// imported by this injected file. Importing the module registers watchers.\nimport \"wrangler:modules-watch\";\n", "// \u73AF\u5883\u7C7B\u578B\u5B9A\u4E49\nexport interface Env {\n  GAME_ROOM: DurableObjectNamespace;\n  TIDB_HOST: string;\n  TIDB_USER: string;\n  TIDB_PASSWORD: string;\n  TIDB_DATABASE: string;\n  ENVIRONMENT: string;\n}\n\n// \u9635\u8425\u7C7B\u578B\nexport type Faction = \"\u8700\" | \"\u9B4F\" | \"\u5434\" | \"\u7FA4\";\n\n// \u6B66\u5C06\u7C7B\u578B\nexport type GeneralType = \"\u731B\u5C06\" | \"\u9A91\u5175\" | \"\u8C0B\u58EB\" | \"\u5F13\u624B\" | \"\u5B88\u5C06\" | \"\u523A\u5BA2\" | \"\u5747\u8861\" | \"\u541B\u4E3B\";\n\n// \u6280\u80FD\u7C7B\u578B\nexport type SkillType = \"passive\" | \"active\";\n\n// \u6B66\u5C06\u5B9A\u4E49\nexport interface General {\n  id: number;\n  name: string;\n  faction: Faction;\n  type: GeneralType;\n  base_hp: number;\n  base_atk: number;\n  base_def: number;\n  base_mov: number;\n  skill_name: string;\n  skill_desc: string;\n  skill_type: SkillType;\n}\n\n// \u73A9\u5BB6\u6807\u8BC6\nexport type PlayerSide = \"p1\" | \"p2\";\n\n// \u65B9\u5411\nexport type Direction = \"up\" | \"down\" | \"left\" | \"right\";\n\n// Buff\u6548\u679C\nexport interface Buff {\n  type: string;\n  value: number;\n  duration: number; // -1 \u8868\u793A\u6C38\u4E45\n  source: string;\n}\n\n// \u6218\u573A\u6B66\u5C06\u5B9E\u4F8B\nexport interface BattleGeneral {\n  instance_id: string;\n  general_id: number;\n  owner: PlayerSide;\n  current_hp: number;\n  position: Position;\n  facing: Direction;\n  atk_modifier: number;\n  def_modifier: number;\n  mov_modifier: number;\n  has_acted: boolean;\n  is_alive: boolean;\n  buffs: Buff[];\n  skill_state: Record<string, any>;\n  moved_distance?: number; // \u672C\u56DE\u5408\u5DF2\u79FB\u52A8\u8DDD\u79BB\n}\n\n// \u4F4D\u7F6E\nexport interface Position {\n  x: number;\n  y: number;\n}\n\n// \u5730\u5F62\u7C7B\u578B\nexport type TerrainType = \"plain\" | \"forest\" | \"mountain\" | \"river\" | \"bridge\" | \"road\" | \"city\";\n\n// \u5730\u5F62\u683C\u5B50\nexport interface TerrainTile {\n  type: TerrainType;\n  mov_cost: number;\n  def_bonus: number;\n}\n\n// \u533A\u57DF\u5B9A\u4E49\nexport interface Area {\n  x1: number;\n  y1: number;\n  x2: number;\n  y2: number;\n}\n\n// \u5730\u56FE\u6570\u636E\nexport interface MapData {\n  width: number;\n  height: number;\n  terrains: TerrainType[][];\n  p1_spawn: Area;\n  p2_spawn: Area;\n  city_area: Area;\n  city_gates: Position[];\n}\n\n// \u6E38\u620F\u72B6\u6001\nexport type GameStatus = \"waiting\" | \"selecting\" | \"deploying\" | \"playing\" | \"finished\";\n\n// \u6E38\u620F\u72B6\u6001\nexport interface GameState {\n  game_id: string;\n  status: GameStatus;\n  turn: number;\n  current_player: PlayerSide;\n\n  // \u9009\u5C06\u9636\u6BB5\n  banned_generals: number[];\n  p1_picks: number[];\n  p2_picks: number[];\n  pick_phase: number;\n\n  // \u5BF9\u6218\u9636\u6BB5\n  p1_generals: BattleGeneral[];\n  p2_generals: BattleGeneral[];\n\n  // \u57CE\u6C60\u72B6\u6001\n  city_holder: PlayerSide | null;\n  city_hold_turns: number;\n\n  // \u5730\u56FE\n  map: MapData;\n\n  // \u7ED3\u679C\n  winner: PlayerSide | null;\n  win_reason: string | null;\n\n  // \u73A9\u5BB6\u4FE1\u606F\n  p1_agent_id: string;\n  p2_agent_id: string | null;\n\n  // \u4E0A\u4E00\u6B21\u64CD\u4F5C\u7684\u6B66\u5C06ID\u5217\u8868\uFF08\u5F20\u8FBD\u5A01\u9707\u6280\u80FD\u7528\uFF09\n  attacked_enemies: Record<string, boolean>;\n\n  // \u59DC\u7EF4\u9996\u6B21\u53D7\u4F24\u8BB0\u5F55\n  first_damage_taken: Record<string, boolean>;\n}\n\n// \u64CD\u4F5C\u7C7B\u578B\nexport type ActionType = \"MOVE\" | \"ATTACK\" | \"SKILL\" | \"WAIT\" | \"RETREAT\" | \"END_TURN\";\n\n// \u64CD\u4F5C\u8BF7\u6C42\nexport interface ActionRequest {\n  player: PlayerSide;\n  action: ActionType;\n  instance_id?: string;\n  target_x?: number;\n  target_y?: number;\n  target_instance_id?: string;\n  skill_target?: string;\n}\n\n// \u6218\u6597\u7ED3\u679C\nexport interface CombatResult {\n  damage: number;\n  counter_damage: number;\n  attacker_killed: boolean;\n  target_killed: boolean;\n  triggered_skills: string[];\n  special_effects: SpecialEffect[];\n}\n\n// \u7279\u6B8A\u6548\u679C\nexport interface SpecialEffect {\n  type: string;\n  target: string;\n  value: any;\n}\n\n// WebSocket\u4E8B\u4EF6\nexport interface WSEvent {\n  type: string;\n  data: any;\n  for_player?: PlayerSide;\n}\n\n// \u9519\u8BEF\u7801\nexport const ErrorCodes = {\n  GAME_NOT_FOUND: { code: 1001, message: \"\u6E38\u620F\u4E0D\u5B58\u5728\" },\n  NOT_YOUR_TURN: { code: 1002, message: \"\u975E\u5F53\u524D\u73A9\u5BB6\u56DE\u5408\" },\n  COOLDOWN: { code: 1003, message: \"\u64CD\u4F5C\u51B7\u5374\u4E2D\" },\n  ALREADY_ACTED: { code: 1004, message: \"\u6B66\u5C06\u5DF2\u884C\u52A8\" },\n  INVALID_POSITION: { code: 1005, message: \"\u76EE\u6807\u4F4D\u7F6E\u4E0D\u53EF\u8FBE\" },\n  TARGET_OUT_OF_RANGE: { code: 1006, message: \"\u653B\u51FB\u76EE\u6807\u4E0D\u5728\u8303\u56F4\u5185\" },\n  GENERAL_DEAD: { code: 1007, message: \"\u6B66\u5C06\u5DF2\u9635\u4EA1\" },\n  INVALID_ACTION: { code: 1008, message: \"\u65E0\u6548\u64CD\u4F5C\" },\n  GAME_FULL: { code: 1009, message: \"\u6E38\u620F\u5DF2\u6EE1\" },\n  INVALID_GENERAL: { code: 1010, message: \"\u65E0\u6548\u6B66\u5C06\" },\n  GENERAL_BANNED: { code: 1011, message: \"\u6B66\u5C06\u5DF2\u88AB\u7981\u7528\" },\n  GENERAL_PICKED: { code: 1012, message: \"\u6B66\u5C06\u5DF2\u88AB\u9009\u62E9\" },\n  INVALID_DEPLOY_POSITION: { code: 1013, message: \"\u65E0\u6548\u90E8\u7F72\u4F4D\u7F6E\" },\n  CANNOT_RETREAT: { code: 1014, message: \"\u65E0\u6CD5\u64A4\u9000\uFF08\u88AB\u5178\u97E6\u6076\u6765\u6280\u80FD\u9650\u5236\uFF09\" },\n} as const;\n\n// API\u54CD\u5E94\nexport interface ApiResponse<T = any> {\n  success: boolean;\n  data?: T;\n  error?: { code: number; message: string };\n}\n\n// \u9009\u5C06\u9636\u6BB5\u987A\u5E8F\nexport const PICK_ORDER: { phase: number; action: \"ban\" | \"pick\"; player: PlayerSide; count: number }[] = [\n  { phase: 1, action: \"ban\", player: \"p1\", count: 1 },\n  { phase: 2, action: \"ban\", player: \"p2\", count: 1 },\n  { phase: 3, action: \"ban\", player: \"p1\", count: 1 },\n  { phase: 4, action: \"ban\", player: \"p2\", count: 1 },\n  { phase: 5, action: \"pick\", player: \"p1\", count: 1 },\n  { phase: 6, action: \"pick\", player: \"p2\", count: 2 },\n  { phase: 7, action: \"pick\", player: \"p1\", count: 2 },\n  { phase: 8, action: \"pick\", player: \"p2\", count: 2 },\n  { phase: 9, action: \"pick\", player: \"p1\", count: 2 },\n  { phase: 10, action: \"pick\", player: \"p2\", count: 1 },\n];\n\n// \u90E8\u7F72\u4FE1\u606F\nexport interface DeploymentInfo {\n  general_id: number;\n  x: number;\n  y: number;\n}\n\n// \u6E38\u620F\u72B6\u6001\u54CD\u5E94\uFF08\u7ED9\u73A9\u5BB6\u770B\u7684\uFF09\nexport interface GameStateResponse {\n  game_id: string;\n  status: GameStatus;\n  turn: number;\n  current_player: PlayerSide;\n  my_player: PlayerSide;\n\n  my_generals: {\n    instance_id: string;\n    general_id: number;\n    name: string;\n    current_hp: number;\n    max_hp: number;\n    atk: number;\n    def: number;\n    mov: number;\n    position: Position;\n    has_acted: boolean;\n    buffs: string[];\n  }[];\n\n  visible_enemies: {\n    instance_id: string;\n    general_id: number;\n    name: string;\n    current_hp: number;\n    max_hp: number;\n    position: Position;\n  }[];\n\n  city: {\n    holder: PlayerSide | \"contested\" | null;\n    hold_turns: number;\n  };\n\n  action_cooldown: {\n    can_act: boolean;\n    next_action_time: number;\n  };\n\n  // \u9009\u5C06\u9636\u6BB5\u4FE1\u606F\n  pick_phase?: number;\n  banned_generals?: number[];\n  my_picks?: number[];\n  enemy_picks?: number[];\n\n  winner: PlayerSide | null;\n  win_reason: string | null;\n}\n", "import { General } from \"../types\";\n\nexport const GENERALS: General[] = [\n  // \u8700\u6C49 (10\u4F4D)\n  {\n    id: 1,\n    name: \"\u5218\u5907\",\n    faction: \"\u8700\",\n    type: \"\u541B\u4E3B\",\n    base_hp: 6,\n    base_atk: 4,\n    base_def: 5,\n    base_mov: 5,\n    skill_name: \"\u4EC1\u5FB7\",\n    skill_desc: \"\u76F8\u90BB\u53CB\u519B\u653B\u51FB+1\",\n    skill_type: \"passive\",\n  },\n  {\n    id: 2,\n    name: \"\u5173\u7FBD\",\n    faction: \"\u8700\",\n    type: \"\u731B\u5C06\",\n    base_hp: 7,\n    base_atk: 9,\n    base_def: 6,\n    base_mov: 4,\n    skill_name: \"\u6B66\u5723\",\n    skill_desc: \"\u653B\u51FB\u65E0\u89C61\u70B9\u9632\u5FA1\",\n    skill_type: \"passive\",\n  },\n  {\n    id: 3,\n    name: \"\u5F20\u98DE\",\n    faction: \"\u8700\",\n    type: \"\u731B\u5C06\",\n    base_hp: 8,\n    base_atk: 8,\n    base_def: 4,\n    base_mov: 5,\n    skill_name: \"\u5486\u54EE\",\n    skill_desc: \"HP<3\u65F6\u653B\u51FB+2\",\n    skill_type: \"passive\",\n  },\n  {\n    id: 4,\n    name: \"\u8D75\u4E91\",\n    faction: \"\u8700\",\n    type: \"\u9A91\u5175\",\n    base_hp: 6,\n    base_atk: 7,\n    base_def: 6,\n    base_mov: 7,\n    skill_name: \"\u9F99\u80C6\",\n    skill_desc: \"\u51FB\u6740\u540E\u53EF\u518D\u79FB\u52A82\u683C\",\n    skill_type: \"passive\",\n  },\n  {\n    id: 5,\n    name: \"\u8BF8\u845B\u4EAE\",\n    faction: \"\u8700\",\n    type: \"\u8C0B\u58EB\",\n    base_hp: 4,\n    base_atk: 3,\n    base_def: 3,\n    base_mov: 4,\n    skill_name: \"\u795E\u7B97\",\n    skill_desc: \"\u53EF\u6307\u63252\u683C\u5185\u53CB\u519B\u884C\u52A8(\u6D88\u8017\u81EA\u5DF1\u884C\u52A8)\",\n    skill_type: \"active\",\n  },\n  {\n    id: 6,\n    name: \"\u9A6C\u8D85\",\n    faction: \"\u8700\",\n    type: \"\u9A91\u5175\",\n    base_hp: 6,\n    base_atk: 8,\n    base_def: 5,\n    base_mov: 8,\n    skill_name: \"\u94C1\u9A91\",\n    skill_desc: \"\u672C\u56DE\u5408\u79FB\u52A8\u22653\u683C\u540E\u653B\u51FB+2\",\n    skill_type: \"passive\",\n  },\n  {\n    id: 7,\n    name: \"\u9EC4\u5FE0\",\n    faction: \"\u8700\",\n    type: \"\u5F13\u624B\",\n    base_hp: 5,\n    base_atk: 7,\n    base_def: 4,\n    base_mov: 4,\n    skill_name: \"\u767E\u6B65\",\n    skill_desc: \"\u653B\u51FB\u8303\u56F43\u683C\",\n    skill_type: \"passive\",\n  },\n  {\n    id: 8,\n    name: \"\u9B4F\u5EF6\",\n    faction: \"\u8700\",\n    type: \"\u731B\u5C06\",\n    base_hp: 7,\n    base_atk: 7,\n    base_def: 5,\n    base_mov: 5,\n    skill_name: \"\u53CD\u9AA8\",\n    skill_desc: \"\u88AB\u653B\u51FB\u65F6\u53CD\u51FB\u4F24\u5BB3+1\",\n    skill_type: \"passive\",\n  },\n  {\n    id: 9,\n    name: \"\u59DC\u7EF4\",\n    faction: \"\u8700\",\n    type: \"\u5747\u8861\",\n    base_hp: 6,\n    base_atk: 6,\n    base_def: 5,\n    base_mov: 6,\n    skill_name: \"\u80C6\u7565\",\n    skill_desc: \"\u6BCF\u573A\u6218\u6597\u9996\u6B21\u53D7\u4F24\u51CF\u514D1\u70B9\",\n    skill_type: \"passive\",\n  },\n  {\n    id: 10,\n    name: \"\u5E9E\u7EDF\",\n    faction: \"\u8700\",\n    type: \"\u8C0B\u58EB\",\n    base_hp: 4,\n    base_atk: 4,\n    base_def: 3,\n    base_mov: 5,\n    skill_name: \"\u8FDE\u73AF\",\n    skill_desc: \"\u653B\u51FB\u65F6\u5BF9\u76EE\u6807\u76F8\u90BB\u76841\u4E2A\u654C\u4EBA\u9020\u62101\u70B9\u6E85\u5C04\u4F24\u5BB3\",\n    skill_type: \"passive\",\n  },\n\n  // \u9B4F\u56FD (11\u4F4D)\n  {\n    id: 11,\n    name: \"\u66F9\u64CD\",\n    faction: \"\u9B4F\",\n    type: \"\u541B\u4E3B\",\n    base_hp: 6,\n    base_atk: 6,\n    base_def: 5,\n    base_mov: 5,\n    skill_name: \"\u5978\u96C4\",\n    skill_desc: \"\u51FB\u6740\u654C\u4EBA\u56DE\u590D1HP\",\n    skill_type: \"passive\",\n  },\n  {\n    id: 12,\n    name: \"\u5F20\u8FBD\",\n    faction: \"\u9B4F\",\n    type: \"\u9A91\u5175\",\n    base_hp: 6,\n    base_atk: 7,\n    base_def: 5,\n    base_mov: 7,\n    skill_name: \"\u5A01\u9707\",\n    skill_desc: \"\u5BF9\u6BCF\u4E2A\u654C\u4EBA\u7684\u9996\u6B21\u653B\u51FB\u4F7F\u5176\u9632\u5FA1-1(\u6301\u7EED\u5230\u6218\u6597\u7ED3\u675F)\",\n    skill_type: \"passive\",\n  },\n  {\n    id: 13,\n    name: \"\u590F\u4FAF\u60C7\",\n    faction: \"\u9B4F\",\n    type: \"\u731B\u5C06\",\n    base_hp: 8,\n    base_atk: 6,\n    base_def: 6,\n    base_mov: 5,\n    skill_name: \"\u521A\u70C8\",\n    skill_desc: \"\u53D7\u5230\u4F24\u5BB3\u65F6\u5BF9\u653B\u51FB\u8005\u9020\u62101\u70B9\u53CD\u4F24\",\n    skill_type: \"passive\",\n  },\n  {\n    id: 14,\n    name: \"\u590F\u4FAF\u6E0A\",\n    faction: \"\u9B4F\",\n    type: \"\u9A91\u5175\",\n    base_hp: 5,\n    base_atk: 6,\n    base_def: 4,\n    base_mov: 9,\n    skill_name: \"\u6025\u88AD\",\n    skill_desc: \"\u65E0\u989D\u5916\u6548\u679C\uFF0C\u7EAF\u9AD8\u673A\u52A8\",\n    skill_type: \"passive\",\n  },\n  {\n    id: 15,\n    name: \"\u8BB8\u891A\",\n    faction: \"\u9B4F\",\n    type: \"\u731B\u5C06\",\n    base_hp: 9,\n    base_atk: 7,\n    base_def: 5,\n    base_mov: 4,\n    skill_name: \"\u864E\u75F4\",\n    skill_desc: \"\u65E0\u989D\u5916\u6548\u679C\uFF0C\u7EAF\u9AD8\u8840\u91CF\",\n    skill_type: \"passive\",\n  },\n  {\n    id: 16,\n    name: \"\u5178\u97E6\",\n    faction: \"\u9B4F\",\n    type: \"\u731B\u5C06\",\n    base_hp: 8,\n    base_atk: 8,\n    base_def: 6,\n    base_mov: 3,\n    skill_name: \"\u6076\u6765\",\n    skill_desc: \"\u76F8\u90BB\u654C\u4EBA\u65E0\u6CD5\u4F7F\u7528\u64A4\u9000\u6307\u4EE4\",\n    skill_type: \"passive\",\n  },\n  {\n    id: 17,\n    name: \"\u53F8\u9A6C\u61FF\",\n    faction: \"\u9B4F\",\n    type: \"\u8C0B\u58EB\",\n    base_hp: 5,\n    base_atk: 4,\n    base_def: 4,\n    base_mov: 5,\n    skill_name: \"\u9690\u5FCD\",\n    skill_desc: \"\u8FDE\u7EED3\u56DE\u5408\u4E0D\u79FB\u52A8\u4E0D\u653B\u51FB\u540E\uFF0C\u653B\u9632\u5404+2(\u79FB\u52A8\u6216\u653B\u51FB\u540E\u91CD\u7F6E)\",\n    skill_type: \"passive\",\n  },\n  {\n    id: 18,\n    name: \"\u90ED\u5609\",\n    faction: \"\u9B4F\",\n    type: \"\u8C0B\u58EB\",\n    base_hp: 3,\n    base_atk: 3,\n    base_def: 2,\n    base_mov: 6,\n    skill_name: \"\u9B3C\u624D\",\n    skill_desc: \"\u53EF\u67E5\u770B5\u683C\u8303\u56F4\u5185\u654C\u4EBA\u4E0B\u4E00\u6B65\u884C\u52A8\u610F\u56FE\",\n    skill_type: \"active\",\n  },\n  {\n    id: 19,\n    name: \"\u5F20\u90C3\",\n    faction: \"\u9B4F\",\n    type: \"\u5747\u8861\",\n    base_hp: 6,\n    base_atk: 6,\n    base_def: 6,\n    base_mov: 6,\n    skill_name: \"\u5DE7\u53D8\",\n    skill_desc: \"\u53EF\u659C\u5411\u79FB\u52A8\",\n    skill_type: \"passive\",\n  },\n  {\n    id: 20,\n    name: \"\u5F90\u6643\",\n    faction: \"\u9B4F\",\n    type: \"\u731B\u5C06\",\n    base_hp: 7,\n    base_atk: 7,\n    base_def: 5,\n    base_mov: 5,\n    skill_name: \"\u65AD\u7CAE\",\n    skill_desc: \"\u653B\u51FB\u4F4D\u4E8E\u5DF1\u65B9\u51FA\u751F\u533A\u5230\u57CE\u6C60\u8FDE\u7EBF\u4E0A\u7684\u654C\u4EBA\u65F6\u4F24\u5BB3+2\",\n    skill_type: \"passive\",\n  },\n  {\n    id: 21,\n    name: \"\u66F9\u4EC1\",\n    faction: \"\u9B4F\",\n    type: \"\u5B88\u5C06\",\n    base_hp: 7,\n    base_atk: 5,\n    base_def: 8,\n    base_mov: 4,\n    skill_name: \"\u575A\u5B88\",\n    skill_desc: \"\u5728\u57CE\u6C60\u5185\u65F6\u989D\u5916\u9632\u5FA1+1\",\n    skill_type: \"passive\",\n  },\n\n  // \u5434\u56FD (8\u4F4D)\n  {\n    id: 22,\n    name: \"\u5B59\u6743\",\n    faction: \"\u5434\",\n    type: \"\u541B\u4E3B\",\n    base_hp: 5,\n    base_atk: 5,\n    base_def: 5,\n    base_mov: 5,\n    skill_name: \"\u5236\u8861\",\n    skill_desc: \"\u76F8\u90BB\u53CB\u519B\u5171\u4EAB\u6700\u9AD8\u9632\u5FA1\u503C(\u53D6\u76F8\u90BB\u53CB\u519B\u4E2D\u6700\u9AD8\u9632\u5FA1)\",\n    skill_type: \"passive\",\n  },\n  {\n    id: 23,\n    name: \"\u5B59\u7B56\",\n    faction: \"\u5434\",\n    type: \"\u731B\u5C06\",\n    base_hp: 6,\n    base_atk: 8,\n    base_def: 4,\n    base_mov: 7,\n    skill_name: \"\u9738\u738B\",\n    skill_desc: \"\u5468\u56F42\u683C\u5185\u53EA\u67091\u4E2A\u654C\u4EBA\u65F6\u653B\u51FB+3\",\n    skill_type: \"passive\",\n  },\n  {\n    id: 24,\n    name: \"\u5468\u745C\",\n    faction: \"\u5434\",\n    type: \"\u8C0B\u58EB\",\n    base_hp: 5,\n    base_atk: 5,\n    base_def: 4,\n    base_mov: 5,\n    skill_name: \"\u706B\u653B\",\n    skill_desc: \"\u653B\u51FB\u540E\u76EE\u6807\u83B7\u5F97\\\"\u707C\u70E7\\\"\u72B6\u6001\uFF0C\u4E0B\u56DE\u5408\u5F00\u59CB\u53D7\u52301\u70B9\u4F24\u5BB3\",\n    skill_type: \"passive\",\n  },\n  {\n    id: 25,\n    name: \"\u9646\u900A\",\n    faction: \"\u5434\",\n    type: \"\u8C0B\u58EB\",\n    base_hp: 5,\n    base_atk: 5,\n    base_def: 5,\n    base_mov: 6,\n    skill_name: \"\u8425\u70E7\",\n    skill_desc: \"\u653B\u51FB\u8303\u56F4+1\u683C(\u53EF\u653B\u51FB2\u683C\u5185\u654C\u4EBA)\",\n    skill_type: \"passive\",\n  },\n  {\n    id: 26,\n    name: \"\u7518\u5B81\",\n    faction: \"\u5434\",\n    type: \"\u523A\u5BA2\",\n    base_hp: 5,\n    base_atk: 8,\n    base_def: 3,\n    base_mov: 8,\n    skill_name: \"\u7A81\u88AD\",\n    skill_desc: \"\u4ECE\u654C\u4EBA\u80CC\u540E(\u654C\u4EBA\u9762\u671D\u65B9\u5411\u7684\u53CD\u65B9\u5411)\u653B\u51FB\u65F6\u4F24\u5BB3\u00D72\",\n    skill_type: \"passive\",\n  },\n  {\n    id: 27,\n    name: \"\u592A\u53F2\u6148\",\n    faction: \"\u5434\",\n    type: \"\u5F13\u624B\",\n    base_hp: 6,\n    base_atk: 7,\n    base_def: 5,\n    base_mov: 5,\n    skill_name: \"\u795E\u5C04\",\n    skill_desc: \"\u8FDC\u7A0B\u653B\u51FB(2-3\u683C)\u65F6\u4E0D\u53D7\u53CD\u51FB\",\n    skill_type: \"passive\",\n  },\n  {\n    id: 28,\n    name: \"\u5415\u8499\",\n    faction: \"\u5434\",\n    type: \"\u5747\u8861\",\n    base_hp: 6,\n    base_atk: 6,\n    base_def: 5,\n    base_mov: 6,\n    skill_name: \"\u767D\u8863\",\n    skill_desc: \"\u79FB\u52A8\u65F6\u53EF\u7A7F\u8D8A\u654C\u65B9\u5355\u4F4D(\u4E0D\u80FD\u505C\u7559)\",\n    skill_type: \"passive\",\n  },\n  {\n    id: 29,\n    name: \"\u9EC4\u76D6\",\n    faction: \"\u5434\",\n    type: \"\u5B88\u5C06\",\n    base_hp: 7,\n    base_atk: 5,\n    base_def: 7,\n    base_mov: 4,\n    skill_name: \"\u82E6\u8089\",\n    skill_desc: \"\u6BCF\u635F\u59311\u70B9HP\uFF0C\u653B\u51FB+1\",\n    skill_type: \"passive\",\n  },\n\n  // \u7FA4\u96C4 (1\u4F4D)\n  {\n    id: 30,\n    name: \"\u5415\u5E03\",\n    faction: \"\u7FA4\",\n    type: \"\u731B\u5C06\",\n    base_hp: 7,\n    base_atk: 9,\n    base_def: 5,\n    base_mov: 8,\n    skill_name: \"\u65E0\u53CC\",\n    skill_desc: \"\u653B\u51FB\u65F6\u65E0\u89C6\u6240\u6709\u88AB\u52A8\u51CF\u4F24\u6548\u679C\",\n    skill_type: \"passive\",\n  },\n];\n\n// \u6839\u636EID\u83B7\u53D6\u6B66\u5C06\nexport function getGeneralById(id: number): General | undefined {\n  return GENERALS.find((g) => g.id === id);\n}\n\n// \u6839\u636E\u9635\u8425\u83B7\u53D6\u6B66\u5C06\u5217\u8868\nexport function getGeneralsByFaction(faction: string): General[] {\n  return GENERALS.filter((g) => g.faction === faction);\n}\n\n// \u83B7\u53D6\u6240\u6709\u6B66\u5C06ID\nexport function getAllGeneralIds(): number[] {\n  return GENERALS.map((g) => g.id);\n}\n", "// This loads all middlewares exposed on the middleware object and then starts\n// the invocation chain. The big idea is that we can add these to the middleware\n// export dynamically through wrangler, or we can potentially let users directly\n// add them as a sort of \"plugin\" system.\n\nimport ENTRY, { __INTERNAL_WRANGLER_MIDDLEWARE__ } from \"/Users/chenyusen/clawd/three-kingdoms-slg/.wrangler/tmp/bundle-JRcDkR/middleware-insertion-facade.js\";\nimport { __facade_invoke__, __facade_register__, Dispatcher } from \"/Users/chenyusen/clawd/three-kingdoms-slg/node_modules/wrangler/templates/middleware/common.ts\";\nimport type { WorkerEntrypointConstructor } from \"/Users/chenyusen/clawd/three-kingdoms-slg/.wrangler/tmp/bundle-JRcDkR/middleware-insertion-facade.js\";\n\n// Preserve all the exports from the worker\nexport * from \"/Users/chenyusen/clawd/three-kingdoms-slg/.wrangler/tmp/bundle-JRcDkR/middleware-insertion-facade.js\";\n\nclass __Facade_ScheduledController__ implements ScheduledController {\n\treadonly #noRetry: ScheduledController[\"noRetry\"];\n\n\tconstructor(\n\t\treadonly scheduledTime: number,\n\t\treadonly cron: string,\n\t\tnoRetry: ScheduledController[\"noRetry\"]\n\t) {\n\t\tthis.#noRetry = noRetry;\n\t}\n\n\tnoRetry() {\n\t\tif (!(this instanceof __Facade_ScheduledController__)) {\n\t\t\tthrow new TypeError(\"Illegal invocation\");\n\t\t}\n\t\t// Need to call native method immediately in case uncaught error thrown\n\t\tthis.#noRetry();\n\t}\n}\n\nfunction wrapExportedHandler(worker: ExportedHandler): ExportedHandler {\n\t// If we don't have any middleware defined, just return the handler as is\n\tif (\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__ === undefined ||\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__.length === 0\n\t) {\n\t\treturn worker;\n\t}\n\t// Otherwise, register all middleware once\n\tfor (const middleware of __INTERNAL_WRANGLER_MIDDLEWARE__) {\n\t\t__facade_register__(middleware);\n\t}\n\n\tconst fetchDispatcher: ExportedHandlerFetchHandler = function (\n\t\trequest,\n\t\tenv,\n\t\tctx\n\t) {\n\t\tif (worker.fetch === undefined) {\n\t\t\tthrow new Error(\"Handler does not export a fetch() function.\");\n\t\t}\n\t\treturn worker.fetch(request, env, ctx);\n\t};\n\n\treturn {\n\t\t...worker,\n\t\tfetch(request, env, ctx) {\n\t\t\tconst dispatcher: Dispatcher = function (type, init) {\n\t\t\t\tif (type === \"scheduled\" && worker.scheduled !== undefined) {\n\t\t\t\t\tconst controller = new __Facade_ScheduledController__(\n\t\t\t\t\t\tDate.now(),\n\t\t\t\t\t\tinit.cron ?? \"\",\n\t\t\t\t\t\t() => {}\n\t\t\t\t\t);\n\t\t\t\t\treturn worker.scheduled(controller, env, ctx);\n\t\t\t\t}\n\t\t\t};\n\t\t\treturn __facade_invoke__(request, env, ctx, dispatcher, fetchDispatcher);\n\t\t},\n\t};\n}\n\nfunction wrapWorkerEntrypoint(\n\tklass: WorkerEntrypointConstructor\n): WorkerEntrypointConstructor {\n\t// If we don't have any middleware defined, just return the handler as is\n\tif (\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__ === undefined ||\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__.length === 0\n\t) {\n\t\treturn klass;\n\t}\n\t// Otherwise, register all middleware once\n\tfor (const middleware of __INTERNAL_WRANGLER_MIDDLEWARE__) {\n\t\t__facade_register__(middleware);\n\t}\n\n\t// `extend`ing `klass` here so other RPC methods remain callable\n\treturn class extends klass {\n\t\t#fetchDispatcher: ExportedHandlerFetchHandler<Record<string, unknown>> = (\n\t\t\trequest,\n\t\t\tenv,\n\t\t\tctx\n\t\t) => {\n\t\t\tthis.env = env;\n\t\t\tthis.ctx = ctx;\n\t\t\tif (super.fetch === undefined) {\n\t\t\t\tthrow new Error(\"Entrypoint class does not define a fetch() function.\");\n\t\t\t}\n\t\t\treturn super.fetch(request);\n\t\t};\n\n\t\t#dispatcher: Dispatcher = (type, init) => {\n\t\t\tif (type === \"scheduled\" && super.scheduled !== undefined) {\n\t\t\t\tconst controller = new __Facade_ScheduledController__(\n\t\t\t\t\tDate.now(),\n\t\t\t\t\tinit.cron ?? \"\",\n\t\t\t\t\t() => {}\n\t\t\t\t);\n\t\t\t\treturn super.scheduled(controller);\n\t\t\t}\n\t\t};\n\n\t\tfetch(request: Request<unknown, IncomingRequestCfProperties>) {\n\t\t\treturn __facade_invoke__(\n\t\t\t\trequest,\n\t\t\t\tthis.env,\n\t\t\t\tthis.ctx,\n\t\t\t\tthis.#dispatcher,\n\t\t\t\tthis.#fetchDispatcher\n\t\t\t);\n\t\t}\n\t};\n}\n\nlet WRAPPED_ENTRY: ExportedHandler | WorkerEntrypointConstructor | undefined;\nif (typeof ENTRY === \"object\") {\n\tWRAPPED_ENTRY = wrapExportedHandler(ENTRY);\n} else if (typeof ENTRY === \"function\") {\n\tWRAPPED_ENTRY = wrapWorkerEntrypoint(ENTRY);\n}\nexport default WRAPPED_ENTRY;\n", "\t\t\t\timport worker, * as OTHER_EXPORTS from \"/Users/chenyusen/clawd/three-kingdoms-slg/src/index.ts\";\n\t\t\t\timport * as __MIDDLEWARE_0__ from \"/Users/chenyusen/clawd/three-kingdoms-slg/node_modules/wrangler/templates/middleware/middleware-ensure-req-body-drained.ts\";\nimport * as __MIDDLEWARE_1__ from \"/Users/chenyusen/clawd/three-kingdoms-slg/node_modules/wrangler/templates/middleware/middleware-miniflare3-json-error.ts\";\n\n\t\t\t\texport * from \"/Users/chenyusen/clawd/three-kingdoms-slg/src/index.ts\";\n\n\t\t\t\texport const __INTERNAL_WRANGLER_MIDDLEWARE__ = [\n\t\t\t\t\t\n\t\t\t\t\t__MIDDLEWARE_0__.default,__MIDDLEWARE_1__.default\n\t\t\t\t]\n\t\t\t\texport default worker;", "import { Env, ApiResponse } from \"./types\";\nimport { GameRoom } from \"./durable-objects/GameRoom\";\nimport { createAgent } from \"./middleware/auth\";\nimport { createGame, joinGame, getLeaderboard, getGameHistory, handleWebSocket } from \"./handlers/game\";\nimport { banGeneral, pickGeneral, deployGenerals, executeAction } from \"./handlers/action\";\nimport { getGameState, getGeneralsList, healthCheck } from \"./handlers/query\";\n\n// \u5BFC\u51FADurable Object\nexport { GameRoom };\n\n// CORS headers\nconst corsHeaders = {\n  \"Access-Control-Allow-Origin\": \"*\",\n  \"Access-Control-Allow-Methods\": \"GET, POST, PUT, DELETE, OPTIONS\",\n  \"Access-Control-Allow-Headers\": \"Content-Type, Authorization\",\n};\n\nfunction addCorsHeaders(response: Response): Response {\n  const newHeaders = new Headers(response.headers);\n  Object.entries(corsHeaders).forEach(([k, v]) => newHeaders.set(k, v));\n  return new Response(response.body, {\n    status: response.status,\n    statusText: response.statusText,\n    headers: newHeaders,\n  });\n}\n\n// \u8DEF\u7531\u5339\u914D\nfunction matchRoute(pathname: string, pattern: string): Record<string, string> | null {\n  const patternParts = pattern.split(\"/\");\n  const pathParts = pathname.split(\"/\");\n  if (patternParts.length !== pathParts.length) return null;\n\n  const params: Record<string, string> = {};\n  for (let i = 0; i < patternParts.length; i++) {\n    if (patternParts[i].startsWith(\":\")) {\n      params[patternParts[i].slice(1)] = pathParts[i];\n    } else if (patternParts[i] !== pathParts[i]) {\n      return null;\n    }\n  }\n  return params;\n}\n\n// \u4E3B\u5904\u7406\u51FD\u6570\nasync function handleRequest(request: Request, env: Env): Promise<Response> {\n  const url = new URL(request.url);\n  const pathname = url.pathname;\n  const method = request.method;\n\n  // OPTIONS \u9884\u68C0\n  if (method === \"OPTIONS\") {\n    return new Response(null, { headers: corsHeaders });\n  }\n\n  let response: Response;\n\n  try {\n    // \u5065\u5EB7\u68C0\u67E5\n    if (pathname === \"/health\") {\n      return addCorsHeaders(Response.json({ status: \"ok\", timestamp: new Date().toISOString() }));\n    }\n\n    // \u6CE8\u518C\n    if (method === \"POST\" && pathname === \"/api/register\") {\n      const { name } = (await request.json()) as { name: string };\n      const result = await createAgent(name, env);\n      response = Response.json({ success: true, data: result });\n    }\n    // \u6B66\u5C06\u5217\u8868\n    else if (method === \"GET\" && pathname === \"/api/generals\") {\n      response = await getGeneralsList(request, env);\n    }\n    // \u6392\u884C\u699C\n    else if (method === \"GET\" && pathname === \"/api/leaderboard\") {\n      response = await getLeaderboard(request, env);\n    }\n    // \u6E38\u620F\u5386\u53F2\n    else if (method === \"GET\" && pathname === \"/api/games/history\") {\n      response = await getGameHistory(request, env);\n    }\n    // \u521B\u5EFA\u6E38\u620F\n    else if (method === \"POST\" && pathname === \"/api/games\") {\n      response = await createGame(request, env);\n    }\n    // \u52A0\u5165\u6E38\u620F\n    else if (method === \"POST\" && matchRoute(pathname, \"/api/games/:gameId/join\")) {\n      const params = matchRoute(pathname, \"/api/games/:gameId/join\")!;\n      response = await joinGame(request, env, params.gameId);\n    }\n    // \u6E38\u620F\u72B6\u6001\n    else if (method === \"GET\" && matchRoute(pathname, \"/api/games/:gameId/state\")) {\n      const params = matchRoute(pathname, \"/api/games/:gameId/state\")!;\n      const player = url.searchParams.get(\"player\") as \"p1\" | \"p2\" || \"p1\";\n      response = await getGameState(request, env, params.gameId, player);\n    }\n    // WebSocket\n    else if (matchRoute(pathname, \"/api/games/:gameId/ws\") && request.headers.get(\"Upgrade\") === \"websocket\") {\n      const params = matchRoute(pathname, \"/api/games/:gameId/ws\")!;\n      return handleWebSocket(request, env, params.gameId);\n    }\n    // Ban\u6B66\u5C06\n    else if (method === \"POST\" && matchRoute(pathname, \"/api/games/:gameId/ban\")) {\n      const params = matchRoute(pathname, \"/api/games/:gameId/ban\")!;\n      const player = url.searchParams.get(\"player\") as \"p1\" | \"p2\" || \"p1\";\n      response = await banGeneral(request, env, params.gameId, player);\n    }\n    // Pick\u6B66\u5C06\n    else if (method === \"POST\" && matchRoute(pathname, \"/api/games/:gameId/pick\")) {\n      const params = matchRoute(pathname, \"/api/games/:gameId/pick\")!;\n      const player = url.searchParams.get(\"player\") as \"p1\" | \"p2\" || \"p1\";\n      response = await pickGeneral(request, env, params.gameId, player);\n    }\n    // \u90E8\u7F72\n    else if (method === \"POST\" && matchRoute(pathname, \"/api/games/:gameId/deploy\")) {\n      const params = matchRoute(pathname, \"/api/games/:gameId/deploy\")!;\n      const player = url.searchParams.get(\"player\") as \"p1\" | \"p2\" || \"p1\";\n      response = await deployGenerals(request, env, params.gameId, player);\n    }\n    // \u6E38\u620F\u64CD\u4F5C\n    else if (method === \"POST\" && matchRoute(pathname, \"/api/games/:gameId/action\")) {\n      const params = matchRoute(pathname, \"/api/games/:gameId/action\")!;\n      const player = url.searchParams.get(\"player\") as \"p1\" | \"p2\" || \"p1\";\n      response = await executeAction(request, env, params.gameId, player);\n    }\n    // 404\n    else {\n      response = Response.json(\n        { success: false, error: { code: 404, message: \"Not found\" } },\n        { status: 404 }\n      );\n    }\n  } catch (error) {\n    console.error(\"Request error:\", error);\n    response = Response.json(\n      { success: false, error: { code: 500, message: String(error) } },\n      { status: 500 }\n    );\n  }\n\n  return addCorsHeaders(response);\n}\n\nexport default {\n  fetch: handleRequest,\n};\n", "import {\n  Env,\n  GameState,\n  GameStatus,\n  PlayerSide,\n  BattleGeneral,\n  Position,\n  ActionRequest,\n  ActionType,\n  WSEvent,\n  DeploymentInfo,\n  PICK_ORDER,\n  ErrorCodes,\n} from \"../types\";\nimport { getGeneralById, GENERALS } from \"../data/generals\";\nimport { MAP_DATA, isInArea, getSpawnArea, isInCity, manhattanDistance } from \"../data/map\";\nimport { calculateCombat, applyCombatResult, processBurnDamage } from \"../services/combat\";\nimport { executeMove, canMoveTo, getMoveableArea, executeExtraMove } from \"../services/movement\";\nimport { getVisibleEnemies, filterGameStateForPlayer } from \"../services/vision\";\nimport { canRetreat, updateInactiveRounds, processRoundStartEffects } from \"../services/skill\";\n\nexport class GameRoom {\n  private state: DurableObjectState;\n  private env: Env;\n  private gameState: GameState | null = null;\n  private connections: Map<string, WebSocket> = new Map();\n\n  constructor(state: DurableObjectState, env: Env) {\n    this.state = state;\n    this.env = env;\n  }\n\n  async fetch(request: Request): Promise<Response> {\n    const url = new URL(request.url);\n\n    try {\n      switch (url.pathname) {\n        case \"/ws\":\n          return this.handleWebSocket(request);\n        case \"/create\":\n          return this.handleCreate(request);\n        case \"/join\":\n          return this.handleJoin(request);\n        case \"/ban\":\n          return this.handleBan(request);\n        case \"/pick\":\n          return this.handlePick(request);\n        case \"/deploy\":\n          return this.handleDeploy(request);\n        case \"/action\":\n          return this.handleAction(request);\n        case \"/state\":\n          return this.handleGetState(request);\n        case \"/checkCooldown\":\n          return this.handleCheckCooldown(request);\n        default:\n          return new Response(\"Not found\", { status: 404 });\n      }\n    } catch (error) {\n      console.error(\"GameRoom error:\", error);\n      return Response.json({ success: false, error: { code: -1, message: String(error) } }, { status: 500 });\n    }\n  }\n\n  // WebSocket \u5904\u7406\n  async handleWebSocket(request: Request): Promise<Response> {\n    const upgradeHeader = request.headers.get(\"Upgrade\");\n    if (upgradeHeader !== \"websocket\") {\n      return new Response(\"Expected WebSocket\", { status: 426 });\n    }\n\n    const pair = new WebSocketPair();\n    const [client, server] = [pair[0], pair[1]];\n    const playerId = new URL(request.url).searchParams.get(\"player\") as PlayerSide;\n\n    server.accept();\n    this.connections.set(playerId, server);\n\n    server.addEventListener(\"close\", () => {\n      this.connections.delete(playerId);\n    });\n\n    server.addEventListener(\"message\", async (event) => {\n      try {\n        const data = JSON.parse(event.data as string);\n        // \u5904\u7406\u5BA2\u6237\u7AEF\u6D88\u606F\uFF08\u5982\u5FC3\u8DF3\uFF09\n        if (data.type === \"ping\") {\n          server.send(JSON.stringify({ type: \"pong\" }));\n        }\n      } catch (e) {\n        // \u5FFD\u7565\u65E0\u6548\u6D88\u606F\n      }\n    });\n\n    // \u53D1\u9001\u5F53\u524D\u72B6\u6001\n    const gameState = await this.loadState();\n    if (gameState) {\n      const filteredState = filterGameStateForPlayer(gameState, playerId);\n      server.send(JSON.stringify({ type: \"state\", data: filteredState }));\n    }\n\n    return new Response(null, { status: 101, webSocket: client });\n  }\n\n  // \u521B\u5EFA\u6E38\u620F\n  async handleCreate(request: Request): Promise<Response> {\n    const { gameId, p1 } = await request.json() as { gameId: string; p1: string };\n\n    const gameState: GameState = {\n      game_id: gameId,\n      status: \"waiting\",\n      turn: 0,\n      current_player: \"p1\",\n      banned_generals: [],\n      p1_picks: [],\n      p2_picks: [],\n      pick_phase: 0,\n      p1_generals: [],\n      p2_generals: [],\n      city_holder: null,\n      city_hold_turns: 0,\n      map: MAP_DATA,\n      winner: null,\n      win_reason: null,\n      p1_agent_id: p1,\n      p2_agent_id: null,\n      attacked_enemies: {},\n      first_damage_taken: {},\n    };\n\n    this.gameState = gameState;\n    await this.saveState();\n\n    return Response.json({ success: true, game_id: gameId, player: \"p1\", status: \"waiting\" });\n  }\n\n  // \u52A0\u5165\u6E38\u620F\n  async handleJoin(request: Request): Promise<Response> {\n    const { agent_id } = await request.json() as { agent_id: string };\n\n    let gameState = await this.loadState();\n    if (!gameState) {\n      return Response.json({ success: false, error: ErrorCodes.GAME_NOT_FOUND });\n    }\n\n    if (gameState.status !== \"waiting\") {\n      return Response.json({ success: false, error: ErrorCodes.GAME_FULL });\n    }\n\n    gameState.p2_agent_id = agent_id;\n    gameState.status = \"selecting\";\n    gameState.pick_phase = 1;\n\n    this.gameState = gameState;\n    await this.saveState();\n\n    // \u5E7F\u64AD\u72B6\u6001\u66F4\u65B0\n    this.broadcast({ type: \"game_started\", data: { status: \"selecting\" } });\n\n    return Response.json({ success: true, game_id: gameState.game_id, player: \"p2\", status: \"selecting\" });\n  }\n\n  // Ban\u6B66\u5C06\n  async handleBan(request: Request): Promise<Response> {\n    const { player, general_id } = await request.json() as { player: PlayerSide; general_id: number };\n\n    let gameState = await this.loadState();\n    if (!gameState || gameState.status !== \"selecting\") {\n      return Response.json({ success: false, error: ErrorCodes.INVALID_ACTION });\n    }\n\n    // \u68C0\u67E5\u662F\u5426\u8F6E\u5230\u8BE5\u73A9\u5BB6\n    const currentPhase = PICK_ORDER[gameState.pick_phase - 1];\n    if (!currentPhase || currentPhase.action !== \"ban\" || currentPhase.player !== player) {\n      return Response.json({ success: false, error: ErrorCodes.NOT_YOUR_TURN });\n    }\n\n    // \u68C0\u67E5\u6B66\u5C06\u662F\u5426\u6709\u6548\n    if (!GENERALS.find(g => g.id === general_id)) {\n      return Response.json({ success: false, error: ErrorCodes.INVALID_GENERAL });\n    }\n\n    // \u68C0\u67E5\u6B66\u5C06\u662F\u5426\u5DF2\u88ABban\u6216pick\n    if (gameState.banned_generals.includes(general_id) ||\n        gameState.p1_picks.includes(general_id) ||\n        gameState.p2_picks.includes(general_id)) {\n      return Response.json({ success: false, error: ErrorCodes.GENERAL_BANNED });\n    }\n\n    gameState.banned_generals.push(general_id);\n    gameState.pick_phase++;\n\n    this.gameState = gameState;\n    await this.saveState();\n\n    this.broadcast({\n      type: \"ban\",\n      data: { player, general_id, banned: gameState.banned_generals, next_phase: gameState.pick_phase }\n    });\n\n    return Response.json({ success: true, banned: gameState.banned_generals, next_phase: gameState.pick_phase });\n  }\n\n  // Pick\u6B66\u5C06\n  async handlePick(request: Request): Promise<Response> {\n    const { player, general_id } = await request.json() as { player: PlayerSide; general_id: number };\n\n    let gameState = await this.loadState();\n    if (!gameState || gameState.status !== \"selecting\") {\n      return Response.json({ success: false, error: ErrorCodes.INVALID_ACTION });\n    }\n\n    // \u68C0\u67E5\u662F\u5426\u8F6E\u5230\u8BE5\u73A9\u5BB6\n    const currentPhase = PICK_ORDER[gameState.pick_phase - 1];\n    if (!currentPhase || currentPhase.action !== \"pick\" || currentPhase.player !== player) {\n      return Response.json({ success: false, error: ErrorCodes.NOT_YOUR_TURN });\n    }\n\n    // \u68C0\u67E5\u6B66\u5C06\u662F\u5426\u6709\u6548\n    if (!GENERALS.find(g => g.id === general_id)) {\n      return Response.json({ success: false, error: ErrorCodes.INVALID_GENERAL });\n    }\n\n    // \u68C0\u67E5\u6B66\u5C06\u662F\u5426\u5DF2\u88ABban\u6216pick\n    if (gameState.banned_generals.includes(general_id) ||\n        gameState.p1_picks.includes(general_id) ||\n        gameState.p2_picks.includes(general_id)) {\n      return Response.json({ success: false, error: ErrorCodes.GENERAL_PICKED });\n    }\n\n    // \u6DFB\u52A0\u5230\u73A9\u5BB6\u7684picks\n    if (player === \"p1\") {\n      gameState.p1_picks.push(general_id);\n    } else {\n      gameState.p2_picks.push(general_id);\n    }\n\n    gameState.pick_phase++;\n\n    // \u68C0\u67E5\u9009\u5C06\u662F\u5426\u5B8C\u6210\n    if (gameState.pick_phase > PICK_ORDER.length) {\n      gameState.status = \"deploying\";\n    }\n\n    this.gameState = gameState;\n    await this.saveState();\n\n    this.broadcast({\n      type: \"pick\",\n      data: {\n        player,\n        general_id,\n        p1_picks: gameState.p1_picks,\n        p2_picks: gameState.p2_picks,\n        next_phase: gameState.pick_phase,\n        status: gameState.status\n      }\n    });\n\n    return Response.json({\n      success: true,\n      picked: player === \"p1\" ? gameState.p1_picks : gameState.p2_picks,\n      next_phase: gameState.pick_phase,\n      status: gameState.status\n    });\n  }\n\n  // \u90E8\u7F72\u6B66\u5C06\n  async handleDeploy(request: Request): Promise<Response> {\n    const { player, deployments } = await request.json() as { player: PlayerSide; deployments: DeploymentInfo[] };\n\n    let gameState = await this.loadState();\n    if (!gameState || gameState.status !== \"deploying\") {\n      return Response.json({ success: false, error: ErrorCodes.INVALID_ACTION });\n    }\n\n    const picks = player === \"p1\" ? gameState.p1_picks : gameState.p2_picks;\n    const spawnArea = getSpawnArea(player);\n\n    // \u9A8C\u8BC1\u90E8\u7F72\n    if (deployments.length !== picks.length) {\n      return Response.json({ success: false, error: { code: 1013, message: \"\u6B66\u5C06\u6570\u91CF\u4E0D\u5339\u914D\" } });\n    }\n\n    const deployedIds = new Set<number>();\n    const deployedPositions = new Set<string>();\n\n    for (const dep of deployments) {\n      // \u68C0\u67E5\u6B66\u5C06ID\u662F\u5426\u5728picks\u4E2D\n      if (!picks.includes(dep.general_id)) {\n        return Response.json({ success: false, error: ErrorCodes.INVALID_GENERAL });\n      }\n\n      // \u68C0\u67E5\u662F\u5426\u91CD\u590D\u90E8\u7F72\n      if (deployedIds.has(dep.general_id)) {\n        return Response.json({ success: false, error: { code: 1013, message: \"\u6B66\u5C06\u91CD\u590D\u90E8\u7F72\" } });\n      }\n\n      // \u68C0\u67E5\u4F4D\u7F6E\u662F\u5426\u5728\u51FA\u751F\u533A\n      if (!isInArea(dep.x, dep.y, spawnArea)) {\n        return Response.json({ success: false, error: ErrorCodes.INVALID_DEPLOY_POSITION });\n      }\n\n      // \u68C0\u67E5\u4F4D\u7F6E\u662F\u5426\u91CD\u590D\n      const posKey = `${dep.x},${dep.y}`;\n      if (deployedPositions.has(posKey)) {\n        return Response.json({ success: false, error: { code: 1013, message: \"\u4F4D\u7F6E\u91CD\u590D\" } });\n      }\n\n      deployedIds.add(dep.general_id);\n      deployedPositions.add(posKey);\n    }\n\n    // \u521B\u5EFABattleGeneral\u5B9E\u4F8B\n    const generals: BattleGeneral[] = deployments.map((dep, index) => {\n      const data = getGeneralById(dep.general_id)!;\n      return {\n        instance_id: `${player}_${index + 1}`,\n        general_id: dep.general_id,\n        owner: player,\n        current_hp: data.base_hp,\n        position: { x: dep.x, y: dep.y },\n        facing: player === \"p1\" ? \"right\" : \"left\",\n        atk_modifier: 0,\n        def_modifier: 0,\n        mov_modifier: 0,\n        has_acted: false,\n        is_alive: true,\n        buffs: [],\n        skill_state: {},\n        moved_distance: 0,\n      };\n    });\n\n    if (player === \"p1\") {\n      gameState.p1_generals = generals;\n    } else {\n      gameState.p2_generals = generals;\n    }\n\n    // \u68C0\u67E5\u53CC\u65B9\u662F\u5426\u90FD\u5DF2\u90E8\u7F72\n    if (gameState.p1_generals.length > 0 && gameState.p2_generals.length > 0) {\n      gameState.status = \"playing\";\n      gameState.turn = 1;\n      gameState.current_player = \"p1\";\n    }\n\n    this.gameState = gameState;\n    await this.saveState();\n\n    this.broadcast({\n      type: \"deploy\",\n      data: { player, status: gameState.status, turn: gameState.turn }\n    });\n\n    return Response.json({ success: true, status: gameState.status });\n  }\n\n  // \u5904\u7406\u6E38\u620F\u64CD\u4F5C\n  async handleAction(request: Request): Promise<Response> {\n    const action = await request.json() as ActionRequest;\n\n    let gameState = await this.loadState();\n    if (!gameState || gameState.status !== \"playing\") {\n      return Response.json({ success: false, error: ErrorCodes.INVALID_ACTION });\n    }\n\n    // \u68C0\u67E5\u662F\u5426\u662F\u5F53\u524D\u73A9\u5BB6\n    if (action.player !== gameState.current_player) {\n      return Response.json({ success: false, error: ErrorCodes.NOT_YOUR_TURN });\n    }\n\n    let result: any;\n\n    switch (action.action) {\n      case \"MOVE\":\n        result = await this.handleMoveAction(action, gameState);\n        break;\n      case \"ATTACK\":\n        result = await this.handleAttackAction(action, gameState);\n        break;\n      case \"SKILL\":\n        result = await this.handleSkillAction(action, gameState);\n        break;\n      case \"WAIT\":\n        result = await this.handleWaitAction(action, gameState);\n        break;\n      case \"RETREAT\":\n        result = await this.handleRetreatAction(action, gameState);\n        break;\n      case \"END_TURN\":\n        result = await this.handleEndTurnAction(action, gameState);\n        break;\n      default:\n        return Response.json({ success: false, error: ErrorCodes.INVALID_ACTION });\n    }\n\n    if (!result.success) {\n      return Response.json(result);\n    }\n\n    // \u68C0\u67E5\u80DC\u8D1F\n    this.checkVictory(gameState);\n\n    this.gameState = gameState;\n    await this.saveState();\n\n    // \u5E7F\u64AD\u7ED3\u679C\n    this.broadcast({\n      type: \"action_result\",\n      data: {\n        action: action.action,\n        result: result.data,\n        turn: gameState.turn,\n        current_player: gameState.current_player,\n        winner: gameState.winner,\n      }\n    });\n\n    return Response.json(result);\n  }\n\n  // \u79FB\u52A8\u64CD\u4F5C\n  private async handleMoveAction(action: ActionRequest, gameState: GameState): Promise<any> {\n    const general = this.findGeneral(action.instance_id!, gameState);\n    if (!general) {\n      return { success: false, error: ErrorCodes.INVALID_GENERAL };\n    }\n\n    if (general.owner !== action.player) {\n      return { success: false, error: ErrorCodes.NOT_YOUR_TURN };\n    }\n\n    const target: Position = { x: action.target_x!, y: action.target_y! };\n    const result = executeMove(general, target, gameState);\n\n    if (!result.success) {\n      return { success: false, error: { code: 1005, message: result.error } };\n    }\n\n    return { success: true, data: { from: result.path![0], to: target, path: result.path } };\n  }\n\n  // \u653B\u51FB\u64CD\u4F5C\n  private async handleAttackAction(action: ActionRequest, gameState: GameState): Promise<any> {\n    const attacker = this.findGeneral(action.instance_id!, gameState);\n    const defender = this.findGeneral(action.target_instance_id!, gameState);\n\n    if (!attacker || !defender) {\n      return { success: false, error: ErrorCodes.INVALID_GENERAL };\n    }\n\n    if (attacker.owner !== action.player) {\n      return { success: false, error: ErrorCodes.NOT_YOUR_TURN };\n    }\n\n    if (attacker.has_acted) {\n      return { success: false, error: ErrorCodes.ALREADY_ACTED };\n    }\n\n    if (!attacker.is_alive) {\n      return { success: false, error: ErrorCodes.GENERAL_DEAD };\n    }\n\n    // \u8BA1\u7B97\u6218\u6597\u7ED3\u679C\n    const combatResult = calculateCombat(attacker, defender, gameState);\n\n    // \u5E94\u7528\u6218\u6597\u7ED3\u679C\n    applyCombatResult(attacker, defender, combatResult, gameState);\n\n    return {\n      success: true,\n      data: {\n        damage_dealt: combatResult.damage,\n        counter_damage: combatResult.counter_damage,\n        target_remaining_hp: defender.current_hp,\n        attacker_remaining_hp: attacker.current_hp,\n        target_killed: combatResult.target_killed,\n        attacker_killed: combatResult.attacker_killed,\n        triggered_skills: combatResult.triggered_skills,\n      }\n    };\n  }\n\n  // \u6280\u80FD\u64CD\u4F5C\uFF08\u8BF8\u845B\u4EAE\u795E\u7B97\u3001\u90ED\u5609\u9B3C\u624D\u7B49\u4E3B\u52A8\u6280\u80FD\uFF09\n  private async handleSkillAction(action: ActionRequest, gameState: GameState): Promise<any> {\n    const general = this.findGeneral(action.instance_id!, gameState);\n    if (!general) {\n      return { success: false, error: ErrorCodes.INVALID_GENERAL };\n    }\n\n    const data = getGeneralById(general.general_id);\n    if (!data || data.skill_type !== \"active\") {\n      return { success: false, error: { code: 1008, message: \"\u8BE5\u6B66\u5C06\u6CA1\u6709\u4E3B\u52A8\u6280\u80FD\" } };\n    }\n\n    // \u8BF8\u845B\u4EAE\u795E\u7B97\uFF1A\u6307\u6325\u53CB\u519B\u884C\u52A8\n    if (data.skill_name === \"\u795E\u7B97\" && action.skill_target) {\n      const target = this.findGeneral(action.skill_target, gameState);\n      if (!target || target.owner !== general.owner) {\n        return { success: false, error: { code: 1008, message: \"\u65E0\u6548\u7684\u6280\u80FD\u76EE\u6807\" } };\n      }\n\n      if (manhattanDistance(general.position, target.position) > 2) {\n        return { success: false, error: { code: 1008, message: \"\u76EE\u6807\u4E0D\u5728\u6280\u80FD\u8303\u56F4\u5185\" } };\n      }\n\n      // \u6807\u8BB0\u8BF8\u845B\u4EAE\u5DF2\u884C\u52A8\uFF0C\u5141\u8BB8\u76EE\u6807\u884C\u52A8\n      general.has_acted = true;\n      target.has_acted = false;\n\n      return { success: true, data: { skill: \"\u795E\u7B97\", target: action.skill_target } };\n    }\n\n    // \u90ED\u5609\u9B3C\u624D\uFF1A\u67E5\u770B\u654C\u4EBA\u610F\u56FE\uFF08\u4E3B\u8981\u662F\u4FE1\u606F\u83B7\u53D6\uFF09\n    if (data.skill_name === \"\u9B3C\u624D\") {\n      const enemies = general.owner === \"p1\" ? gameState.p2_generals : gameState.p1_generals;\n      const nearbyEnemies = enemies.filter(e =>\n        e.is_alive && manhattanDistance(general.position, e.position) <= 5\n      );\n\n      general.has_acted = true;\n\n      return {\n        success: true,\n        data: {\n          skill: \"\u9B3C\u624D\",\n          visible_enemies: nearbyEnemies.map(e => ({\n            instance_id: e.instance_id,\n            general_id: e.general_id,\n            position: e.position,\n            current_hp: e.current_hp,\n            buffs: e.buffs,\n          }))\n        }\n      };\n    }\n\n    return { success: false, error: { code: 1008, message: \"\u6280\u80FD\u6267\u884C\u5931\u8D25\" } };\n  }\n\n  // \u5F85\u547D\u64CD\u4F5C\n  private async handleWaitAction(action: ActionRequest, gameState: GameState): Promise<any> {\n    const general = this.findGeneral(action.instance_id!, gameState);\n    if (!general) {\n      return { success: false, error: ErrorCodes.INVALID_GENERAL };\n    }\n\n    general.has_acted = true;\n\n    return { success: true, data: { action: \"WAIT\" } };\n  }\n\n  // \u64A4\u9000\u64CD\u4F5C\n  private async handleRetreatAction(action: ActionRequest, gameState: GameState): Promise<any> {\n    const general = this.findGeneral(action.instance_id!, gameState);\n    if (!general) {\n      return { success: false, error: ErrorCodes.INVALID_GENERAL };\n    }\n\n    // \u68C0\u67E5\u5178\u97E6\u6076\u6765\u9650\u5236\n    if (!canRetreat(general, gameState)) {\n      return { success: false, error: ErrorCodes.CANNOT_RETREAT };\n    }\n\n    // \u64A4\u9000\u5230\u51FA\u751F\u70B9\n    const spawnArea = getSpawnArea(general.owner);\n    general.position = {\n      x: Math.floor((spawnArea.x1 + spawnArea.x2) / 2),\n      y: Math.floor((spawnArea.y1 + spawnArea.y2) / 2)\n    };\n    general.has_acted = true;\n\n    return { success: true, data: { action: \"RETREAT\", new_position: general.position } };\n  }\n\n  // \u7ED3\u675F\u56DE\u5408\n  private async handleEndTurnAction(action: ActionRequest, gameState: GameState): Promise<any> {\n    // \u5904\u7406\u56DE\u5408\u7ED3\u675F\u6548\u679C\n    const currentGenerals = action.player === \"p1\" ? gameState.p1_generals : gameState.p2_generals;\n\n    for (const general of currentGenerals) {\n      if (!general.is_alive) continue;\n\n      // \u66F4\u65B0\u53F8\u9A6C\u61FF\u9690\u5FCD\u72B6\u6001\n      updateInactiveRounds(general, general.has_acted);\n\n      // \u91CD\u7F6E\u884C\u52A8\u72B6\u6001\n      general.has_acted = false;\n      general.moved_distance = 0;\n    }\n\n    // \u5207\u6362\u73A9\u5BB6\n    gameState.current_player = gameState.current_player === \"p1\" ? \"p2\" : \"p1\";\n\n    // \u5982\u679C\u56DE\u5230P1\uFF0C\u589E\u52A0\u56DE\u5408\u6570\n    if (gameState.current_player === \"p1\") {\n      gameState.turn++;\n\n      // \u5904\u7406\u56DE\u5408\u5F00\u59CB\u6548\u679C\uFF08\u707C\u70E7\u7B49\uFF09\n      const burnResults = processBurnDamage(gameState);\n\n      // \u66F4\u65B0\u57CE\u6C60\u63A7\u5236\n      this.updateCityControl(gameState);\n    }\n\n    return { success: true, data: { turn: gameState.turn, current_player: gameState.current_player } };\n  }\n\n  // \u66F4\u65B0\u57CE\u6C60\u63A7\u5236\n  private updateCityControl(gameState: GameState): void {\n    const p1InCity = gameState.p1_generals.filter(g => g.is_alive && isInCity(g.position.x, g.position.y));\n    const p2InCity = gameState.p2_generals.filter(g => g.is_alive && isInCity(g.position.x, g.position.y));\n\n    if (p1InCity.length > 0 && p2InCity.length === 0) {\n      if (gameState.city_holder === \"p1\") {\n        gameState.city_hold_turns++;\n      } else {\n        gameState.city_holder = \"p1\";\n        gameState.city_hold_turns = 1;\n      }\n    } else if (p2InCity.length > 0 && p1InCity.length === 0) {\n      if (gameState.city_holder === \"p2\") {\n        gameState.city_hold_turns++;\n      } else {\n        gameState.city_holder = \"p2\";\n        gameState.city_hold_turns = 1;\n      }\n    } else {\n      // \u6709\u4E89\u593A\u6216\u65E0\u4EBA\n      gameState.city_hold_turns = 0;\n    }\n  }\n\n  // \u68C0\u67E5\u80DC\u8D1F\n  private checkVictory(gameState: GameState): void {\n    // \u68C0\u67E5\u57CE\u6C60\u5360\u9886\u80DC\u5229\n    if (gameState.city_hold_turns >= 10) {\n      gameState.winner = gameState.city_holder;\n      gameState.win_reason = \"\u5360\u9886\u57CE\u6C6010\u56DE\u5408\";\n      gameState.status = \"finished\";\n      return;\n    }\n\n    // \u68C0\u67E5\u5168\u706D\u80DC\u5229\n    const p1Alive = gameState.p1_generals.some(g => g.is_alive);\n    const p2Alive = gameState.p2_generals.some(g => g.is_alive);\n\n    if (!p1Alive && !p2Alive) {\n      gameState.winner = null;\n      gameState.win_reason = \"\u53CC\u65B9\u5168\u706D\uFF0C\u5E73\u5C40\";\n      gameState.status = \"finished\";\n    } else if (!p1Alive) {\n      gameState.winner = \"p2\";\n      gameState.win_reason = \"\u6D88\u706D\u6240\u6709\u654C\u519B\";\n      gameState.status = \"finished\";\n    } else if (!p2Alive) {\n      gameState.winner = \"p1\";\n      gameState.win_reason = \"\u6D88\u706D\u6240\u6709\u654C\u519B\";\n      gameState.status = \"finished\";\n    }\n\n    // \u68C0\u67E5\u56DE\u5408\u4E0A\u9650\n    if (gameState.turn >= 200 && gameState.status === \"playing\") {\n      // \u6839\u636E\u5269\u4F59\u8840\u91CF\u5224\u65AD\n      const p1TotalHp = gameState.p1_generals.reduce((sum, g) => sum + (g.is_alive ? g.current_hp : 0), 0);\n      const p2TotalHp = gameState.p2_generals.reduce((sum, g) => sum + (g.is_alive ? g.current_hp : 0), 0);\n\n      if (p1TotalHp > p2TotalHp) {\n        gameState.winner = \"p1\";\n        gameState.win_reason = \"\u56DE\u5408\u4E0A\u9650\uFF0C\u8840\u91CF\u4F18\u52BF\";\n      } else if (p2TotalHp > p1TotalHp) {\n        gameState.winner = \"p2\";\n        gameState.win_reason = \"\u56DE\u5408\u4E0A\u9650\uFF0C\u8840\u91CF\u4F18\u52BF\";\n      } else {\n        gameState.winner = null;\n        gameState.win_reason = \"\u56DE\u5408\u4E0A\u9650\uFF0C\u5E73\u5C40\";\n      }\n      gameState.status = \"finished\";\n    }\n  }\n\n  // \u83B7\u53D6\u6E38\u620F\u72B6\u6001\n  async handleGetState(request: Request): Promise<Response> {\n    const player = new URL(request.url).searchParams.get(\"player\") as PlayerSide;\n\n    const gameState = await this.loadState();\n    if (!gameState) {\n      return Response.json({ success: false, error: ErrorCodes.GAME_NOT_FOUND });\n    }\n\n    const filteredState = filterGameStateForPlayer(gameState, player);\n    return Response.json({ success: true, data: filteredState });\n  }\n\n  // \u68C0\u67E5\u51B7\u5374\u65F6\u95F4\n  async handleCheckCooldown(request: Request): Promise<Response> {\n    const { playerId } = await request.json() as { playerId: string };\n\n    const key = `cooldown:${playerId}`;\n    const cooldownUntil = await this.state.storage.get<number>(key);\n\n    const now = Date.now();\n\n    if (cooldownUntil && now < cooldownUntil) {\n      return Response.json({\n        allowed: false,\n        retryAfter: Math.ceil((cooldownUntil - now) / 1000)\n      });\n    }\n\n    // \u8BBE\u7F6E\u65B0\u7684\u51B7\u5374\u65F6\u95F4\uFF085\u79D2\uFF09\n    await this.state.storage.put(key, now + 5000);\n    return Response.json({ allowed: true });\n  }\n\n  // \u67E5\u627E\u6B66\u5C06\n  private findGeneral(instanceId: string, gameState: GameState): BattleGeneral | undefined {\n    return [...gameState.p1_generals, ...gameState.p2_generals].find(g => g.instance_id === instanceId);\n  }\n\n  // \u5E7F\u64AD\u6D88\u606F\n  private broadcast(event: WSEvent): void {\n    const message = JSON.stringify(event);\n\n    for (const [playerId, ws] of this.connections) {\n      try {\n        // \u6839\u636E\u73A9\u5BB6\u8FC7\u6EE4\u654F\u611F\u4FE1\u606F\n        if (this.gameState) {\n          const playerEvent = {\n            ...event,\n            data: {\n              ...event.data,\n              state: filterGameStateForPlayer(this.gameState, playerId as PlayerSide)\n            }\n          };\n          ws.send(JSON.stringify(playerEvent));\n        } else {\n          ws.send(message);\n        }\n      } catch (e) {\n        this.connections.delete(playerId);\n      }\n    }\n  }\n\n  // \u4FDD\u5B58\u72B6\u6001\n  private async saveState(): Promise<void> {\n    if (this.gameState) {\n      await this.state.storage.put(\"gameState\", this.gameState);\n    }\n  }\n\n  // \u52A0\u8F7D\u72B6\u6001\n  private async loadState(): Promise<GameState | null> {\n    if (this.gameState) {\n      return this.gameState;\n    }\n    this.gameState = await this.state.storage.get(\"gameState\") || null;\n    return this.gameState;\n  }\n}\n", "import { MapData, TerrainType, Position, Area } from \"../types\";\n\n// \u5730\u5F62\u5B9A\u4E49\nexport const TERRAIN_CONFIG: Record<TerrainType, { mov_cost: number; def_bonus: number }> = {\n  plain: { mov_cost: 1, def_bonus: 0 },\n  forest: { mov_cost: 2, def_bonus: 1 },\n  mountain: { mov_cost: 3, def_bonus: 2 },\n  river: { mov_cost: 999, def_bonus: 0 }, // \u4E0D\u53EF\u901A\u884C\n  bridge: { mov_cost: 1, def_bonus: 0 },\n  road: { mov_cost: 0.5, def_bonus: 0 },\n  city: { mov_cost: 1, def_bonus: 2 },\n};\n\n// \u5173\u952E\u533A\u57DF\u5B9A\u4E49\nexport const P1_SPAWN: Area = { x1: 0, y1: 0, x2: 19, y2: 19 };\nexport const P2_SPAWN: Area = { x1: 80, y1: 80, x2: 99, y2: 99 };\nexport const CITY_AREA: Area = { x1: 48, y1: 48, x2: 52, y2: 52 };\nexport const CITY_GATES: Position[] = [\n  { x: 48, y: 50 }, // \u897F\u95E8\n  { x: 52, y: 50 }, // \u4E1C\u95E8\n  { x: 50, y: 48 }, // \u5317\u95E8\n  { x: 50, y: 52 }, // \u5357\u95E8\n];\n\n// \u6CB3\u6D41\u4F4D\u7F6E\nexport const NORTH_RIVER_Y = 25;\nexport const SOUTH_RIVER_Y = 75;\n\n// \u6865\u6881\u4F4D\u7F6E\nexport const BRIDGES: Position[] = [\n  { x: 33, y: 25 }, // \u5317\u68651\n  { x: 66, y: 25 }, // \u5317\u68652\n  { x: 33, y: 75 }, // \u5357\u68651\n  { x: 66, y: 75 }, // \u5357\u68652\n];\n\n// \u751F\u6210100x100\u5730\u56FE\nfunction generateTerrains(): TerrainType[][] {\n  const terrains: TerrainType[][] = [];\n  \n  for (let y = 0; y < 100; y++) {\n    const row: TerrainType[] = [];\n    for (let x = 0; x < 100; x++) {\n      row.push(getTerrainAt(x, y));\n    }\n    terrains.push(row);\n  }\n  \n  return terrains;\n}\n\n// \u6839\u636E\u5750\u6807\u83B7\u53D6\u5730\u5F62\u7C7B\u578B\nfunction getTerrainAt(x: number, y: number): TerrainType {\n  // \u4E2D\u592E\u57CE\u6C60 (48-52, 48-52)\n  if (isInArea(x, y, CITY_AREA)) {\n    return \"city\";\n  }\n  \n  // \u6CB3\u6D41 - y=25 \u548C y=75\n  if (y === NORTH_RIVER_Y || y === SOUTH_RIVER_Y) {\n    // \u68C0\u67E5\u662F\u5426\u662F\u6865\u6881\u4F4D\u7F6E\n    if (BRIDGES.some(b => b.x === x && b.y === y)) {\n      return \"bridge\";\n    }\n    return \"river\";\n  }\n  \n  // \u4E3B\u8981\u9053\u8DEF - \u4ECE\u51FA\u751F\u533A\u5230\u57CE\u6C60\n  // P1\u9053\u8DEF: \u4ECE(10,10)\u659C\u5411\u5230\u57CE\u6C60\n  // P2\u9053\u8DEF: \u4ECE(90,90)\u659C\u5411\u5230\u57CE\u6C60\n  if (isOnMainRoad(x, y)) {\n    return \"road\";\n  }\n  \n  // \u57CE\u6C60\u5468\u56F4\u7684\u9053\u8DEF\u73AF\n  if (isCityRingRoad(x, y)) {\n    return \"road\";\n  }\n  \n  // \u968F\u673A\u5206\u5E03\u7684\u6811\u6797\uFF08\u4F7F\u7528\u786E\u5B9A\u6027\u7B97\u6CD5\u4FDD\u8BC1\u4E00\u81F4\u6027\uFF09\n  if (isForest(x, y)) {\n    return \"forest\";\n  }\n  \n  // \u968F\u673A\u5206\u5E03\u7684\u5C71\u5730\n  if (isMountain(x, y)) {\n    return \"mountain\";\n  }\n  \n  // \u9ED8\u8BA4\u5E73\u539F\n  return \"plain\";\n}\n\n// \u68C0\u67E5\u662F\u5426\u5728\u67D0\u533A\u57DF\u5185\nexport function isInArea(x: number, y: number, area: Area): boolean {\n  return x >= area.x1 && x <= area.x2 && y >= area.y1 && y <= area.y2;\n}\n\n// \u68C0\u67E5\u662F\u5426\u5728\u4E3B\u8981\u9053\u8DEF\u4E0A\nfunction isOnMainRoad(x: number, y: number): boolean {\n  // \u6A2A\u5411\u4E3B\u9053\u8DEF - y=50 \u4ECEx=0\u5230x=100\n  if (y === 50 && (x < 48 || x > 52)) {\n    return true;\n  }\n  \n  // \u7EB5\u5411\u4E3B\u9053\u8DEF - x=50 \u4ECEy=0\u5230y=100\n  if (x === 50 && (y < 48 || y > 52)) {\n    return true;\n  }\n  \n  // \u5BF9\u89D2\u7EBF\u9053\u8DEF\n  // P1\u65B9\u5411: \u4ECE\u5DE6\u4E0B\u5230\u57CE\u6C60\n  if (Math.abs(x - y) <= 1 && x < 48 && y < 48 && x >= 10 && y >= 10) {\n    return true;\n  }\n  \n  // P2\u65B9\u5411: \u4ECE\u53F3\u4E0A\u5230\u57CE\u6C60\n  if (Math.abs((99 - x) - (99 - y)) <= 1 && x > 52 && y > 52 && x <= 90 && y <= 90) {\n    return true;\n  }\n  \n  return false;\n}\n\n// \u57CE\u6C60\u5468\u56F4\u7684\u73AF\u5F62\u9053\u8DEF\nfunction isCityRingRoad(x: number, y: number): boolean {\n  // \u57CE\u6C60\u5916\u56F4\u4E00\u5708 (47,47) \u5230 (53,53) \u4F46\u4E0D\u5305\u62EC\u57CE\u6C60\u672C\u8EAB\n  if (x >= 47 && x <= 53 && y >= 47 && y <= 53) {\n    if (x === 47 || x === 53 || y === 47 || y === 53) {\n      return true;\n    }\n  }\n  return false;\n}\n\n// \u4F7F\u7528\u7B80\u5355\u54C8\u5E0C\u751F\u6210\u786E\u5B9A\u6027\u7684\u6811\u6797\u5206\u5E03\nfunction isForest(x: number, y: number): boolean {\n  // \u6392\u9664\u7279\u6B8A\u533A\u57DF\n  if (isInArea(x, y, P1_SPAWN) || isInArea(x, y, P2_SPAWN)) return false;\n  if (isInArea(x, y, { x1: 45, y1: 45, x2: 55, y2: 55 })) return false; // \u57CE\u6C60\u5468\u56F4\n  if (y === NORTH_RIVER_Y || y === SOUTH_RIVER_Y) return false;\n  if (isOnMainRoad(x, y) || isCityRingRoad(x, y)) return false;\n  \n  // \u4F2A\u968F\u673A\u786E\u5B9A\u6027\u5206\u5E03\uFF0C\u7EA615%\u8986\u76D6\u7387\n  const hash = simpleHash(x, y, 1);\n  return hash % 100 < 15;\n}\n\n// \u4F7F\u7528\u7B80\u5355\u54C8\u5E0C\u751F\u6210\u786E\u5B9A\u6027\u7684\u5C71\u5730\u5206\u5E03\nfunction isMountain(x: number, y: number): boolean {\n  // \u6392\u9664\u7279\u6B8A\u533A\u57DF\n  if (isInArea(x, y, P1_SPAWN) || isInArea(x, y, P2_SPAWN)) return false;\n  if (isInArea(x, y, { x1: 43, y1: 43, x2: 57, y2: 57 })) return false; // \u57CE\u6C60\u66F4\u5927\u8303\u56F4\n  if (y === NORTH_RIVER_Y || y === SOUTH_RIVER_Y) return false;\n  if (isOnMainRoad(x, y) || isCityRingRoad(x, y)) return false;\n  if (isForest(x, y)) return false;\n  \n  // \u5C71\u5730\u4E3B\u8981\u5206\u5E03\u5728\u5730\u56FE\u56DB\u89D2\u548C\u4E2D\u95F4\u533A\u57DF\u7684\u7279\u5B9A\u4F4D\u7F6E\n  // \u7EA68%\u8986\u76D6\u7387\n  const hash = simpleHash(x, y, 2);\n  \n  // \u56DB\u89D2\u533A\u57DF\u66F4\u591A\u5C71\u5730\n  const inCornerRegion = \n    (x < 30 && y > 30 && y < 70) || // \u5DE6\u4FA7\n    (x > 70 && y > 30 && y < 70) || // \u53F3\u4FA7\n    (y < 30 && x > 30 && x < 70) || // \u4E0A\u4FA7\n    (y > 70 && x > 30 && x < 70);   // \u4E0B\u4FA7\n  \n  if (inCornerRegion) {\n    return hash % 100 < 12;\n  }\n  \n  return hash % 100 < 5;\n}\n\n// \u7B80\u5355\u54C8\u5E0C\u51FD\u6570\u7528\u4E8E\u786E\u5B9A\u6027\u968F\u673A\nfunction simpleHash(x: number, y: number, seed: number): number {\n  let h = seed;\n  h = ((h << 5) + h) + x;\n  h = ((h << 5) + h) + y;\n  h = h ^ (h >> 16);\n  h = Math.abs(h);\n  return h;\n}\n\n// \u9884\u751F\u6210\u5730\u56FE\u6570\u636E\nconst MAP_TERRAINS = generateTerrains();\n\n// \u5BFC\u51FA\u5730\u56FE\u6570\u636E\nexport const MAP_DATA: MapData = {\n  width: 100,\n  height: 100,\n  terrains: MAP_TERRAINS,\n  p1_spawn: P1_SPAWN,\n  p2_spawn: P2_SPAWN,\n  city_area: CITY_AREA,\n  city_gates: CITY_GATES,\n};\n\n// \u83B7\u53D6\u6307\u5B9A\u4F4D\u7F6E\u7684\u5730\u5F62\nexport function getTerrain(x: number, y: number): { type: TerrainType; mov_cost: number; def_bonus: number } {\n  if (x < 0 || x >= 100 || y < 0 || y >= 100) {\n    return { type: \"river\", mov_cost: 999, def_bonus: 0 }; // \u5730\u56FE\u5916\u89C6\u4E3A\u4E0D\u53EF\u901A\u884C\n  }\n  const type = MAP_TERRAINS[y][x];\n  return {\n    type,\n    ...TERRAIN_CONFIG[type],\n  };\n}\n\n// \u68C0\u67E5\u4F4D\u7F6E\u662F\u5426\u53EF\u901A\u884C\nexport function isPassable(x: number, y: number): boolean {\n  const terrain = getTerrain(x, y);\n  return terrain.mov_cost < 999;\n}\n\n// \u68C0\u67E5\u662F\u5426\u662F\u57CE\u6C60\u533A\u57DF\nexport function isInCity(x: number, y: number): boolean {\n  return isInArea(x, y, CITY_AREA);\n}\n\n// \u68C0\u67E5\u662F\u5426\u662F\u57CE\u95E8\nexport function isCityGate(x: number, y: number): boolean {\n  return CITY_GATES.some(g => g.x === x && g.y === y);\n}\n\n// \u83B7\u53D6P1\u6216P2\u7684\u51FA\u751F\u533A\nexport function getSpawnArea(player: \"p1\" | \"p2\"): Area {\n  return player === \"p1\" ? P1_SPAWN : P2_SPAWN;\n}\n\n// \u8BA1\u7B97\u4E24\u70B9\u4E4B\u95F4\u7684\u66FC\u54C8\u987F\u8DDD\u79BB\nexport function manhattanDistance(p1: Position, p2: Position): number {\n  return Math.abs(p1.x - p2.x) + Math.abs(p1.y - p2.y);\n}\n\n// \u83B7\u53D6\u76F8\u90BB\u683C\u5B50\uFF08\u4E0A\u4E0B\u5DE6\u53F3\uFF09\nexport function getAdjacentPositions(pos: Position): Position[] {\n  return [\n    { x: pos.x - 1, y: pos.y },\n    { x: pos.x + 1, y: pos.y },\n    { x: pos.x, y: pos.y - 1 },\n    { x: pos.x, y: pos.y + 1 },\n  ].filter(p => p.x >= 0 && p.x < 100 && p.y >= 0 && p.y < 100);\n}\n\n// \u83B7\u53D6\u516B\u65B9\u5411\u76F8\u90BB\u683C\u5B50\uFF08\u5305\u62EC\u659C\u5411\uFF09\nexport function getDiagonalAdjacentPositions(pos: Position): Position[] {\n  const positions: Position[] = [];\n  for (let dx = -1; dx <= 1; dx++) {\n    for (let dy = -1; dy <= 1; dy++) {\n      if (dx === 0 && dy === 0) continue;\n      const nx = pos.x + dx;\n      const ny = pos.y + dy;\n      if (nx >= 0 && nx < 100 && ny >= 0 && ny < 100) {\n        positions.push({ x: nx, y: ny });\n      }\n    }\n  }\n  return positions;\n}\n\n// \u5BFC\u51FA\u5730\u56FE\u5B57\u7B26\u4E32\u8868\u793A\uFF08\u8C03\u8BD5\u7528\uFF09\nexport function getMapString(centerX: number, centerY: number, radius: number = 10): string {\n  const symbols: Record<TerrainType, string> = {\n    plain: \".\",\n    forest: \"\uD83C\uDF32\",\n    mountain: \"\uD83C\uDFD4\",\n    river: \"\uD83C\uDF0A\",\n    bridge: \"\uD83C\uDF09\",\n    road: \"\u2550\",\n    city: \"\uD83C\uDFEF\",\n  };\n  \n  let result = \"\";\n  const startY = Math.max(0, centerY - radius);\n  const endY = Math.min(99, centerY + radius);\n  const startX = Math.max(0, centerX - radius);\n  const endX = Math.min(99, centerX + radius);\n  \n  for (let y = startY; y <= endY; y++) {\n    for (let x = startX; x <= endX; x++) {\n      result += symbols[MAP_TERRAINS[y][x]];\n    }\n    result += \"\\n\";\n  }\n  \n  return result;\n}\n", "import { BattleGeneral, GameState, CombatResult, SpecialEffect, Position } from \"../types\";\nimport { getGeneralById } from \"../data/generals\";\nimport { getTerrain, manhattanDistance } from \"../data/map\";\nimport {\n  getAttackSkillEffects,\n  getDefenseSkillEffects,\n  getCounterAttackSkillEffects,\n  getThornsEffects,\n  getKillSkillEffects,\n  getPostAttackEffects,\n  getAttackRange,\n  isCounterAttackImmune,\n  applyBurnBuff,\n} from \"./skill\";\n\n// \u8BA1\u7B97\u6218\u6597\u7ED3\u679C\nexport function calculateCombat(\n  attacker: BattleGeneral,\n  defender: BattleGeneral,\n  gameState: GameState\n): CombatResult {\n  const attackerData = getGeneralById(attacker.general_id);\n  const defenderData = getGeneralById(defender.general_id);\n  \n  if (!attackerData || !defenderData) {\n    throw new Error(\"Invalid general data\");\n  }\n  \n  const triggeredSkills: string[] = [];\n  const specialEffects: SpecialEffect[] = [];\n  \n  // \u83B7\u53D6\u8DDD\u79BB\n  const distance = manhattanDistance(attacker.position, defender.position);\n  \n  // \u83B7\u53D6\u5730\u5F62\u9632\u5FA1\u52A0\u6210\n  const terrain = getTerrain(defender.position.x, defender.position.y);\n  \n  // === \u8BA1\u7B97\u653B\u51FB\u4F24\u5BB3 ===\n  \n  // \u83B7\u53D6\u653B\u51FB\u8005\u6280\u80FD\u6548\u679C\n  const attackSkillEffects = getAttackSkillEffects(attacker, defender, gameState);\n  triggeredSkills.push(...attackSkillEffects.triggered);\n  \n  // \u68C0\u67E5\u662F\u5426\u65E0\u89C6\u51CF\u4F24\uFF08\u5415\u5E03\u65E0\u53CC\uFF09\n  const ignoreReduction = attackSkillEffects.special.some(e => e.type === \"ignore_damage_reduction\");\n  \n  // \u83B7\u53D6\u9632\u5FA1\u8005\u6280\u80FD\u6548\u679C\n  const defenseSkillEffects = getDefenseSkillEffects(attacker, defender, gameState, ignoreReduction);\n  triggeredSkills.push(...defenseSkillEffects.triggered);\n  \n  // \u57FA\u7840\u653B\u51FB\u529B\n  let atk = attackerData.base_atk + attacker.atk_modifier + attackSkillEffects.atkBonus;\n  \n  // \u57FA\u7840\u9632\u5FA1\u529B\n  let def = defenderData.base_def + defender.def_modifier + terrain.def_bonus;\n  def += defenseSkillEffects.defBonus;\n  def -= attackSkillEffects.defPenalty;\n  def -= attackSkillEffects.ignoreDefense;\n  def = Math.max(0, def); // \u9632\u5FA1\u4E0D\u80FD\u4E3A\u8D1F\n  \n  // \u57FA\u7840\u4F24\u5BB3\n  let damage = Math.max(1, atk - def);\n  \n  // \u5E94\u7528\u4F24\u5BB3\u500D\u7387\n  damage = Math.floor(damage * attackSkillEffects.damageMultiplier);\n  \n  // \u5E94\u7528\u989D\u5916\u4F24\u5BB3\n  damage += attackSkillEffects.extraDamage;\n  \n  // \u786E\u4FDD\u6700\u5C111\u70B9\u4F24\u5BB3\n  damage = Math.max(1, damage);\n  \n  // === \u8BA1\u7B97\u53CD\u51FB\u4F24\u5BB3 ===\n  \n  let counterDamage = 0;\n  \n  // \u68C0\u67E5\u662F\u5426\u514D\u75AB\u53CD\u51FB\n  if (!isCounterAttackImmune(attacker, defender, distance) && defender.current_hp > damage) {\n    // \u83B7\u53D6\u53CD\u51FB\u6280\u80FD\u6548\u679C\n    const counterSkillEffects = getCounterAttackSkillEffects(attacker, defender, gameState);\n    triggeredSkills.push(...counterSkillEffects.triggered);\n    \n    // \u53CD\u51FB\u4F24\u5BB3 = \u57FA\u7840\u653B\u51FB - \u9632\u5FA1 / 2\n    const counterAtk = defenderData.base_atk + defender.atk_modifier;\n    const counterDef = attackerData.base_def + attacker.def_modifier;\n    const baseDamage = Math.max(1, counterAtk - counterDef);\n    counterDamage = Math.floor(baseDamage / 2) + counterSkillEffects.counterBonus;\n    counterDamage = Math.max(0, counterDamage);\n  }\n  \n  // === \u5224\u65AD\u662F\u5426\u51FB\u6740 ===\n  \n  const targetKilled = defender.current_hp <= damage;\n  const attackerKilled = attacker.current_hp <= counterDamage;\n  \n  // === \u6536\u96C6\u7279\u6B8A\u6548\u679C ===\n  \n  // \u5904\u7406\u6807\u8BB0\u653B\u51FB\uFF08\u5F20\u8FBD\u5A01\u9707\uFF09\n  for (const effect of attackSkillEffects.special) {\n    if (effect.type === \"mark_attacked\") {\n      specialEffects.push({\n        type: \"mark_attacked\",\n        target: effect.target,\n        value: effect.value,\n      });\n    }\n    if (effect.type === \"reset_inactive\") {\n      specialEffects.push({\n        type: \"reset_inactive\",\n        target: effect.target,\n        value: effect.value,\n      });\n    }\n  }\n  \n  // \u5904\u7406\u59DC\u7EF4\u80C6\u7565\u6807\u8BB0\n  for (const effect of defenseSkillEffects.special) {\n    if (effect.type === \"mark_first_damage\") {\n      specialEffects.push({\n        type: \"mark_first_damage\",\n        target: effect.target,\n        value: effect.value,\n      });\n    }\n  }\n  \n  // \u5904\u7406\u53CD\u4F24\uFF08\u590F\u4FAF\u60C7\u521A\u70C8\uFF09\n  const thornsEffects = getThornsEffects(attacker, defender, damage);\n  for (const effect of thornsEffects) {\n    specialEffects.push(effect);\n    triggeredSkills.push(\"\u521A\u70C8\");\n  }\n  \n  // \u5904\u7406\u51FB\u6740\u540E\u6548\u679C\n  if (targetKilled) {\n    const killEffects = getKillSkillEffects(attacker, defender, gameState);\n    specialEffects.push(...killEffects);\n    for (const effect of killEffects) {\n      if (effect.type === \"heal\") triggeredSkills.push(\"\u5978\u96C4\");\n      if (effect.type === \"extra_move\") triggeredSkills.push(\"\u9F99\u80C6\");\n    }\n  }\n  \n  // \u5904\u7406\u653B\u51FB\u540E\u6548\u679C\uFF08\u707C\u70E7\u3001\u8FDE\u73AF\uFF09\n  const postAttackEffects = getPostAttackEffects(attacker, defender, gameState);\n  specialEffects.push(...postAttackEffects);\n  for (const effect of postAttackEffects) {\n    if (effect.type === \"apply_burn\") triggeredSkills.push(\"\u706B\u653B\");\n    if (effect.type === \"splash_damage\") triggeredSkills.push(\"\u8FDE\u73AF\");\n  }\n  \n  return {\n    damage,\n    counter_damage: counterDamage,\n    attacker_killed: attackerKilled,\n    target_killed: targetKilled,\n    triggered_skills: [...new Set(triggeredSkills)], // \u53BB\u91CD\n    special_effects: specialEffects,\n  };\n}\n\n// \u5E94\u7528\u6218\u6597\u7ED3\u679C\u5230\u6E38\u620F\u72B6\u6001\nexport function applyCombatResult(\n  attacker: BattleGeneral,\n  defender: BattleGeneral,\n  result: CombatResult,\n  gameState: GameState\n): void {\n  // \u5E94\u7528\u4F24\u5BB3\n  defender.current_hp -= result.damage;\n  if (defender.current_hp <= 0) {\n    defender.current_hp = 0;\n    defender.is_alive = false;\n  }\n  \n  // \u5E94\u7528\u53CD\u51FB\u4F24\u5BB3\n  if (result.counter_damage > 0) {\n    attacker.current_hp -= result.counter_damage;\n    if (attacker.current_hp <= 0) {\n      attacker.current_hp = 0;\n      attacker.is_alive = false;\n    }\n  }\n  \n  // \u5E94\u7528\u7279\u6B8A\u6548\u679C\n  for (const effect of result.special_effects) {\n    applySpecialEffect(effect, attacker, defender, gameState);\n  }\n  \n  // \u6807\u8BB0\u5DF2\u884C\u52A8\n  attacker.has_acted = true;\n  \n  // \u66F4\u65B0\u9762\u671D\u65B9\u5411\n  updateFacing(attacker, defender.position);\n  if (defender.is_alive) {\n    updateFacing(defender, attacker.position);\n  }\n}\n\n// \u5E94\u7528\u7279\u6B8A\u6548\u679C\nfunction applySpecialEffect(\n  effect: SpecialEffect,\n  attacker: BattleGeneral,\n  defender: BattleGeneral,\n  gameState: GameState\n): void {\n  switch (effect.type) {\n    case \"mark_attacked\":\n      // \u6807\u8BB0\u5F20\u8FBD\u5DF2\u653B\u51FB\u8FC7\u8BE5\u654C\u4EBA\n      gameState.attacked_enemies[effect.target] = true;\n      break;\n      \n    case \"mark_first_damage\":\n      // \u6807\u8BB0\u59DC\u7EF4\u5DF2\u53D7\u5230\u9996\u6B21\u4F24\u5BB3\n      gameState.first_damage_taken[effect.target] = true;\n      break;\n      \n    case \"reset_inactive\":\n      // \u91CD\u7F6E\u53F8\u9A6C\u61FF\u9690\u5FCD\u8BA1\u6570\n      const general = findGeneralById(gameState, effect.target);\n      if (general) {\n        general.skill_state.inactive_rounds = 0;\n      }\n      break;\n      \n    case \"thorns_damage\":\n      // \u590F\u4FAF\u60C7\u521A\u70C8\u53CD\u4F24\n      attacker.current_hp -= effect.value;\n      if (attacker.current_hp <= 0) {\n        attacker.current_hp = 0;\n        attacker.is_alive = false;\n      }\n      break;\n      \n    case \"heal\":\n      // \u66F9\u64CD\u5978\u96C4\u56DE\u8840\n      const attackerData = getGeneralById(attacker.general_id);\n      if (attackerData) {\n        attacker.current_hp = Math.min(attackerData.base_hp, attacker.current_hp + effect.value);\n      }\n      break;\n      \n    case \"extra_move\":\n      // \u8D75\u4E91\u9F99\u80C6\u989D\u5916\u79FB\u52A8\uFF08\u5B58\u50A8\u5728skill_state\u4E2D\uFF0C\u7531movement\u670D\u52A1\u5904\u7406\uFF09\n      attacker.skill_state.extra_move = effect.value;\n      break;\n      \n    case \"apply_burn\":\n      // \u5468\u745C\u706B\u653B\u707C\u70E7\n      applyBurnBuff(defender);\n      break;\n      \n    case \"splash_damage\":\n      // \u5E9E\u7EDF\u8FDE\u73AF\u6E85\u5C04\n      const splashTarget = findGeneralById(gameState, effect.target);\n      if (splashTarget && splashTarget.is_alive) {\n        splashTarget.current_hp -= effect.value;\n        if (splashTarget.current_hp <= 0) {\n          splashTarget.current_hp = 0;\n          splashTarget.is_alive = false;\n        }\n      }\n      break;\n  }\n}\n\n// \u66F4\u65B0\u9762\u671D\u65B9\u5411\nfunction updateFacing(general: BattleGeneral, targetPos: Position): void {\n  const dx = targetPos.x - general.position.x;\n  const dy = targetPos.y - general.position.y;\n  \n  if (Math.abs(dx) > Math.abs(dy)) {\n    general.facing = dx > 0 ? \"right\" : \"left\";\n  } else {\n    general.facing = dy > 0 ? \"down\" : \"up\";\n  }\n}\n\n// \u6839\u636EID\u67E5\u627E\u6B66\u5C06\nfunction findGeneralById(gameState: GameState, instanceId: string): BattleGeneral | undefined {\n  return [...gameState.p1_generals, ...gameState.p2_generals].find(g => g.instance_id === instanceId);\n}\n\n// \u68C0\u67E5\u662F\u5426\u53EF\u4EE5\u653B\u51FB\u76EE\u6807\nexport function canAttack(\n  attacker: BattleGeneral,\n  defender: BattleGeneral,\n  gameState: GameState\n): { canAttack: boolean; reason?: string } {\n  // \u68C0\u67E5\u653B\u51FB\u8005\u662F\u5426\u5B58\u6D3B\n  if (!attacker.is_alive) {\n    return { canAttack: false, reason: \"\u653B\u51FB\u8005\u5DF2\u9635\u4EA1\" };\n  }\n  \n  // \u68C0\u67E5\u76EE\u6807\u662F\u5426\u5B58\u6D3B\n  if (!defender.is_alive) {\n    return { canAttack: false, reason: \"\u76EE\u6807\u5DF2\u9635\u4EA1\" };\n  }\n  \n  // \u68C0\u67E5\u662F\u5426\u5DF2\u884C\u52A8\n  if (attacker.has_acted) {\n    return { canAttack: false, reason: \"\u6B66\u5C06\u5DF2\u884C\u52A8\" };\n  }\n  \n  // \u68C0\u67E5\u662F\u5426\u662F\u654C\u4EBA\n  if (attacker.owner === defender.owner) {\n    return { canAttack: false, reason: \"\u4E0D\u80FD\u653B\u51FB\u53CB\u519B\" };\n  }\n  \n  // \u68C0\u67E5\u653B\u51FB\u8303\u56F4\n  const distance = manhattanDistance(attacker.position, defender.position);\n  const attackRange = getAttackRange(attacker);\n  \n  if (distance > attackRange) {\n    return { canAttack: false, reason: `\u76EE\u6807\u4E0D\u5728\u653B\u51FB\u8303\u56F4\u5185\uFF08\u8303\u56F4${attackRange}\u683C\uFF09` };\n  }\n  \n  if (distance === 0) {\n    return { canAttack: false, reason: \"\u76EE\u6807\u4E0D\u80FD\u5728\u540C\u4E00\u4F4D\u7F6E\" };\n  }\n  \n  return { canAttack: true };\n}\n\n// \u5904\u7406\u56DE\u5408\u5F00\u59CB\u7684\u707C\u70E7\u4F24\u5BB3\nexport function processBurnDamage(gameState: GameState): { target: string; damage: number }[] {\n  const results: { target: string; damage: number }[] = [];\n  const allGenerals = [...gameState.p1_generals, ...gameState.p2_generals];\n  \n  for (const general of allGenerals) {\n    if (!general.is_alive) continue;\n    \n    const burnBuff = general.buffs.find(b => b.type === \"burn\");\n    if (burnBuff) {\n      general.current_hp -= burnBuff.value;\n      results.push({ target: general.instance_id, damage: burnBuff.value });\n      \n      if (general.current_hp <= 0) {\n        general.current_hp = 0;\n        general.is_alive = false;\n      }\n      \n      // \u79FB\u9664\u707C\u70E7buff\n      general.buffs = general.buffs.filter(b => b.type !== \"burn\");\n    }\n  }\n  \n  return results;\n}\n\n// \u83B7\u53D6\u6B66\u5C06\u7684\u6709\u6548\u653B\u51FB\u529B\uFF08\u5305\u542B\u6240\u6709\u52A0\u6210\uFF09\nexport function getEffectiveAttack(general: BattleGeneral, gameState: GameState): number {\n  const data = getGeneralById(general.general_id);\n  if (!data) return 0;\n  \n  let atk = data.base_atk + general.atk_modifier;\n  \n  // \u5F20\u98DE\u5486\u54EE\n  if (data.skill_name === \"\u5486\u54EE\" && general.current_hp < 3) {\n    atk += 2;\n  }\n  \n  // \u9EC4\u76D6\u82E6\u8089\n  if (data.skill_name === \"\u82E6\u8089\") {\n    atk += data.base_hp - general.current_hp;\n  }\n  \n  // \u53F8\u9A6C\u61FF\u9690\u5FCD\n  if (data.skill_name === \"\u9690\u5FCD\" && (general.skill_state.inactive_rounds || 0) >= 3) {\n    atk += 2;\n  }\n  \n  return atk;\n}\n\n// \u83B7\u53D6\u6B66\u5C06\u7684\u6709\u6548\u9632\u5FA1\uFF08\u5305\u542B\u6240\u6709\u52A0\u6210\uFF09\nexport function getEffectiveDefense(general: BattleGeneral, gameState: GameState): number {\n  const data = getGeneralById(general.general_id);\n  if (!data) return 0;\n  \n  const terrain = getTerrain(general.position.x, general.position.y);\n  let def = data.base_def + general.def_modifier + terrain.def_bonus;\n  \n  // \u66F9\u4EC1\u575A\u5B88\n  if (data.skill_name === \"\u575A\u5B88\" && terrain.type === \"city\") {\n    def += 1;\n  }\n  \n  // \u53F8\u9A6C\u61FF\u9690\u5FCD\n  if (data.skill_name === \"\u9690\u5FCD\" && (general.skill_state.inactive_rounds || 0) >= 3) {\n    def += 2;\n  }\n  \n  return def;\n}\n", "import { BattleGeneral, GameState, Position, Buff, PlayerSide, Direction } from \"../types\";\nimport { getGeneralById } from \"../data/generals\";\nimport { isInCity, manhattanDistance, getAdjacentPositions, isInArea, CITY_AREA } from \"../data/map\";\n\n// \u6280\u80FD\u6548\u679C\u63A5\u53E3\nexport interface SkillEffect {\n  atkBonus: number;\n  defBonus: number;\n  defPenalty: number; // \u5BF9\u654C\u4EBA\u9632\u5FA1\u7684\u524A\u51CF\n  damageMultiplier: number;\n  ignoreDefense: number; // \u65E0\u89C6\u9632\u5FA1\u70B9\u6570\n  extraDamage: number;\n  counterBonus: number;\n  triggered: string[];\n  special: SpecialSkillEffect[];\n}\n\nexport interface SpecialSkillEffect {\n  type: string;\n  target: string;\n  value: any;\n}\n\n// \u521B\u5EFA\u9ED8\u8BA4\u6280\u80FD\u6548\u679C\nfunction defaultSkillEffect(): SkillEffect {\n  return {\n    atkBonus: 0,\n    defBonus: 0,\n    defPenalty: 0,\n    damageMultiplier: 1,\n    ignoreDefense: 0,\n    extraDamage: 0,\n    counterBonus: 0,\n    triggered: [],\n    special: [],\n  };\n}\n\n// \u83B7\u53D6\u653B\u51FB\u65F6\u7684\u6280\u80FD\u6548\u679C\nexport function getAttackSkillEffects(\n  attacker: BattleGeneral,\n  defender: BattleGeneral,\n  gameState: GameState\n): SkillEffect {\n  const effect = defaultSkillEffect();\n  const attackerData = getGeneralById(attacker.general_id);\n  const defenderData = getGeneralById(defender.general_id);\n  \n  if (!attackerData || !defenderData) return effect;\n  \n  // === \u653B\u51FB\u8005\u6280\u80FD ===\n  \n  // \u5173\u7FBD - \u6B66\u5723\uFF1A\u653B\u51FB\u65E0\u89C61\u70B9\u9632\u5FA1\n  if (attackerData.skill_name === \"\u6B66\u5723\") {\n    effect.ignoreDefense += 1;\n    effect.triggered.push(\"\u6B66\u5723\");\n  }\n  \n  // \u5F20\u98DE - \u5486\u54EE\uFF1AHP<3\u65F6\u653B\u51FB+2\n  if (attackerData.skill_name === \"\u5486\u54EE\" && attacker.current_hp < 3) {\n    effect.atkBonus += 2;\n    effect.triggered.push(\"\u5486\u54EE\");\n  }\n  \n  // \u9A6C\u8D85 - \u94C1\u9A91\uFF1A\u672C\u56DE\u5408\u79FB\u52A8\u22653\u683C\u540E\u653B\u51FB+2\n  if (attackerData.skill_name === \"\u94C1\u9A91\") {\n    const movedDistance = attacker.moved_distance || 0;\n    if (movedDistance >= 3) {\n      effect.atkBonus += 2;\n      effect.triggered.push(\"\u94C1\u9A91\");\n    }\n  }\n  \n  // \u5B59\u7B56 - \u9738\u738B\uFF1A\u5468\u56F42\u683C\u5185\u53EA\u67091\u4E2A\u654C\u4EBA\u65F6\u653B\u51FB+3\n  if (attackerData.skill_name === \"\u9738\u738B\") {\n    const nearbyEnemies = countNearbyEnemies(attacker, gameState, 2);\n    if (nearbyEnemies === 1) {\n      effect.atkBonus += 3;\n      effect.triggered.push(\"\u9738\u738B\");\n    }\n  }\n  \n  // \u7518\u5B81 - \u7A81\u88AD\uFF1A\u4ECE\u654C\u4EBA\u80CC\u540E\u653B\u51FB\u65F6\u4F24\u5BB3\u00D72\n  if (attackerData.skill_name === \"\u7A81\u88AD\") {\n    if (isAttackingFromBehind(attacker, defender)) {\n      effect.damageMultiplier *= 2;\n      effect.triggered.push(\"\u7A81\u88AD\");\n    }\n  }\n  \n  // \u9EC4\u76D6 - \u82E6\u8089\uFF1A\u6BCF\u635F\u59311\u70B9HP\uFF0C\u653B\u51FB+1\n  if (attackerData.skill_name === \"\u82E6\u8089\") {\n    const lostHp = attackerData.base_hp - attacker.current_hp;\n    if (lostHp > 0) {\n      effect.atkBonus += lostHp;\n      effect.triggered.push(\"\u82E6\u8089\");\n    }\n  }\n  \n  // \u5F90\u6643 - \u65AD\u7CAE\uFF1A\u653B\u51FB\u4F4D\u4E8E\u5DF1\u65B9\u51FA\u751F\u533A\u5230\u57CE\u6C60\u8FDE\u7EBF\u4E0A\u7684\u654C\u4EBA\u65F6\u4F24\u5BB3+2\n  if (attackerData.skill_name === \"\u65AD\u7CAE\") {\n    if (isOnSupplyLine(defender.position, attacker.owner)) {\n      effect.extraDamage += 2;\n      effect.triggered.push(\"\u65AD\u7CAE\");\n    }\n  }\n  \n  // \u5415\u5E03 - \u65E0\u53CC\uFF1A\u653B\u51FB\u65F6\u65E0\u89C6\u6240\u6709\u88AB\u52A8\u51CF\u4F24\u6548\u679C\n  if (attackerData.skill_name === \"\u65E0\u53CC\") {\n    effect.special.push({ type: \"ignore_damage_reduction\", target: defender.instance_id, value: true });\n    effect.triggered.push(\"\u65E0\u53CC\");\n  }\n  \n  // \u5F20\u8FBD - \u5A01\u9707\uFF1A\u5BF9\u6BCF\u4E2A\u654C\u4EBA\u7684\u9996\u6B21\u653B\u51FB\u4F7F\u5176\u9632\u5FA1-1\n  if (attackerData.skill_name === \"\u5A01\u9707\") {\n    const attackKey = `${attacker.instance_id}_${defender.instance_id}`;\n    if (!gameState.attacked_enemies[attackKey]) {\n      effect.defPenalty += 1;\n      effect.special.push({ type: \"mark_attacked\", target: attackKey, value: true });\n      effect.triggered.push(\"\u5A01\u9707\");\n    }\n  }\n  \n  // \u53F8\u9A6C\u61FF - \u9690\u5FCD\uFF1A\u8FDE\u7EED3\u56DE\u5408\u4E0D\u79FB\u52A8\u4E0D\u653B\u51FB\u540E\uFF0C\u653B\u9632\u5404+2\n  if (attackerData.skill_name === \"\u9690\u5FCD\") {\n    const inactiveRounds = attacker.skill_state.inactive_rounds || 0;\n    if (inactiveRounds >= 3) {\n      effect.atkBonus += 2;\n      effect.triggered.push(\"\u9690\u5FCD(\u653B\u51FB)\");\n    }\n    // \u653B\u51FB\u540E\u91CD\u7F6E\u8BA1\u6570\n    effect.special.push({ type: \"reset_inactive\", target: attacker.instance_id, value: true });\n  }\n  \n  // === \u5218\u5907 - \u4EC1\u5FB7\uFF1A\u76F8\u90BB\u53CB\u519B\u653B\u51FB+1 (\u4F5C\u4E3A\u961F\u53CB\u7684buff) ===\n  const adjacentAllies = getAdjacentAllies(attacker, gameState);\n  for (const ally of adjacentAllies) {\n    const allyData = getGeneralById(ally.general_id);\n    if (allyData?.skill_name === \"\u4EC1\u5FB7\") {\n      effect.atkBonus += 1;\n      effect.triggered.push(\"\u4EC1\u5FB7(\u5218\u5907)\");\n      break; // \u53EA\u89E6\u53D1\u4E00\u6B21\n    }\n  }\n  \n  return effect;\n}\n\n// \u83B7\u53D6\u9632\u5FA1\u65F6\u7684\u6280\u80FD\u6548\u679C\nexport function getDefenseSkillEffects(\n  attacker: BattleGeneral,\n  defender: BattleGeneral,\n  gameState: GameState,\n  ignoreReduction: boolean = false\n): SkillEffect {\n  const effect = defaultSkillEffect();\n  const defenderData = getGeneralById(defender.general_id);\n  const attackerData = getGeneralById(attacker.general_id);\n  \n  if (!defenderData || !attackerData) return effect;\n  \n  // \u5982\u679C\u5415\u5E03\u65E0\u53CC\u89E6\u53D1\uFF0C\u8DF3\u8FC7\u6240\u6709\u88AB\u52A8\u51CF\u4F24\n  if (ignoreReduction) {\n    return effect;\n  }\n  \n  // \u66F9\u4EC1 - \u575A\u5B88\uFF1A\u5728\u57CE\u6C60\u5185\u65F6\u989D\u5916\u9632\u5FA1+1\n  if (defenderData.skill_name === \"\u575A\u5B88\") {\n    if (isInCity(defender.position.x, defender.position.y)) {\n      effect.defBonus += 1;\n      effect.triggered.push(\"\u575A\u5B88\");\n    }\n  }\n  \n  // \u59DC\u7EF4 - \u80C6\u7565\uFF1A\u6BCF\u573A\u6218\u6597\u9996\u6B21\u53D7\u4F24\u51CF\u514D1\u70B9\n  if (defenderData.skill_name === \"\u80C6\u7565\") {\n    if (!gameState.first_damage_taken[defender.instance_id]) {\n      effect.defBonus += 1;\n      effect.special.push({ type: \"mark_first_damage\", target: defender.instance_id, value: true });\n      effect.triggered.push(\"\u80C6\u7565\");\n    }\n  }\n  \n  // \u53F8\u9A6C\u61FF - \u9690\u5FCD\uFF1A\u8FDE\u7EED3\u56DE\u5408\u4E0D\u79FB\u52A8\u4E0D\u653B\u51FB\u540E\uFF0C\u653B\u9632\u5404+2\n  if (defenderData.skill_name === \"\u9690\u5FCD\") {\n    const inactiveRounds = defender.skill_state.inactive_rounds || 0;\n    if (inactiveRounds >= 3) {\n      effect.defBonus += 2;\n      effect.triggered.push(\"\u9690\u5FCD(\u9632\u5FA1)\");\n    }\n  }\n  \n  // \u5B59\u6743 - \u5236\u8861\uFF1A\u76F8\u90BB\u53CB\u519B\u5171\u4EAB\u6700\u9AD8\u9632\u5FA1\u503C\n  const adjacentAllies = getAdjacentAllies(defender, gameState);\n  for (const ally of adjacentAllies) {\n    const allyData = getGeneralById(ally.general_id);\n    if (allyData?.skill_name === \"\u5236\u8861\") {\n      // \u627E\u51FA\u76F8\u90BB\u53CB\u519B\u4E2D\u6700\u9AD8\u7684\u9632\u5FA1\n      const maxDef = Math.max(\n        defenderData.base_def + defender.def_modifier,\n        ...adjacentAllies.map(a => {\n          const d = getGeneralById(a.general_id);\n          return d ? d.base_def + a.def_modifier : 0;\n        })\n      );\n      const currentDef = defenderData.base_def + defender.def_modifier;\n      if (maxDef > currentDef) {\n        effect.defBonus += maxDef - currentDef;\n        effect.triggered.push(\"\u5236\u8861(\u5B59\u6743)\");\n      }\n      break;\n    }\n  }\n  \n  return effect;\n}\n\n// \u83B7\u53D6\u53CD\u51FB\u65F6\u7684\u6280\u80FD\u6548\u679C\nexport function getCounterAttackSkillEffects(\n  attacker: BattleGeneral, // \u539F\u6765\u7684\u653B\u51FB\u8005\uFF0C\u73B0\u5728\u88AB\u53CD\u51FB\n  defender: BattleGeneral, // \u539F\u6765\u7684\u9632\u5FA1\u8005\uFF0C\u73B0\u5728\u53CD\u51FB\n  gameState: GameState\n): SkillEffect {\n  const effect = defaultSkillEffect();\n  const defenderData = getGeneralById(defender.general_id);\n  \n  if (!defenderData) return effect;\n  \n  // \u9B4F\u5EF6 - \u53CD\u9AA8\uFF1A\u88AB\u653B\u51FB\u65F6\u53CD\u51FB\u4F24\u5BB3+1\n  if (defenderData.skill_name === \"\u53CD\u9AA8\") {\n    effect.counterBonus += 1;\n    effect.triggered.push(\"\u53CD\u9AA8\");\n  }\n  \n  return effect;\n}\n\n// \u68C0\u67E5\u662F\u5426\u89E6\u53D1\u53CD\u4F24\u6280\u80FD\nexport function getThornsEffects(\n  attacker: BattleGeneral,\n  defender: BattleGeneral,\n  damage: number\n): SpecialSkillEffect[] {\n  const effects: SpecialSkillEffect[] = [];\n  const defenderData = getGeneralById(defender.general_id);\n  \n  if (!defenderData) return effects;\n  \n  // \u590F\u4FAF\u60C7 - \u521A\u70C8\uFF1A\u53D7\u5230\u4F24\u5BB3\u65F6\u5BF9\u653B\u51FB\u8005\u9020\u62101\u70B9\u53CD\u4F24\n  if (defenderData.skill_name === \"\u521A\u70C8\" && damage > 0) {\n    effects.push({\n      type: \"thorns_damage\",\n      target: attacker.instance_id,\n      value: 1,\n    });\n  }\n  \n  return effects;\n}\n\n// \u68C0\u67E5\u51FB\u6740\u540E\u89E6\u53D1\u7684\u6280\u80FD\nexport function getKillSkillEffects(\n  attacker: BattleGeneral,\n  defender: BattleGeneral,\n  gameState: GameState\n): SpecialSkillEffect[] {\n  const effects: SpecialSkillEffect[] = [];\n  const attackerData = getGeneralById(attacker.general_id);\n  \n  if (!attackerData) return effects;\n  \n  // \u66F9\u64CD - \u5978\u96C4\uFF1A\u51FB\u6740\u654C\u4EBA\u56DE\u590D1HP\n  if (attackerData.skill_name === \"\u5978\u96C4\") {\n    effects.push({\n      type: \"heal\",\n      target: attacker.instance_id,\n      value: 1,\n    });\n  }\n  \n  // \u8D75\u4E91 - \u9F99\u80C6\uFF1A\u51FB\u6740\u540E\u53EF\u518D\u79FB\u52A82\u683C\n  if (attackerData.skill_name === \"\u9F99\u80C6\") {\n    effects.push({\n      type: \"extra_move\",\n      target: attacker.instance_id,\n      value: 2,\n    });\n  }\n  \n  return effects;\n}\n\n// \u653B\u51FB\u540E\u89E6\u53D1\u7684\u6548\u679C\nexport function getPostAttackEffects(\n  attacker: BattleGeneral,\n  defender: BattleGeneral,\n  gameState: GameState\n): SpecialSkillEffect[] {\n  const effects: SpecialSkillEffect[] = [];\n  const attackerData = getGeneralById(attacker.general_id);\n  \n  if (!attackerData) return effects;\n  \n  // \u5468\u745C - \u706B\u653B\uFF1A\u653B\u51FB\u540E\u76EE\u6807\u83B7\u5F97\"\u707C\u70E7\"\u72B6\u6001\n  if (attackerData.skill_name === \"\u706B\u653B\" && defender.is_alive) {\n    effects.push({\n      type: \"apply_burn\",\n      target: defender.instance_id,\n      value: 1, // 1\u70B9\u4F24\u5BB3\n    });\n  }\n  \n  // \u5E9E\u7EDF - \u8FDE\u73AF\uFF1A\u653B\u51FB\u65F6\u5BF9\u76EE\u6807\u76F8\u90BB\u76841\u4E2A\u654C\u4EBA\u9020\u62101\u70B9\u6E85\u5C04\u4F24\u5BB3\n  if (attackerData.skill_name === \"\u8FDE\u73AF\") {\n    const adjacentEnemies = getAdjacentEnemies(defender, gameState);\n    if (adjacentEnemies.length > 0) {\n      // \u968F\u673A\u9009\u62E9\u4E00\u4E2A\uFF08\u6216\u9009\u62E9\u7B2C\u4E00\u4E2A\uFF09\n      effects.push({\n        type: \"splash_damage\",\n        target: adjacentEnemies[0].instance_id,\n        value: 1,\n      });\n    }\n  }\n  \n  return effects;\n}\n\n// \u83B7\u53D6\u6B66\u5C06\u7684\u653B\u51FB\u8303\u56F4\nexport function getAttackRange(general: BattleGeneral): number {\n  const data = getGeneralById(general.general_id);\n  if (!data) return 1;\n  \n  // \u9EC4\u5FE0 - \u767E\u6B65\uFF1A\u653B\u51FB\u8303\u56F43\u683C\n  if (data.skill_name === \"\u767E\u6B65\") {\n    return 3;\n  }\n  \n  // \u9646\u900A - \u8425\u70E7\uFF1A\u653B\u51FB\u8303\u56F4+1\u683C\n  if (data.skill_name === \"\u8425\u70E7\") {\n    return 2;\n  }\n  \n  // \u592A\u53F2\u6148 - \u795E\u5C04\uFF1A\u53EF\u8FDC\u7A0B\u653B\u51FB\n  if (data.skill_name === \"\u795E\u5C04\") {\n    return 3;\n  }\n  \n  // \u5F13\u624B\u7C7B\u578B\u9ED8\u8BA42\u683C\uFF08\u867D\u7136\u4E0A\u9762\u5DF2\u7ECF\u7279\u6B8A\u5904\u7406\u4E86\uFF09\n  if (data.type === \"\u5F13\u624B\") {\n    return 2;\n  }\n  \n  return 1; // \u9ED8\u8BA4\u8FD1\u6218\n}\n\n// \u68C0\u67E5\u662F\u5426\u514D\u9664\u53CD\u51FB\nexport function isCounterAttackImmune(\n  attacker: BattleGeneral,\n  defender: BattleGeneral,\n  distance: number\n): boolean {\n  const attackerData = getGeneralById(attacker.general_id);\n  if (!attackerData) return false;\n  \n  // \u592A\u53F2\u6148 - \u795E\u5C04\uFF1A\u8FDC\u7A0B\u653B\u51FB(2-3\u683C)\u65F6\u4E0D\u53D7\u53CD\u51FB\n  if (attackerData.skill_name === \"\u795E\u5C04\" && distance >= 2) {\n    return true;\n  }\n  \n  // \u8FDC\u7A0B\u653B\u51FB\u4E0D\u89E6\u53D1\u53CD\u51FB\uFF08\u8DDD\u79BB>=2\uFF09\n  if (distance >= 2) {\n    return true;\n  }\n  \n  return false;\n}\n\n// \u68C0\u67E5\u662F\u5426\u53EF\u4EE5\u64A4\u9000\nexport function canRetreat(general: BattleGeneral, gameState: GameState): boolean {\n  // \u68C0\u67E5\u662F\u5426\u88AB\u5178\u97E6\u6076\u6765\u9650\u5236\n  const enemies = general.owner === \"p1\" ? gameState.p2_generals : gameState.p1_generals;\n  \n  for (const enemy of enemies) {\n    if (!enemy.is_alive) continue;\n    const enemyData = getGeneralById(enemy.general_id);\n    if (enemyData?.skill_name === \"\u6076\u6765\") {\n      const dist = manhattanDistance(general.position, enemy.position);\n      if (dist === 1) {\n        return false; // \u88AB\u5178\u97E6\u9650\u5236\n      }\n    }\n  }\n  \n  return true;\n}\n\n// \u68C0\u67E5\u662F\u5426\u53EF\u4EE5\u659C\u5411\u79FB\u52A8\nexport function canMoveDiagonally(general: BattleGeneral): boolean {\n  const data = getGeneralById(general.general_id);\n  if (!data) return false;\n  \n  // \u5F20\u90C3 - \u5DE7\u53D8\uFF1A\u53EF\u659C\u5411\u79FB\u52A8\n  return data.skill_name === \"\u5DE7\u53D8\";\n}\n\n// \u68C0\u67E5\u662F\u5426\u53EF\u4EE5\u7A7F\u8D8A\u654C\u65B9\u5355\u4F4D\nexport function canPassThroughEnemy(general: BattleGeneral): boolean {\n  const data = getGeneralById(general.general_id);\n  if (!data) return false;\n  \n  // \u5415\u8499 - \u767D\u8863\uFF1A\u79FB\u52A8\u65F6\u53EF\u7A7F\u8D8A\u654C\u65B9\u5355\u4F4D\n  return data.skill_name === \"\u767D\u8863\";\n}\n\n// \u5904\u7406\u56DE\u5408\u5F00\u59CB\u7684\u6280\u80FD\u6548\u679C\nexport function processRoundStartEffects(gameState: GameState): SpecialSkillEffect[] {\n  const effects: SpecialSkillEffect[] = [];\n  const allGenerals = [...gameState.p1_generals, ...gameState.p2_generals];\n  \n  for (const general of allGenerals) {\n    if (!general.is_alive) continue;\n    \n    // \u5904\u7406\u707C\u70E7\u6548\u679C\n    const burnBuff = general.buffs.find(b => b.type === \"burn\");\n    if (burnBuff) {\n      effects.push({\n        type: \"burn_damage\",\n        target: general.instance_id,\n        value: burnBuff.value,\n      });\n    }\n  }\n  \n  return effects;\n}\n\n// \u5904\u7406\u56DE\u5408\u7ED3\u675F\u7684\u6280\u80FD\u6548\u679C\nexport function processRoundEndEffects(gameState: GameState): SpecialSkillEffect[] {\n  const effects: SpecialSkillEffect[] = [];\n  \n  // \u51CF\u5C11buff\u6301\u7EED\u65F6\u95F4\uFF0C\u79FB\u9664\u8FC7\u671Fbuff\n  const allGenerals = [...gameState.p1_generals, ...gameState.p2_generals];\n  for (const general of allGenerals) {\n    general.buffs = general.buffs.filter(buff => {\n      if (buff.duration === -1) return true; // \u6C38\u4E45buff\n      buff.duration--;\n      return buff.duration > 0;\n    });\n  }\n  \n  return effects;\n}\n\n// \u66F4\u65B0\u53F8\u9A6C\u61FF\u9690\u5FCD\u72B6\u6001\nexport function updateInactiveRounds(general: BattleGeneral, acted: boolean): void {\n  const data = getGeneralById(general.general_id);\n  if (data?.skill_name !== \"\u9690\u5FCD\") return;\n  \n  if (acted) {\n    general.skill_state.inactive_rounds = 0;\n  } else {\n    general.skill_state.inactive_rounds = (general.skill_state.inactive_rounds || 0) + 1;\n  }\n}\n\n// === \u8F85\u52A9\u51FD\u6570 ===\n\n// \u83B7\u53D6\u76F8\u90BB\u53CB\u519B\nfunction getAdjacentAllies(general: BattleGeneral, gameState: GameState): BattleGeneral[] {\n  const allies = general.owner === \"p1\" ? gameState.p1_generals : gameState.p2_generals;\n  const adjacentPositions = getAdjacentPositions(general.position);\n  \n  return allies.filter(ally => \n    ally.instance_id !== general.instance_id &&\n    ally.is_alive &&\n    adjacentPositions.some(p => p.x === ally.position.x && p.y === ally.position.y)\n  );\n}\n\n// \u83B7\u53D6\u76F8\u90BB\u654C\u519B\nfunction getAdjacentEnemies(general: BattleGeneral, gameState: GameState): BattleGeneral[] {\n  const enemies = general.owner === \"p1\" ? gameState.p2_generals : gameState.p1_generals;\n  const adjacentPositions = getAdjacentPositions(general.position);\n  \n  return enemies.filter(enemy => \n    enemy.is_alive &&\n    adjacentPositions.some(p => p.x === enemy.position.x && p.y === enemy.position.y)\n  );\n}\n\n// \u7EDF\u8BA1\u9644\u8FD1\u654C\u4EBA\u6570\u91CF\nfunction countNearbyEnemies(general: BattleGeneral, gameState: GameState, range: number): number {\n  const enemies = general.owner === \"p1\" ? gameState.p2_generals : gameState.p1_generals;\n  \n  return enemies.filter(enemy => \n    enemy.is_alive &&\n    manhattanDistance(general.position, enemy.position) <= range\n  ).length;\n}\n\n// \u68C0\u67E5\u662F\u5426\u4ECE\u80CC\u540E\u653B\u51FB\nfunction isAttackingFromBehind(attacker: BattleGeneral, defender: BattleGeneral): boolean {\n  const dx = attacker.position.x - defender.position.x;\n  const dy = attacker.position.y - defender.position.y;\n  \n  // \u786E\u5B9A\u653B\u51FB\u65B9\u5411\n  let attackDirection: Direction;\n  if (Math.abs(dx) > Math.abs(dy)) {\n    attackDirection = dx > 0 ? \"right\" : \"left\";\n  } else {\n    attackDirection = dy > 0 ? \"down\" : \"up\";\n  }\n  \n  // \u68C0\u67E5\u662F\u5426\u662F\u80CC\u540E\uFF08\u654C\u4EBA\u9762\u671D\u65B9\u5411\u7684\u53CD\u65B9\u5411\uFF09\n  const behindMap: Record<Direction, Direction> = {\n    up: \"down\",\n    down: \"up\",\n    left: \"right\",\n    right: \"left\",\n  };\n  \n  return attackDirection === behindMap[defender.facing];\n}\n\n// \u68C0\u67E5\u662F\u5426\u5728\u8865\u7ED9\u7EBF\u4E0A\uFF08\u5F90\u6643\u65AD\u7CAE\uFF09\nfunction isOnSupplyLine(pos: Position, attackerOwner: PlayerSide): boolean {\n  // P1\u8865\u7ED9\u7EBF\uFF1A\u4ECE(0,0)\u5230(50,50)\u7684\u8DEF\u7EBF\n  // P2\u8865\u7ED9\u7EBF\uFF1A\u4ECE(99,99)\u5230(50,50)\u7684\u8DEF\u7EBF\n  \n  if (attackerOwner === \"p1\") {\n    // \u5BF9P1\u6765\u8BF4\uFF0C\u654C\u4EBA\u5728P2\u7684\u8865\u7ED9\u7EBF\u4E0A\u6709\u5229\n    // P2\u8865\u7ED9\u7EBF\u5927\u81F4\u662F\u4ECE(99,99)\u5230\u57CE\u6C60(50,50)\n    // \u7B80\u5316\uFF1A\u5728y >= x - 10 && y <= x + 10 && x >= 50 \u7684\u533A\u57DF\n    return pos.x >= 50 && pos.x <= 99 && Math.abs(pos.x - pos.y) <= 15;\n  } else {\n    // \u5BF9P2\u6765\u8BF4\uFF0C\u654C\u4EBA\u5728P1\u7684\u8865\u7ED9\u7EBF\u4E0A\u6709\u5229\n    // P1\u8865\u7ED9\u7EBF\u5927\u81F4\u662F\u4ECE(0,0)\u5230\u57CE\u6C60(50,50)\n    return pos.x >= 0 && pos.x <= 50 && Math.abs(pos.x - pos.y) <= 15;\n  }\n}\n\n// \u5E94\u7528\u707C\u70E7buff\nexport function applyBurnBuff(general: BattleGeneral): void {\n  // \u79FB\u9664\u65E7\u7684\u707C\u70E7\uFF0C\u6DFB\u52A0\u65B0\u7684\n  general.buffs = general.buffs.filter(b => b.type !== \"burn\");\n  general.buffs.push({\n    type: \"burn\",\n    value: 1,\n    duration: 1,\n    source: \"\u706B\u653B\",\n  });\n}\n\n// \u8BF8\u845B\u4EAE\u795E\u7B97 - \u83B7\u53D6\u53EF\u6307\u6325\u7684\u53CB\u519B\nexport function getCommandableAllies(\n  zhugeLiang: BattleGeneral,\n  gameState: GameState\n): BattleGeneral[] {\n  const data = getGeneralById(zhugeLiang.general_id);\n  if (data?.skill_name !== \"\u795E\u7B97\") return [];\n  \n  const allies = zhugeLiang.owner === \"p1\" ? gameState.p1_generals : gameState.p2_generals;\n  \n  return allies.filter(ally => \n    ally.instance_id !== zhugeLiang.instance_id &&\n    ally.is_alive &&\n    !ally.has_acted &&\n    manhattanDistance(zhugeLiang.position, ally.position) <= 2\n  );\n}\n\n// \u90ED\u5609\u9B3C\u624D - \u83B7\u53D6\u53EF\u67E5\u770B\u7684\u654C\u4EBA\uFF08\u6682\u65F6\u53EA\u8FD4\u56DE\u8303\u56F4\u5185\u654C\u4EBA\uFF0C\u5B9E\u9645\u610F\u56FE\u9700\u8981AI\u7CFB\u7EDF\u652F\u6301\uFF09\nexport function getVisibleEnemyIntents(\n  guojia: BattleGeneral,\n  gameState: GameState\n): { enemy: BattleGeneral; intent: string }[] {\n  const data = getGeneralById(guojia.general_id);\n  if (data?.skill_name !== \"\u9B3C\u624D\") return [];\n  \n  const enemies = guojia.owner === \"p1\" ? gameState.p2_generals : gameState.p1_generals;\n  \n  return enemies\n    .filter(enemy => \n      enemy.is_alive &&\n      manhattanDistance(guojia.position, enemy.position) <= 5\n    )\n    .map(enemy => ({\n      enemy,\n      intent: \"unknown\", // \u5B9E\u9645\u610F\u56FE\u9700\u8981AI\u7CFB\u7EDF\u63D0\u4F9B\n    }));\n}\n", "import { BattleGeneral, GameState, Position, Direction } from \"../types\";\nimport { getGeneralById } from \"../data/generals\";\nimport {\n  getTerrain,\n  isPassable,\n  manhattanDistance,\n  getAdjacentPositions,\n  getDiagonalAdjacentPositions,\n} from \"../data/map\";\nimport { canMoveDiagonally, canPassThroughEnemy } from \"./skill\";\n\n// \u8DEF\u5F84\u8282\u70B9\ninterface PathNode {\n  x: number;\n  y: number;\n  cost: number; // \u5230\u8FBE\u6B64\u70B9\u7684\u603B\u79FB\u52A8\u6D88\u8017\n  parent: PathNode | null;\n}\n\n// \u53EF\u79FB\u52A8\u8303\u56F4\u7ED3\u679C\nexport interface MoveableArea {\n  positions: Position[];\n  costs: Map<string, number>; // position key -> cost\n}\n\n// \u8BA1\u7B97\u6B66\u5C06\u53EF\u79FB\u52A8\u7684\u8303\u56F4\nexport function getMoveableArea(\n  general: BattleGeneral,\n  gameState: GameState\n): MoveableArea {\n  const data = getGeneralById(general.general_id);\n  if (!data) {\n    return { positions: [], costs: new Map() };\n  }\n  \n  const maxMov = data.base_mov + general.mov_modifier;\n  const canDiagonal = canMoveDiagonally(general);\n  const canPassEnemy = canPassThroughEnemy(general);\n  \n  // \u83B7\u53D6\u6240\u6709\u5355\u4F4D\u4F4D\u7F6E\n  const occupiedPositions = getOccupiedPositions(gameState, general.instance_id);\n  const enemyPositions = getEnemyPositions(general.owner, gameState);\n  \n  // BFS\u641C\u7D22\u53EF\u8FBE\u4F4D\u7F6E\n  const visited = new Map<string, number>(); // position key -> min cost\n  const queue: PathNode[] = [{\n    x: general.position.x,\n    y: general.position.y,\n    cost: 0,\n    parent: null,\n  }];\n  \n  visited.set(posKey(general.position), 0);\n  const reachable: Position[] = [];\n  const costs = new Map<string, number>();\n  \n  while (queue.length > 0) {\n    const current = queue.shift()!;\n    \n    // \u83B7\u53D6\u53EF\u79FB\u52A8\u7684\u76F8\u90BB\u683C\u5B50\n    const neighbors = canDiagonal\n      ? getDiagonalAdjacentPositions({ x: current.x, y: current.y })\n      : getAdjacentPositions({ x: current.x, y: current.y });\n    \n    for (const neighbor of neighbors) {\n      // \u68C0\u67E5\u662F\u5426\u53EF\u901A\u884C\n      if (!isPassable(neighbor.x, neighbor.y)) continue;\n      \n      // \u8BA1\u7B97\u79FB\u52A8\u6D88\u8017\n      const terrain = getTerrain(neighbor.x, neighbor.y);\n      let moveCost = terrain.mov_cost;\n      \n      // \u659C\u5411\u79FB\u52A8\u6D88\u8017\u989D\u59160.5\n      if (canDiagonal && current.x !== neighbor.x && current.y !== neighbor.y) {\n        moveCost *= 1.4; // \u659C\u5411\u79FB\u52A8\u8DDD\u79BB\u7EA61.4\u500D\n      }\n      \n      const totalCost = current.cost + moveCost;\n      \n      // \u68C0\u67E5\u662F\u5426\u8D85\u51FA\u79FB\u52A8\u529B\n      if (totalCost > maxMov) continue;\n      \n      const key = posKey(neighbor);\n      \n      // \u68C0\u67E5\u662F\u5426\u5DF2\u8BBF\u95EE\u8FC7\u4E14\u4EE3\u4EF7\u66F4\u4F4E\n      if (visited.has(key) && visited.get(key)! <= totalCost) continue;\n      \n      // \u68C0\u67E5\u662F\u5426\u88AB\u5360\u7528\n      const isOccupied = occupiedPositions.has(key);\n      const isEnemyPos = enemyPositions.has(key);\n      \n      // \u5415\u8499\u767D\u8863\u53EF\u4EE5\u7A7F\u8D8A\u654C\u4EBA\uFF0C\u4F46\u4E0D\u80FD\u505C\u7559\n      if (isOccupied && !isEnemyPos) continue; // \u53CB\u519B\u4F4D\u7F6E\u4E0D\u80FD\u901A\u8FC7\n      if (isEnemyPos && !canPassEnemy) continue; // \u654C\u519B\u4F4D\u7F6E\u9700\u8981\u767D\u8863\u6280\u80FD\n      \n      visited.set(key, totalCost);\n      \n      // \u53EA\u6709\u975E\u5360\u7528\u4F4D\u7F6E\u624D\u53EF\u4EE5\u4F5C\u4E3A\u7EC8\u70B9\n      if (!isOccupied) {\n        reachable.push({ x: neighbor.x, y: neighbor.y });\n        costs.set(key, totalCost);\n      }\n      \n      // \u7EE7\u7EED\u641C\u7D22\uFF08\u5373\u4F7F\u662F\u654C\u4EBA\u4F4D\u7F6E\u4E5F\u8981\u7EE7\u7EED\uFF0C\u56E0\u4E3A\u53EF\u80FD\u7A7F\u8D8A\uFF09\n      queue.push({\n        x: neighbor.x,\n        y: neighbor.y,\n        cost: totalCost,\n        parent: current,\n      });\n    }\n  }\n  \n  return { positions: reachable, costs };\n}\n\n// \u8BA1\u7B97\u79FB\u52A8\u8DEF\u5F84\nexport function findPath(\n  general: BattleGeneral,\n  target: Position,\n  gameState: GameState\n): Position[] | null {\n  const data = getGeneralById(general.general_id);\n  if (!data) return null;\n  \n  const maxMov = data.base_mov + general.mov_modifier;\n  const canDiagonal = canMoveDiagonally(general);\n  const canPassEnemy = canPassThroughEnemy(general);\n  \n  // \u83B7\u53D6\u6240\u6709\u5355\u4F4D\u4F4D\u7F6E\n  const occupiedPositions = getOccupiedPositions(gameState, general.instance_id);\n  const enemyPositions = getEnemyPositions(general.owner, gameState);\n  \n  // \u68C0\u67E5\u76EE\u6807\u662F\u5426\u88AB\u5360\u7528\n  if (occupiedPositions.has(posKey(target))) {\n    return null;\n  }\n  \n  // A*\u641C\u7D22\n  const openSet: PathNode[] = [{\n    x: general.position.x,\n    y: general.position.y,\n    cost: 0,\n    parent: null,\n  }];\n  \n  const closedSet = new Set<string>();\n  const gScore = new Map<string, number>();\n  gScore.set(posKey(general.position), 0);\n  \n  while (openSet.length > 0) {\n    // \u6309f\u503C\u6392\u5E8F\uFF08g + h\uFF09\n    openSet.sort((a, b) => {\n      const fA = a.cost + manhattanDistance({ x: a.x, y: a.y }, target);\n      const fB = b.cost + manhattanDistance({ x: b.x, y: b.y }, target);\n      return fA - fB;\n    });\n    \n    const current = openSet.shift()!;\n    const currentKey = posKey({ x: current.x, y: current.y });\n    \n    // \u5230\u8FBE\u76EE\u6807\n    if (current.x === target.x && current.y === target.y) {\n      return reconstructPath(current);\n    }\n    \n    closedSet.add(currentKey);\n    \n    // \u83B7\u53D6\u90BB\u5C45\n    const neighbors = canDiagonal\n      ? getDiagonalAdjacentPositions({ x: current.x, y: current.y })\n      : getAdjacentPositions({ x: current.x, y: current.y });\n    \n    for (const neighbor of neighbors) {\n      const neighborKey = posKey(neighbor);\n      \n      if (closedSet.has(neighborKey)) continue;\n      if (!isPassable(neighbor.x, neighbor.y)) continue;\n      \n      // \u8BA1\u7B97\u79FB\u52A8\u6D88\u8017\n      const terrain = getTerrain(neighbor.x, neighbor.y);\n      let moveCost = terrain.mov_cost;\n      \n      if (canDiagonal && current.x !== neighbor.x && current.y !== neighbor.y) {\n        moveCost *= 1.4;\n      }\n      \n      const tentativeG = current.cost + moveCost;\n      \n      // \u68C0\u67E5\u662F\u5426\u8D85\u51FA\u79FB\u52A8\u529B\n      if (tentativeG > maxMov) continue;\n      \n      // \u68C0\u67E5\u5360\u7528\n      const isOccupied = occupiedPositions.has(neighborKey);\n      const isEnemyPos = enemyPositions.has(neighborKey);\n      \n      // \u6700\u7EC8\u76EE\u6807\u4E0D\u80FD\u662F\u5360\u7528\u4F4D\u7F6E\n      if (neighbor.x === target.x && neighbor.y === target.y && isOccupied) continue;\n      \n      // \u4E2D\u95F4\u8DEF\u5F84\uFF1A\u53CB\u519B\u4E0D\u80FD\u7A7F\u8D8A\uFF0C\u654C\u519B\u9700\u8981\u767D\u8863\n      if (isOccupied && !isEnemyPos) continue;\n      if (isEnemyPos && !canPassEnemy) continue;\n      \n      // \u66F4\u597D\u7684\u8DEF\u5F84\n      if (!gScore.has(neighborKey) || tentativeG < gScore.get(neighborKey)!) {\n        gScore.set(neighborKey, tentativeG);\n        \n        const existingIndex = openSet.findIndex(n => n.x === neighbor.x && n.y === neighbor.y);\n        const newNode: PathNode = {\n          x: neighbor.x,\n          y: neighbor.y,\n          cost: tentativeG,\n          parent: current,\n        };\n        \n        if (existingIndex >= 0) {\n          openSet[existingIndex] = newNode;\n        } else {\n          openSet.push(newNode);\n        }\n      }\n    }\n  }\n  \n  return null; // \u65E0\u6CD5\u5230\u8FBE\n}\n\n// \u91CD\u5EFA\u8DEF\u5F84\nfunction reconstructPath(node: PathNode): Position[] {\n  const path: Position[] = [];\n  let current: PathNode | null = node;\n  \n  while (current) {\n    path.unshift({ x: current.x, y: current.y });\n    current = current.parent;\n  }\n  \n  return path;\n}\n\n// \u6267\u884C\u79FB\u52A8\nexport function executeMove(\n  general: BattleGeneral,\n  target: Position,\n  gameState: GameState\n): { success: boolean; path?: Position[]; error?: string } {\n  // \u68C0\u67E5\u662F\u5426\u5DF2\u884C\u52A8\n  if (general.has_acted) {\n    return { success: false, error: \"\u6B66\u5C06\u5DF2\u884C\u52A8\" };\n  }\n  \n  // \u68C0\u67E5\u662F\u5426\u5B58\u6D3B\n  if (!general.is_alive) {\n    return { success: false, error: \"\u6B66\u5C06\u5DF2\u9635\u4EA1\" };\n  }\n  \n  // \u8BA1\u7B97\u8DEF\u5F84\n  const path = findPath(general, target, gameState);\n  if (!path) {\n    return { success: false, error: \"\u76EE\u6807\u4F4D\u7F6E\u4E0D\u53EF\u8FBE\" };\n  }\n  \n  // \u8BA1\u7B97\u5B9E\u9645\u79FB\u52A8\u8DDD\u79BB\n  const moveArea = getMoveableArea(general, gameState);\n  const targetKey = posKey(target);\n  \n  if (!moveArea.costs.has(targetKey)) {\n    return { success: false, error: \"\u76EE\u6807\u8D85\u51FA\u79FB\u52A8\u8303\u56F4\" };\n  }\n  \n  // \u6267\u884C\u79FB\u52A8\n  const startPos = { ...general.position };\n  general.position = target;\n  \n  // \u8BB0\u5F55\u79FB\u52A8\u8DDD\u79BB\uFF08\u7528\u4E8E\u9A6C\u8D85\u94C1\u9A91\u6280\u80FD\uFF09\n  general.moved_distance = (general.moved_distance || 0) + manhattanDistance(startPos, target);\n  \n  // \u66F4\u65B0\u9762\u671D\u65B9\u5411\n  if (path.length >= 2) {\n    const lastMove = path[path.length - 1];\n    const secondLast = path[path.length - 2];\n    updateFacingFromMove(general, secondLast, lastMove);\n  }\n  \n  return { success: true, path };\n}\n\n// \u8D75\u4E91\u9F99\u80C6\u989D\u5916\u79FB\u52A8\nexport function executeExtraMove(\n  general: BattleGeneral,\n  target: Position,\n  gameState: GameState\n): { success: boolean; path?: Position[]; error?: string } {\n  // \u68C0\u67E5\u662F\u5426\u6709\u989D\u5916\u79FB\u52A8\u673A\u4F1A\n  const extraMove = general.skill_state.extra_move;\n  if (!extraMove || extraMove <= 0) {\n    return { success: false, error: \"\u6CA1\u6709\u989D\u5916\u79FB\u52A8\u673A\u4F1A\" };\n  }\n  \n  // \u4E34\u65F6\u589E\u52A0\u79FB\u52A8\u529B\n  const originalMod = general.mov_modifier;\n  general.mov_modifier = extraMove - (getGeneralById(general.general_id)?.base_mov || 0);\n  \n  const path = findPath(general, target, gameState);\n  \n  // \u6062\u590D\u539F\u59CB\u79FB\u52A8\u529B\n  general.mov_modifier = originalMod;\n  \n  if (!path) {\n    return { success: false, error: \"\u76EE\u6807\u4F4D\u7F6E\u4E0D\u53EF\u8FBE\" };\n  }\n  \n  const distance = manhattanDistance(general.position, target);\n  if (distance > extraMove) {\n    return { success: false, error: \"\u8D85\u51FA\u989D\u5916\u79FB\u52A8\u8DDD\u79BB\" };\n  }\n  \n  // \u6267\u884C\u79FB\u52A8\n  general.position = target;\n  general.skill_state.extra_move = 0;\n  \n  return { success: true, path };\n}\n\n// \u6839\u636E\u79FB\u52A8\u65B9\u5411\u66F4\u65B0\u9762\u671D\nfunction updateFacingFromMove(general: BattleGeneral, from: Position, to: Position): void {\n  const dx = to.x - from.x;\n  const dy = to.y - from.y;\n  \n  if (dx > 0) general.facing = \"right\";\n  else if (dx < 0) general.facing = \"left\";\n  else if (dy > 0) general.facing = \"down\";\n  else if (dy < 0) general.facing = \"up\";\n}\n\n// \u83B7\u53D6\u6240\u6709\u88AB\u5360\u7528\u7684\u4F4D\u7F6E\nfunction getOccupiedPositions(gameState: GameState, excludeId?: string): Set<string> {\n  const positions = new Set<string>();\n  \n  for (const general of [...gameState.p1_generals, ...gameState.p2_generals]) {\n    if (!general.is_alive) continue;\n    if (excludeId && general.instance_id === excludeId) continue;\n    positions.add(posKey(general.position));\n  }\n  \n  return positions;\n}\n\n// \u83B7\u53D6\u654C\u65B9\u4F4D\u7F6E\nfunction getEnemyPositions(myOwner: string, gameState: GameState): Set<string> {\n  const enemies = myOwner === \"p1\" ? gameState.p2_generals : gameState.p1_generals;\n  const positions = new Set<string>();\n  \n  for (const enemy of enemies) {\n    if (enemy.is_alive) {\n      positions.add(posKey(enemy.position));\n    }\n  }\n  \n  return positions;\n}\n\n// \u4F4D\u7F6E\u952E\u503C\nfunction posKey(pos: Position): string {\n  return `${pos.x},${pos.y}`;\n}\n\n// \u68C0\u67E5\u4F4D\u7F6E\u662F\u5426\u53EF\u4EE5\u79FB\u52A8\u5230\nexport function canMoveTo(\n  general: BattleGeneral,\n  target: Position,\n  gameState: GameState\n): { canMove: boolean; reason?: string } {\n  if (!general.is_alive) {\n    return { canMove: false, reason: \"\u6B66\u5C06\u5DF2\u9635\u4EA1\" };\n  }\n  \n  if (general.has_acted) {\n    return { canMove: false, reason: \"\u6B66\u5C06\u5DF2\u884C\u52A8\" };\n  }\n  \n  if (!isPassable(target.x, target.y)) {\n    return { canMove: false, reason: \"\u76EE\u6807\u4F4D\u7F6E\u4E0D\u53EF\u901A\u884C\" };\n  }\n  \n  // \u68C0\u67E5\u662F\u5426\u88AB\u5360\u7528\n  const occupiedPositions = getOccupiedPositions(gameState, general.instance_id);\n  if (occupiedPositions.has(posKey(target))) {\n    return { canMove: false, reason: \"\u76EE\u6807\u4F4D\u7F6E\u5DF2\u88AB\u5360\u7528\" };\n  }\n  \n  // \u68C0\u67E5\u662F\u5426\u5728\u79FB\u52A8\u8303\u56F4\u5185\n  const moveArea = getMoveableArea(general, gameState);\n  if (!moveArea.costs.has(posKey(target))) {\n    return { canMove: false, reason: \"\u76EE\u6807\u8D85\u51FA\u79FB\u52A8\u8303\u56F4\" };\n  }\n  \n  return { canMove: true };\n}\n\n// \u83B7\u53D6\u6709\u6548\u79FB\u52A8\u529B\nexport function getEffectiveMovement(general: BattleGeneral): number {\n  const data = getGeneralById(general.general_id);\n  if (!data) return 0;\n  return data.base_mov + general.mov_modifier;\n}\n", "import { BattleGeneral, GameState, Position, PlayerSide } from \"../types\";\nimport { getGeneralById } from \"../data/generals\";\nimport { getTerrain, manhattanDistance, isInArea, CITY_AREA } from \"../data/map\";\n\n// \u89C6\u91CE\u914D\u7F6E\nconst BASE_VISION_RANGE = 5; // \u57FA\u7840\u89C6\u91CE\u8303\u56F4\nconst FOREST_VISION_PENALTY = 2; // \u6811\u6797\u51CF\u5C11\u89C6\u91CE\nconst MOUNTAIN_VISION_BONUS = 2; // \u5C71\u5730\u589E\u52A0\u89C6\u91CE\nconst CITY_VISION_BONUS = 3; // \u57CE\u6C60\u589E\u52A0\u89C6\u91CE\n\n// \u8BA1\u7B97\u6B66\u5C06\u7684\u89C6\u91CE\u8303\u56F4\nexport function getVisionRange(general: BattleGeneral): number {\n  const data = getGeneralById(general.general_id);\n  if (!data) return BASE_VISION_RANGE;\n  \n  let range = BASE_VISION_RANGE;\n  \n  // \u6839\u636E\u6B66\u5C06\u7C7B\u578B\u8C03\u6574\n  switch (data.type) {\n    case \"\u5F13\u624B\":\n      range += 2; // \u5F13\u624B\u89C6\u91CE\u66F4\u8FDC\n      break;\n    case \"\u8C0B\u58EB\":\n      range += 1; // \u8C0B\u58EB\u89C6\u91CE\u7A0D\u8FDC\n      break;\n    case \"\u9A91\u5175\":\n      range += 1; // \u9A91\u5175\u89C6\u91CE\u7A0D\u8FDC\n      break;\n  }\n  \n  // \u6839\u636E\u5F53\u524D\u5730\u5F62\u8C03\u6574\n  const terrain = getTerrain(general.position.x, general.position.y);\n  switch (terrain.type) {\n    case \"mountain\":\n      range += MOUNTAIN_VISION_BONUS;\n      break;\n    case \"city\":\n      range += CITY_VISION_BONUS;\n      break;\n    case \"forest\":\n      // \u5728\u6811\u6797\u4E2D\u4E0D\u51CF\u5C11\u81EA\u5DF1\u7684\u89C6\u91CE\uFF0C\u53EA\u5F71\u54CD\u88AB\u53D1\u73B0\n      break;\n  }\n  \n  return range;\n}\n\n// \u68C0\u67E5\u4F4D\u7F6E\u662F\u5426\u5728\u89C6\u91CE\u5185\nexport function isInVision(\n  observer: BattleGeneral,\n  target: Position,\n  gameState: GameState\n): boolean {\n  const visionRange = getVisionRange(observer);\n  const distance = manhattanDistance(observer.position, target);\n  \n  // \u57FA\u7840\u8DDD\u79BB\u68C0\u67E5\n  if (distance > visionRange) {\n    return false;\n  }\n  \n  // \u68C0\u67E5\u76EE\u6807\u5730\u5F62\u662F\u5426\u63D0\u4F9B\u9690\u853D\n  const targetTerrain = getTerrain(target.x, target.y);\n  if (targetTerrain.type === \"forest\") {\n    // \u6811\u6797\u4E2D\u7684\u5355\u4F4D\u66F4\u96BE\u88AB\u53D1\u73B0\uFF0C\u9700\u8981\u66F4\u8FD1\u7684\u8DDD\u79BB\n    return distance <= visionRange - FOREST_VISION_PENALTY;\n  }\n  \n  return true;\n}\n\n// \u83B7\u53D6\u73A9\u5BB6\u53EF\u89C1\u7684\u654C\u65B9\u5355\u4F4D\nexport function getVisibleEnemies(\n  player: PlayerSide,\n  gameState: GameState\n): BattleGeneral[] {\n  const myGenerals = player === \"p1\" ? gameState.p1_generals : gameState.p2_generals;\n  const enemyGenerals = player === \"p1\" ? gameState.p2_generals : gameState.p1_generals;\n  \n  const visibleEnemies: BattleGeneral[] = [];\n  \n  for (const enemy of enemyGenerals) {\n    if (!enemy.is_alive) continue;\n    \n    // \u68C0\u67E5\u662F\u5426\u88AB\u4EFB\u4F55\u53CB\u519B\u770B\u5230\n    let isVisible = false;\n    for (const ally of myGenerals) {\n      if (!ally.is_alive) continue;\n      if (isInVision(ally, enemy.position, gameState)) {\n        isVisible = true;\n        break;\n      }\n    }\n    \n    if (isVisible) {\n      visibleEnemies.push(enemy);\n    }\n  }\n  \n  return visibleEnemies;\n}\n\n// \u83B7\u53D6\u73A9\u5BB6\u7684\u5B8C\u6574\u89C6\u91CE\u533A\u57DF\nexport function getPlayerVisionArea(\n  player: PlayerSide,\n  gameState: GameState\n): Set<string> {\n  const myGenerals = player === \"p1\" ? gameState.p1_generals : gameState.p2_generals;\n  const visibleArea = new Set<string>();\n  \n  for (const general of myGenerals) {\n    if (!general.is_alive) continue;\n    \n    const visionRange = getVisionRange(general);\n    const positions = getVisiblePositionsFrom(general.position, visionRange);\n    \n    for (const pos of positions) {\n      visibleArea.add(`${pos.x},${pos.y}`);\n    }\n  }\n  \n  // \u57CE\u6C60\u533A\u57DF\u59CB\u7EC8\u53EF\u89C1\uFF08\u5982\u679C\u63A7\u5236\u57CE\u6C60\uFF09\n  if (gameState.city_holder === player) {\n    for (let x = CITY_AREA.x1; x <= CITY_AREA.x2; x++) {\n      for (let y = CITY_AREA.y1; y <= CITY_AREA.y2; y++) {\n        visibleArea.add(`${x},${y}`);\n      }\n    }\n  }\n  \n  return visibleArea;\n}\n\n// \u4ECE\u67D0\u4E2A\u4F4D\u7F6E\u83B7\u53D6\u6240\u6709\u53EF\u89C1\u4F4D\u7F6E\nfunction getVisiblePositionsFrom(center: Position, range: number): Position[] {\n  const positions: Position[] = [];\n  \n  for (let dx = -range; dx <= range; dx++) {\n    for (let dy = -range; dy <= range; dy++) {\n      const x = center.x + dx;\n      const y = center.y + dy;\n      \n      // \u8FB9\u754C\u68C0\u67E5\n      if (x < 0 || x >= 100 || y < 0 || y >= 100) continue;\n      \n      // \u66FC\u54C8\u987F\u8DDD\u79BB\u68C0\u67E5\n      if (Math.abs(dx) + Math.abs(dy) > range) continue;\n      \n      positions.push({ x, y });\n    }\n  }\n  \n  return positions;\n}\n\n// \u8FC7\u6EE4\u6E38\u620F\u72B6\u6001\uFF0C\u53EA\u5305\u542B\u73A9\u5BB6\u53EF\u89C1\u7684\u4FE1\u606F\nexport function filterGameStateForPlayer(\n  gameState: GameState,\n  player: PlayerSide\n): Partial<GameState> {\n  const visibleEnemies = getVisibleEnemies(player, gameState);\n  const myGenerals = player === \"p1\" ? gameState.p1_generals : gameState.p2_generals;\n  const enemyGenerals = player === \"p1\" ? gameState.p2_generals : gameState.p1_generals;\n  \n  // \u521B\u5EFA\u8FC7\u6EE4\u540E\u7684\u654C\u65B9\u6B66\u5C06\u5217\u8868\uFF08\u53EA\u5305\u542B\u53EF\u89C1\u7684\uFF09\n  const filteredEnemies = enemyGenerals.map(enemy => {\n    const isVisible = visibleEnemies.some(v => v.instance_id === enemy.instance_id);\n    \n    if (isVisible) {\n      // \u53EF\u89C1\u654C\u4EBA\uFF1A\u8FD4\u56DE\u57FA\u672C\u4FE1\u606F\uFF08\u4E0D\u542B\u6280\u80FD\u72B6\u6001\u7B49\u654F\u611F\u4FE1\u606F\uFF09\n      return {\n        ...enemy,\n        skill_state: {}, // \u9690\u85CF\u6280\u80FD\u72B6\u6001\n        buffs: enemy.buffs.filter(b => b.type !== \"burn\" || true), // \u707C\u70E7\u53EF\u89C1\n      };\n    } else {\n      // \u4E0D\u53EF\u89C1\u654C\u4EBA\uFF1A\u8FD4\u56DEnull\u6216\u9690\u85CF\u4F4D\u7F6E\n      return null;\n    }\n  }).filter(e => e !== null) as BattleGeneral[];\n  \n  return {\n    ...gameState,\n    p1_generals: player === \"p1\" ? myGenerals : filteredEnemies,\n    p2_generals: player === \"p2\" ? myGenerals : filteredEnemies,\n  };\n}\n\n// \u90ED\u5609\u9B3C\u624D\u6280\u80FD - \u83B7\u53D6\u89C6\u91CE\u8303\u56F4\u5185\u654C\u4EBA\u7684\u4FE1\u606F\nexport function getEnhancedVisionInfo(\n  guojia: BattleGeneral,\n  gameState: GameState\n): { enemy: BattleGeneral; detailedInfo: boolean }[] {\n  const data = getGeneralById(guojia.general_id);\n  if (data?.skill_name !== \"\u9B3C\u624D\") return [];\n  \n  const enemies = guojia.owner === \"p1\" ? gameState.p2_generals : gameState.p1_generals;\n  const result: { enemy: BattleGeneral; detailedInfo: boolean }[] = [];\n  \n  for (const enemy of enemies) {\n    if (!enemy.is_alive) continue;\n    \n    const distance = manhattanDistance(guojia.position, enemy.position);\n    \n    // 5\u683C\u8303\u56F4\u5185\u53EF\u4EE5\u770B\u5230\u8BE6\u7EC6\u4FE1\u606F\n    if (distance <= 5) {\n      result.push({ enemy, detailedInfo: true });\n    } else if (isInVision(guojia, enemy.position, gameState)) {\n      result.push({ enemy, detailedInfo: false });\n    }\n  }\n  \n  return result;\n}\n\n// \u68C0\u67E5\u662F\u5426\u6709\u4EFB\u4F55\u654C\u4EBA\u5728\u67D0\u4E2A\u4F4D\u7F6E\u7684\u89C6\u91CE\u5185\nexport function isPositionObservedByEnemy(\n  position: Position,\n  myOwner: PlayerSide,\n  gameState: GameState\n): boolean {\n  const enemies = myOwner === \"p1\" ? gameState.p2_generals : gameState.p1_generals;\n  \n  for (const enemy of enemies) {\n    if (!enemy.is_alive) continue;\n    if (isInVision(enemy, position, gameState)) {\n      return true;\n    }\n  }\n  \n  return false;\n}\n\n// \u83B7\u53D6\u5B89\u5168\u79FB\u52A8\u4F4D\u7F6E\uFF08\u4E0D\u5728\u654C\u65B9\u89C6\u91CE\u5185\uFF09\nexport function getSafePositions(\n  general: BattleGeneral,\n  moveablePositions: Position[],\n  gameState: GameState\n): Position[] {\n  return moveablePositions.filter(pos => \n    !isPositionObservedByEnemy(pos, general.owner, gameState)\n  );\n}\n\n// \u8BA1\u7B97\u89C6\u91CE\u8986\u76D6\u7EDF\u8BA1\nexport function getVisionCoverageStats(\n  player: PlayerSide,\n  gameState: GameState\n): { total: number; percentage: number } {\n  const visionArea = getPlayerVisionArea(player, gameState);\n  const total = visionArea.size;\n  const percentage = (total / 10000) * 100; // 100x100 = 10000\n  \n  return { total, percentage };\n}\n", "import { Env, PlayerSide } from \"../types\";\nimport { executeQuery, queries } from \"../db/tidb\";\n\n// \u8BA4\u8BC1\u4E2D\u95F4\u4EF6\nexport async function authMiddleware(\n  request: Request,\n  env: Env\n): Promise<{ authorized: boolean; agentId?: string; error?: Response }> {\n  // \u83B7\u53D6 Authorization header\n  const authHeader = request.headers.get(\"Authorization\");\n  \n  if (!authHeader) {\n    return {\n      authorized: false,\n      error: Response.json(\n        { success: false, error: { code: 401, message: \"\u7F3A\u5C11\u8BA4\u8BC1\u4FE1\u606F\" } },\n        { status: 401 }\n      ),\n    };\n  }\n  \n  // \u89E3\u6790 Bearer token\n  const parts = authHeader.split(\" \");\n  if (parts.length !== 2 || parts[0].toLowerCase() !== \"bearer\") {\n    return {\n      authorized: false,\n      error: Response.json(\n        { success: false, error: { code: 401, message: \"\u8BA4\u8BC1\u683C\u5F0F\u9519\u8BEF\" } },\n        { status: 401 }\n      ),\n    };\n  }\n  \n  const apiKey = parts[1];\n  \n  // \u8BA1\u7B97 API Key \u54C8\u5E0C\n  const apiKeyHash = await hashApiKey(apiKey);\n  \n  try {\n    // \u67E5\u8BE2\u6570\u636E\u5E93\u9A8C\u8BC1\n    const agents = await executeQuery<{ id: string; name: string }>(\n      env,\n      queries.getAgentByApiKeyHash,\n      [apiKeyHash]\n    );\n    \n    if (agents.length === 0) {\n      return {\n        authorized: false,\n        error: Response.json(\n          { success: false, error: { code: 401, message: \"\u65E0\u6548\u7684API Key\" } },\n          { status: 401 }\n        ),\n      };\n    }\n    \n    return {\n      authorized: true,\n      agentId: agents[0].id,\n    };\n  } catch (error) {\n    console.error(\"Auth error:\", error);\n    \n    // \u5F00\u53D1\u73AF\u5883\u4E0B\u5141\u8BB8\u8DF3\u8FC7\u8BA4\u8BC1\n    if (env.ENVIRONMENT === \"development\" || !env.TIDB_HOST) {\n      // \u4F7F\u7528 API Key \u4F5C\u4E3A agent_id\uFF08\u5F00\u53D1\u6A21\u5F0F\uFF09\n      return {\n        authorized: true,\n        agentId: apiKey,\n      };\n    }\n    \n    return {\n      authorized: false,\n      error: Response.json(\n        { success: false, error: { code: 500, message: \"\u8BA4\u8BC1\u670D\u52A1\u9519\u8BEF\" } },\n        { status: 500 }\n      ),\n    };\n  }\n}\n\n// \u8BA1\u7B97 API Key \u54C8\u5E0C\nasync function hashApiKey(apiKey: string): Promise<string> {\n  const encoder = new TextEncoder();\n  const data = encoder.encode(apiKey);\n  const hashBuffer = await crypto.subtle.digest(\"SHA-256\", data);\n  const hashArray = Array.from(new Uint8Array(hashBuffer));\n  return hashArray.map(b => b.toString(16).padStart(2, \"0\")).join(\"\");\n}\n\n// \u4ECE\u8BF7\u6C42\u4E2D\u63D0\u53D6\u6E38\u620FID\nexport function extractGameId(pathname: string): string | null {\n  const match = pathname.match(/\\/api\\/games\\/([^\\/]+)/);\n  return match ? match[1] : null;\n}\n\n// \u4ECE\u8BF7\u6C42\u4E2D\u63D0\u53D6\u73A9\u5BB6\u8EAB\u4EFD\nexport function extractPlayer(request: Request, pathname: string): PlayerSide | null {\n  // \u4ECE\u67E5\u8BE2\u53C2\u6570\u83B7\u53D6\n  const url = new URL(request.url);\n  const player = url.searchParams.get(\"player\");\n  \n  if (player === \"p1\" || player === \"p2\") {\n    return player;\n  }\n  \n  return null;\n}\n\n// \u9A8C\u8BC1\u73A9\u5BB6\u662F\u5426\u5C5E\u4E8E\u8BE5\u6E38\u620F\nexport async function validatePlayerInGame(\n  env: Env,\n  gameId: string,\n  agentId: string\n): Promise<{ valid: boolean; player?: PlayerSide; error?: Response }> {\n  try {\n    const games = await executeQuery<{\n      p1_agent_id: string;\n      p2_agent_id: string;\n    }>(env, queries.getGame, [gameId]);\n    \n    if (games.length === 0) {\n      return {\n        valid: false,\n        error: Response.json(\n          { success: false, error: { code: 1001, message: \"\u6E38\u620F\u4E0D\u5B58\u5728\" } },\n          { status: 404 }\n        ),\n      };\n    }\n    \n    const game = games[0];\n    \n    if (game.p1_agent_id === agentId) {\n      return { valid: true, player: \"p1\" };\n    }\n    \n    if (game.p2_agent_id === agentId) {\n      return { valid: true, player: \"p2\" };\n    }\n    \n    return {\n      valid: false,\n      error: Response.json(\n        { success: false, error: { code: 403, message: \"\u60A8\u4E0D\u662F\u8BE5\u6E38\u620F\u7684\u53C2\u4E0E\u8005\" } },\n        { status: 403 }\n      ),\n    };\n  } catch (error) {\n    console.error(\"Validate player error:\", error);\n    \n    // \u5F00\u53D1\u73AF\u5883\u4E0B\u9ED8\u8BA4\u5141\u8BB8\n    if (env.ENVIRONMENT === \"development\" || !env.TIDB_HOST) {\n      // \u6839\u636EagentId\u63A8\u65AD\u73A9\u5BB6\uFF08\u7B80\u5355\u5904\u7406\uFF09\n      return { valid: true, player: \"p1\" };\n    }\n    \n    return {\n      valid: false,\n      error: Response.json(\n        { success: false, error: { code: 500, message: \"\u9A8C\u8BC1\u670D\u52A1\u9519\u8BEF\" } },\n        { status: 500 }\n      ),\n    };\n  }\n}\n\n// \u521B\u5EFA\u65B0Agent\nexport async function createAgent(\n  env: Env,\n  name: string,\n  apiKey: string\n): Promise<{ success: boolean; agentId?: string; error?: string }> {\n  try {\n    const agentId = crypto.randomUUID();\n    const apiKeyHash = await hashApiKey(apiKey);\n    \n    await executeQuery(env, queries.createAgent, [agentId, name, apiKeyHash]);\n    \n    return { success: true, agentId };\n  } catch (error) {\n    console.error(\"Create agent error:\", error);\n    return { success: false, error: String(error) };\n  }\n}\n\n// \u7B80\u5355\u7684\u5F00\u53D1\u6A21\u5F0F\u8BA4\u8BC1\uFF08\u7528\u4E8E\u6D4B\u8BD5\uFF09\nexport function devModeAuth(request: Request): { agentId: string } {\n  const authHeader = request.headers.get(\"Authorization\");\n  \n  if (authHeader) {\n    const parts = authHeader.split(\" \");\n    if (parts.length === 2) {\n      return { agentId: parts[1] };\n    }\n  }\n  \n  // \u9ED8\u8BA4\u6D4B\u8BD5\u7528\u6237\n  return { agentId: \"test-agent-1\" };\n}\n", "import { connect, Connection } from \"@tidbcloud/serverless\";\nimport { Env } from \"../types\";\n\n// \u521B\u5EFATiDB\u5BA2\u6237\u7AEF\nexport function createTiDBClient(env: Env): Connection {\n  return connect({\n    host: env.TIDB_HOST,\n    username: env.TIDB_USER,\n    password: env.TIDB_PASSWORD,\n    database: env.TIDB_DATABASE,\n  });\n}\n\n// \u6267\u884C\u67E5\u8BE2\nexport async function executeQuery<T>(\n  env: Env,\n  sql: string,\n  params?: any[]\n): Promise<T[]> {\n  const client = createTiDBClient(env);\n  const result = await client.execute(sql, params);\n  // Handle both array and FullResult types\n  if (Array.isArray(result)) {\n    return result as T[];\n  }\n  return ((result as any).rows || []) as T[];\n}\n\n// \u6267\u884C\u5355\u6761\u63D2\u5165/\u66F4\u65B0/\u5220\u9664\nexport async function executeUpdate(\n  env: Env,\n  sql: string,\n  params?: any[]\n): Promise<{ affectedRows: number }> {\n  const client = createTiDBClient(env);\n  const result = await client.execute(sql, params);\n  // Handle both array and FullResult types\n  if (Array.isArray(result)) {\n    return { affectedRows: 0 };\n  }\n  return { affectedRows: (result as any).rowsAffected || 0 };\n}\n\n// SQL\u67E5\u8BE2\u5B9A\u4E49\nexport const queries = {\n  // ===== Agent\u76F8\u5173 =====\n  \n  // \u521B\u5EFAAgent\n  createAgent: `\n    INSERT INTO agents (id, name, api_key_hash, elo_rating, games_played, games_won, created_at, updated_at)\n    VALUES (?, ?, ?, 1200, 0, 0, NOW(), NOW())\n  `,\n  \n  // \u6839\u636EAPI Key Hash\u83B7\u53D6Agent\n  getAgentByApiKeyHash: `\n    SELECT id, name, elo_rating, games_played, games_won, created_at\n    FROM agents\n    WHERE api_key_hash = ?\n  `,\n  \n  // \u6839\u636EID\u83B7\u53D6Agent\n  getAgentById: `\n    SELECT id, name, elo_rating, games_played, games_won, created_at\n    FROM agents\n    WHERE id = ?\n  `,\n  \n  // \u66F4\u65B0ELO\u8BC4\u5206\n  updateElo: `\n    UPDATE agents \n    SET elo_rating = elo_rating + ?,\n        games_played = games_played + 1,\n        games_won = games_won + ?,\n        updated_at = NOW()\n    WHERE id = ?\n  `,\n\n  // ===== \u6E38\u620F\u76F8\u5173 =====\n  \n  // \u521B\u5EFA\u6E38\u620F\n  createGame: `\n    INSERT INTO games (id, p1_agent_id, status, created_at)\n    VALUES (?, ?, 'waiting', NOW())\n  `,\n  \n  // \u52A0\u5165\u6E38\u620F\n  joinGame: `\n    UPDATE games \n    SET p2_agent_id = ?, status = 'selecting', started_at = NOW()\n    WHERE id = ? AND status = 'waiting' AND p2_agent_id IS NULL\n  `,\n  \n  // \u66F4\u65B0\u6E38\u620F\u72B6\u6001\n  updateGameStatus: `\n    UPDATE games\n    SET status = ?\n    WHERE id = ?\n  `,\n  \n  // \u5B8C\u6210\u6E38\u620F\n  finishGame: `\n    UPDATE games \n    SET status = 'finished', \n        winner = ?, \n        win_reason = ?,\n        total_turns = ?,\n        final_state = ?,\n        finished_at = NOW()\n    WHERE id = ?\n  `,\n  \n  // \u83B7\u53D6\u6E38\u620F\u4FE1\u606F\n  getGame: `\n    SELECT g.*, \n           a1.name as p1_name, a1.elo_rating as p1_elo,\n           a2.name as p2_name, a2.elo_rating as p2_elo\n    FROM games g\n    LEFT JOIN agents a1 ON g.p1_agent_id = a1.id\n    LEFT JOIN agents a2 ON g.p2_agent_id = a2.id\n    WHERE g.id = ?\n  `,\n  \n  // \u83B7\u53D6\u7B49\u5F85\u4E2D\u7684\u6E38\u620F\u5217\u8868\n  getWaitingGames: `\n    SELECT g.id, g.p1_agent_id, g.created_at,\n           a.name as p1_name, a.elo_rating as p1_elo\n    FROM games g\n    LEFT JOIN agents a ON g.p1_agent_id = a.id\n    WHERE g.status = 'waiting'\n    ORDER BY g.created_at ASC\n    LIMIT ?\n  `,\n  \n  // \u4FDD\u5B58\u6B66\u5C06\u9009\u62E9\n  saveGeneralPicks: `\n    UPDATE games\n    SET p1_generals = ?, p2_generals = ?, banned_generals = ?\n    WHERE id = ?\n  `,\n\n  // ===== \u64CD\u4F5C\u65E5\u5FD7 =====\n  \n  // \u8BB0\u5F55\u64CD\u4F5C\u65E5\u5FD7\n  logAction: `\n    INSERT INTO action_logs (game_id, turn, player, action_type, action_data, result, created_at)\n    VALUES (?, ?, ?, ?, ?, ?, NOW())\n  `,\n  \n  // \u83B7\u53D6\u6E38\u620F\u64CD\u4F5C\u65E5\u5FD7\uFF08\u7528\u4E8E\u56DE\u653E\uFF09\n  getActionLogs: `\n    SELECT turn, player, action_type, action_data, result, created_at\n    FROM action_logs\n    WHERE game_id = ?\n    ORDER BY id ASC\n  `,\n\n  // ===== \u6392\u884C\u699C =====\n  \n  // \u83B7\u53D6\u6392\u884C\u699C\n  getLeaderboard: `\n    SELECT id, name, elo_rating, games_played, games_won,\n           ROUND(games_won * 100.0 / NULLIF(games_played, 0), 1) as win_rate\n    FROM agents\n    WHERE games_played > 0\n    ORDER BY elo_rating DESC\n    LIMIT ?\n  `,\n  \n  // \u83B7\u53D6\u5BF9\u5C40\u5386\u53F2\n  getGameHistory: `\n    SELECT g.id, g.status, g.winner, g.win_reason, g.total_turns, \n           g.started_at, g.finished_at,\n           a1.name as p1_name, a2.name as p2_name\n    FROM games g\n    LEFT JOIN agents a1 ON g.p1_agent_id = a1.id\n    LEFT JOIN agents a2 ON g.p2_agent_id = a2.id\n    WHERE g.p1_agent_id = ? OR g.p2_agent_id = ?\n    ORDER BY g.created_at DESC\n    LIMIT ?\n  `,\n  \n  // \u4FDD\u5B58\u6BCF\u65E5\u6392\u884C\u699C\u5FEB\u7167\n  saveDailyLeaderboard: `\n    INSERT INTO leaderboard_daily (date, agent_id, elo_rating, rank_position, games_today, wins_today)\n    VALUES (CURDATE(), ?, ?, ?, ?, ?)\n    ON DUPLICATE KEY UPDATE\n      elo_rating = VALUES(elo_rating),\n      rank_position = VALUES(rank_position),\n      games_today = VALUES(games_today),\n      wins_today = VALUES(wins_today)\n  `,\n\n  // ===== \u6B66\u5C06\u7EDF\u8BA1 =====\n  \n  // \u66F4\u65B0\u6B66\u5C06\u7EDF\u8BA1\n  updateGeneralStats: `\n    INSERT INTO general_stats (general_id, total_picks, total_wins, total_bans)\n    VALUES (?, 1, ?, 0)\n    ON DUPLICATE KEY UPDATE\n      total_picks = total_picks + 1,\n      total_wins = total_wins + VALUES(total_wins),\n      updated_at = NOW()\n  `,\n  \n  // \u66F4\u65B0\u6B66\u5C06Ban\u7EDF\u8BA1\n  updateGeneralBanStats: `\n    INSERT INTO general_stats (general_id, total_picks, total_wins, total_bans)\n    VALUES (?, 0, 0, 1)\n    ON DUPLICATE KEY UPDATE\n      total_bans = total_bans + 1,\n      updated_at = NOW()\n  `,\n  \n  // \u83B7\u53D6\u6B66\u5C06\u7EDF\u8BA1\n  getGeneralStats: `\n    SELECT general_id, total_picks, total_wins, total_bans,\n           ROUND(total_wins * 100.0 / NULLIF(total_picks, 0), 1) as win_rate\n    FROM general_stats\n    ORDER BY total_picks DESC\n  `,\n};\n\n// GameDatabase \u7C7B\u5C01\u88C5\nexport class GameDatabase {\n  constructor(private env: Env) {}\n\n  async createGame(gameId: string, agentId: string): Promise<void> {\n    await executeUpdate(this.env, queries.createGame, [gameId, agentId]);\n  }\n\n  async joinGame(gameId: string, agentId: string): Promise<void> {\n    await executeUpdate(this.env, queries.joinGame, [agentId, gameId]);\n  }\n\n  async getWaitingGame(excludeAgentId: string): Promise<{ id: string } | null> {\n    const games = await executeQuery<{ id: string }>(\n      this.env,\n      `SELECT id FROM games WHERE status = 'waiting' AND p1_agent_id != ? ORDER BY created_at ASC LIMIT 1`,\n      [excludeAgentId]\n    );\n    return games[0] || null;\n  }\n\n  async getGame(gameId: string): Promise<any> {\n    const games = await executeQuery(this.env, queries.getGame, [gameId]);\n    return games[0] || null;\n  }\n\n  async finishGame(gameId: string, winner: string, winReason: string, totalTurns: number, finalState: any): Promise<void> {\n    await executeUpdate(this.env, queries.finishGame, [winner, winReason, totalTurns, JSON.stringify(finalState), gameId]);\n  }\n\n  async updateElo(agentId: string, eloChange: number, won: boolean): Promise<void> {\n    await executeUpdate(this.env, queries.updateElo, [eloChange, won ? 1 : 0, agentId]);\n  }\n\n  async getLeaderboard(limit: number = 50): Promise<any[]> {\n    return executeQuery(this.env, queries.getLeaderboard, [limit]);\n  }\n\n  async getGameHistory(agentId: string, limit: number = 20): Promise<any[]> {\n    return executeQuery(this.env, queries.getGameHistory, [agentId, agentId, limit]);\n  }\n\n  async logAction(gameId: string, turn: number, player: string, actionType: string, actionData: any, result: any): Promise<void> {\n    await executeUpdate(this.env, queries.logAction, [gameId, turn, player, actionType, JSON.stringify(actionData), JSON.stringify(result)]);\n  }\n\n  async getAgentByApiKeyHash(hash: string): Promise<any> {\n    const agents = await executeQuery(this.env, queries.getAgentByApiKeyHash, [hash]);\n    return agents[0] || null;\n  }\n\n  async createAgent(id: string, name: string, apiKeyHash: string): Promise<void> {\n    await executeUpdate(this.env, queries.createAgent, [id, name, apiKeyHash]);\n  }\n}\n\n// ELO\u8BA1\u7B97\nexport function calculateEloChange(\n  winnerElo: number,\n  loserElo: number,\n  kFactor: number = 32\n): { winnerChange: number; loserChange: number } {\n  const expectedWinner = 1 / (1 + Math.pow(10, (loserElo - winnerElo) / 400));\n  const expectedLoser = 1 - expectedWinner;\n  \n  const winnerChange = Math.round(kFactor * (1 - expectedWinner));\n  const loserChange = Math.round(kFactor * (0 - expectedLoser));\n  \n  return { winnerChange, loserChange };\n}\n\n// \u6570\u636E\u5E93\u521D\u59CB\u5316SQL\uFF08\u7528\u4E8E\u9996\u6B21\u90E8\u7F72\uFF09\nexport const initSQL = `\n-- \u7528\u6237/Agent \u8868\nCREATE TABLE IF NOT EXISTS agents (\n  id VARCHAR(64) PRIMARY KEY,\n  name VARCHAR(100) NOT NULL,\n  api_key_hash VARCHAR(256) NOT NULL,\n  elo_rating INT DEFAULT 1200,\n  games_played INT DEFAULT 0,\n  games_won INT DEFAULT 0,\n  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n  INDEX idx_elo (elo_rating DESC),\n  INDEX idx_api_key (api_key_hash)\n);\n\n-- \u5BF9\u5C40\u8BB0\u5F55\u8868\nCREATE TABLE IF NOT EXISTS games (\n  id VARCHAR(64) PRIMARY KEY,\n  p1_agent_id VARCHAR(64) NOT NULL,\n  p2_agent_id VARCHAR(64),\n  status ENUM('waiting', 'selecting', 'deploying', 'playing', 'finished') DEFAULT 'waiting',\n  winner ENUM('p1', 'p2', 'draw'),\n  win_reason VARCHAR(100),\n  total_turns INT,\n  p1_generals JSON,\n  p2_generals JSON,\n  banned_generals JSON,\n  final_state JSON,\n  started_at TIMESTAMP,\n  finished_at TIMESTAMP,\n  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n  \n  INDEX idx_p1 (p1_agent_id),\n  INDEX idx_p2 (p2_agent_id),\n  INDEX idx_status (status),\n  INDEX idx_created (created_at DESC)\n);\n\n-- \u64CD\u4F5C\u65E5\u5FD7\u8868\nCREATE TABLE IF NOT EXISTS action_logs (\n  id BIGINT AUTO_INCREMENT PRIMARY KEY,\n  game_id VARCHAR(64) NOT NULL,\n  turn INT NOT NULL,\n  player ENUM('p1', 'p2') NOT NULL,\n  action_type VARCHAR(20) NOT NULL,\n  action_data JSON NOT NULL,\n  result JSON,\n  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n  \n  INDEX idx_game_turn (game_id, turn)\n);\n\n-- \u6392\u884C\u699C\u6BCF\u65E5\u5FEB\u7167\nCREATE TABLE IF NOT EXISTS leaderboard_daily (\n  date DATE NOT NULL,\n  agent_id VARCHAR(64) NOT NULL,\n  elo_rating INT NOT NULL,\n  rank_position INT NOT NULL,\n  games_today INT DEFAULT 0,\n  wins_today INT DEFAULT 0,\n  \n  PRIMARY KEY (date, agent_id),\n  INDEX idx_date_rank (date, rank_position)\n);\n\n-- \u6B66\u5C06\u7EDF\u8BA1\u8868\nCREATE TABLE IF NOT EXISTS general_stats (\n  general_id INT PRIMARY KEY,\n  total_picks INT DEFAULT 0,\n  total_wins INT DEFAULT 0,\n  total_bans INT DEFAULT 0,\n  avg_damage_dealt DECIMAL(10,2) DEFAULT 0,\n  avg_damage_taken DECIMAL(10,2) DEFAULT 0,\n  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP\n);\n`;\n", "// src/format.ts\nfunction format(query, values) {\n  return Array.isArray(values) ? replacePosition(query, values) : replaceNamed(query, values);\n}\nfunction replacePosition(query, values) {\n  let index = 0;\n  return query.replace(/\\?/g, (match) => {\n    return index < values.length ? sanitize(values[index++]) : match;\n  });\n}\nfunction replaceNamed(query, values) {\n  return query.replace(/:(\\w+)/g, (match, name) => {\n    return hasOwn(values, name) ? sanitize(values[name]) : match;\n  });\n}\nfunction hasOwn(obj, name) {\n  return Object.prototype.hasOwnProperty.call(obj, name);\n}\nfunction sanitize(value) {\n  if (value == null) {\n    return \"null\";\n  }\n  if ([\"number\", \"bigint\"].includes(typeof value)) {\n    return String(value);\n  }\n  if (typeof value === \"boolean\") {\n    return value ? \"true\" : \"false\";\n  }\n  if (value instanceof Uint8Array) {\n    return uint8ArrayToHex(value);\n  }\n  if (typeof value === \"string\") {\n    return quote(value);\n  }\n  if (Array.isArray(value)) {\n    return value.map(sanitize).join(\", \");\n  }\n  if (value instanceof Date) {\n    return quote(value.toISOString().replace(\"Z\", \"\"));\n  }\n  return quote(value.toString());\n}\nfunction quote(text) {\n  return `'${escape(text)}'`;\n}\nvar re = /[\\0\\b\\n\\r\\t\\x1a\\\\\"']/g;\nfunction escape(text) {\n  return text.replace(re, replacement);\n}\nfunction replacement(text) {\n  switch (text) {\n    case '\"':\n      return '\\\\\"';\n    case \"'\":\n      return \"\\\\'\";\n    case \"\\n\":\n      return \"\\\\n\";\n    case \"\\r\":\n      return \"\\\\r\";\n    case \"\t\":\n      return \"\\\\t\";\n    case \"\\\\\":\n      return \"\\\\\\\\\";\n    case \"\\0\":\n      return \"\\\\0\";\n    case \"\\b\":\n      return \"\\\\b\";\n    case \"\u001A\":\n      return \"\\\\Z\";\n    default:\n      return \"\";\n  }\n}\nfunction uint8ArrayToHex(uint8) {\n  const digits = Array.from(uint8).map((i) => i.toString(16).padStart(2, \"0\"));\n  return `0x${digits.join(\"\")}`;\n}\n\n// src/decode.ts\nfunction cast(field, value, decoder) {\n  if (value === null) {\n    return null;\n  }\n  if (decoder[field.type]) {\n    return decoder[field.type](value);\n  }\n  switch (field.type) {\n    case \"TINYINT\":\n    case \"UNSIGNED TINYINT\":\n    case \"SMALLINT\":\n    case \"UNSIGNED SMALLINT\":\n    case \"MEDIUMINT\":\n    case \"UNSIGNED MEDIUMINT\":\n    case \"INT\":\n    case \"UNSIGNED INT\":\n    case \"YEAR\":\n      return parseInt(value, 10);\n    case \"FLOAT\":\n    case \"DOUBLE\":\n      return parseFloat(value);\n    case \"BIGINT\":\n    case \"UNSIGNED BIGINT\":\n    case \"DECIMAL\":\n    case \"SET\":\n    case \"ENUM\":\n    case \"CHAR\":\n    case \"VARCHAR\":\n    case \"TEXT\":\n    case \"MEDIUMTEXT\":\n    case \"LONGTEXT\":\n    case \"TINYTEXT\":\n    case \"DATE\":\n    case \"TIME\":\n    case \"DATETIME\":\n    case \"TIMESTAMP\":\n      return value;\n    case \"BLOB\":\n    case \"TINYBLOB\":\n    case \"MEDIUMBLOB\":\n    case \"LONGBLOB\":\n    case \"BINARY\":\n    case \"VARBINARY\":\n    case \"BIT\":\n      return hexToUint8Array(value);\n    case \"JSON\":\n      return JSON.parse(value);\n    default:\n      return value;\n  }\n}\nfunction hexToUint8Array(hexString) {\n  const uint8Array = new Uint8Array(hexString.length / 2);\n  for (let i = 0; i < hexString.length; i += 2) {\n    uint8Array[i / 2] = parseInt(hexString.substring(i, i + 2), 16);\n  }\n  return uint8Array;\n}\n\n// src/error.ts\nvar DatabaseError = class extends Error {\n  constructor(message, status, details) {\n    super(message);\n    this.status = status;\n    this.details = details;\n  }\n};\n\n// src/config.ts\nvar ColumnType = /* @__PURE__ */ ((ColumnType2) => {\n  ColumnType2[\"TINYINT\"] = \"TINYINT\";\n  ColumnType2[\"UNSIGNED_TINYINT\"] = \"UNSIGNED TINYINT\";\n  ColumnType2[\"SMALLINT\"] = \"SMALLINT\";\n  ColumnType2[\"UNSIGNED_SMALLINT\"] = \"UNSIGNED SMALLINT\";\n  ColumnType2[\"MEDIUMINT\"] = \"MEDIUMINT\";\n  ColumnType2[\"UNSIGNED_MEDIUMINT\"] = \"UNSIGNED MEDIUMINT\";\n  ColumnType2[\"INT\"] = \"INT\";\n  ColumnType2[\"UNSIGNED_INT\"] = \"UNSIGNED INT\";\n  ColumnType2[\"YEAR\"] = \"YEAR\";\n  ColumnType2[\"FLOAT\"] = \"FLOAT\";\n  ColumnType2[\"DOUBLE\"] = \"DOUBLE\";\n  ColumnType2[\"BIGINT\"] = \"BIGINT\";\n  ColumnType2[\"UNSIGNED_BIGINT\"] = \"UNSIGNED BIGINT\";\n  ColumnType2[\"DECIMAL\"] = \"DECIMAL\";\n  ColumnType2[\"CHAR\"] = \"CHAR\";\n  ColumnType2[\"VARCHAR\"] = \"VARCHAR\";\n  ColumnType2[\"BINARY\"] = \"BINARY\";\n  ColumnType2[\"VARBINARY\"] = \"VARBINARY\";\n  ColumnType2[\"TINYTEXT\"] = \"TINYTEXT\";\n  ColumnType2[\"TEXT\"] = \"TEXT\";\n  ColumnType2[\"MEDIUMTEXT\"] = \"MEDIUMTEXT\";\n  ColumnType2[\"LONGTEXT\"] = \"LONGTEXT\";\n  ColumnType2[\"TINYBLOB\"] = \"TINYBLOB\";\n  ColumnType2[\"BLOB\"] = \"BLOB\";\n  ColumnType2[\"MEDIUMBLOB\"] = \"MEDIUMBLOB\";\n  ColumnType2[\"LONGBLOB\"] = \"LONGBLOB\";\n  ColumnType2[\"DATE\"] = \"DATE\";\n  ColumnType2[\"TIME\"] = \"TIME\";\n  ColumnType2[\"DATETIME\"] = \"DATETIME\";\n  ColumnType2[\"TIMESTAMP\"] = \"TIMESTAMP\";\n  ColumnType2[\"BIT\"] = \"BIT\";\n  ColumnType2[\"JSON\"] = \"JSON\";\n  return ColumnType2;\n})(ColumnType || {});\n\n// src/version.ts\nvar Version = \"0.2.0\";\n\n// src/serverless.ts\nasync function postQuery(config, body, session = \"\", isolationLevel = null, debug) {\n  let fetchCacheOption = { cache: \"no-store\" };\n  try {\n    new Request(\"x:\", fetchCacheOption);\n  } catch (err) {\n    fetchCacheOption = {};\n  }\n  const requestId = generateUniqueId();\n  if (debug) {\n    console.log(`[serverless-js debug] request id: ${requestId}`);\n  }\n  const url = new URL(\"/v1beta/sql\", `https://http-${config.host}`);\n  const auth = btoa(`${config.username}:${config.password}`);\n  const { fetch: fetch2 } = config;\n  const database = config.database ?? \"\";\n  const headers = {\n    \"Content-Type\": \"application/json\",\n    \"User-Agent\": `serverless-js/${Version}`,\n    Authorization: `Basic ${auth}`,\n    \"TiDB-Database\": database,\n    \"TiDB-Session\": session,\n    \"X-Debug-Trace-Id\": requestId,\n    \"Accept-Encoding\": \"gzip\"\n  };\n  if (isolationLevel) {\n    headers[\"TiDB-Isolation-Level\"] = isolationLevel;\n  }\n  const response = await fetch2(url.toString(), {\n    method: \"POST\",\n    body,\n    headers,\n    ...fetchCacheOption\n  });\n  if (debug) {\n    const traceId = response?.headers?.get(\"X-Debug-Trace-Id\");\n    console.log(`[serverless-js debug] response id: ${traceId}`);\n    const contentEncoding = response?.headers?.get(\"Content-Encoding\");\n    console.log(`[serverless-js debug] Content-Encoding: ${contentEncoding}`);\n  }\n  if (response.ok) {\n    const resp = await response.json();\n    const session2 = response.headers.get(\"TiDB-Session\");\n    resp.session = session2 ?? \"\";\n    return resp;\n  } else {\n    let error;\n    try {\n      const e = await response.json();\n      error = new DatabaseError(e.message, response.status, e);\n    } catch {\n      error = new DatabaseError(response.statusText, response.status, null);\n    }\n    throw error;\n  }\n}\nfunction generateUniqueId() {\n  const datetime = (/* @__PURE__ */ new Date()).toISOString().replace(/[^\\d]/g, \"\").slice(0, 14);\n  return `${datetime}${randomString(20)}`;\n}\nfunction randomString(n) {\n  let result = \"\";\n  const characters = \"abcdefghijklmnopqrstuvwxyz0123456789\";\n  const l = characters.length;\n  for (let i = 0; i < n; i++) {\n    result += characters[Math.floor(Math.random() * l)];\n  }\n  return result;\n}\n\n// src/index.ts\nvar defaultExecuteOptions = {};\nvar Tx = class {\n  constructor(conn) {\n    this.conn = conn;\n  }\n  async execute(query, args = null, options = defaultExecuteOptions, txOptions = {}) {\n    return this.conn.execute(query, args, options, txOptions);\n  }\n  async commit() {\n    return this.conn.execute(\"COMMIT\");\n  }\n  async rollback() {\n    return this.conn.execute(\"ROLLBACK\");\n  }\n};\nvar Connection = class _Connection {\n  constructor(config) {\n    var _a;\n    this.session = null;\n    this.config = { ...config };\n    if (typeof fetch !== \"undefined\") {\n      (_a = this.config).fetch || (_a.fetch = fetch);\n    }\n    if (config.url) {\n      const url = new URL(config.url);\n      if (!this.config.username) {\n        this.config.username = decodeURIComponent(url.username);\n      }\n      if (!this.config.password) {\n        this.config.password = decodeURIComponent(url.password);\n      }\n      if (!this.config.host) {\n        this.config.host = url.hostname;\n      }\n      if (!this.config.database) {\n        this.config.database = decodeURIComponent(url.pathname.slice(1));\n      }\n    }\n  }\n  getConfig() {\n    return this.config;\n  }\n  async begin(txOptions = {}) {\n    const conn = new _Connection(this.config);\n    const tx = new Tx(conn);\n    await tx.execute(\"BEGIN\", void 0, void 0, txOptions);\n    return tx;\n  }\n  async execute(query, args = null, options = defaultExecuteOptions, txOptions = {}) {\n    const sql = args ? format(query, args) : query;\n    const body = JSON.stringify({ query: sql });\n    const debug = options.debug ?? this.config.debug ?? false;\n    if (debug) {\n      console.log(`[serverless-js debug] sql: ${sql}`);\n    }\n    const resp = await postQuery(\n      this.config,\n      body,\n      this.session ?? \"\",\n      sql == \"BEGIN\" ? txOptions.isolation : null,\n      debug\n    );\n    this.session = resp?.session ?? null;\n    if (this.session === null || this.session === \"\") {\n      throw new DatabaseError(\"empty session, please try again\", 500, null);\n    }\n    const arrayMode = options.arrayMode ?? this.config.arrayMode ?? false;\n    const fullResult = options.fullResult ?? this.config.fullResult ?? false;\n    const decoders = { ...this.config.decoders, ...options.decoders };\n    const fields = resp?.types ?? [];\n    const rows = resp ? parse(fields, resp?.rows ?? [], cast, arrayMode, decoders) : [];\n    if (fullResult) {\n      const rowsAffected = resp?.rowsAffected ?? null;\n      const lastInsertId = resp?.sLastInsertID ?? null;\n      const typeByName = (acc, { name, type }) => ({ ...acc, [name]: type });\n      const types = fields.reduce(typeByName, {});\n      return {\n        statement: sql,\n        types,\n        rows,\n        rowsAffected,\n        lastInsertId,\n        rowCount: rows.length\n      };\n    }\n    return rows;\n  }\n};\nfunction connect(config) {\n  return new Connection(config);\n}\nfunction parseArrayRow(fields, rawRow, cast2, decoders) {\n  return fields.map((field, ix) => {\n    return cast2(field, rawRow[ix], decoders);\n  });\n}\nfunction parseObjectRow(fields, rawRow, cast2, decoders) {\n  return fields.reduce((acc, field, ix) => {\n    acc[field.name] = cast2(field, rawRow[ix], decoders);\n    return acc;\n  }, {});\n}\nfunction parse(fields, rows, cast2, arrayMode, decode) {\n  return rows.map((row) => arrayMode === true ? parseArrayRow(fields, row, cast2, decode) : parseObjectRow(fields, row, cast2, decode));\n}\nexport {\n  ColumnType,\n  Connection,\n  DatabaseError,\n  Tx,\n  connect\n};\n", "import { Env, ApiResponse, PlayerSide } from \"../types\";\nimport { executeQuery, executeUpdate, queries } from \"../db/tidb\";\n\n// \u521B\u5EFA\u6E38\u620F\nexport async function createGame(request: Request, env: Env): Promise<Response> {\n  try {\n    const { agent_id } = await request.json() as { agent_id: string };\n    \n    if (!agent_id) {\n      return Response.json({ success: false, error: { code: 1000, message: \"\u7F3A\u5C11agent_id\" } }, { status: 400 });\n    }\n    \n    const gameId = crypto.randomUUID();\n    \n    // \u5728 TiDB \u521B\u5EFA\u8BB0\u5F55\n    await executeUpdate(env, queries.createGame, [gameId, agent_id]);\n    \n    // \u83B7\u53D6 Durable Object\n    const roomId = env.GAME_ROOM.idFromName(gameId);\n    const room = env.GAME_ROOM.get(roomId);\n    \n    // \u521D\u59CB\u5316\u6E38\u620F\u623F\u95F4\n    const response = await room.fetch(new Request(\"http://internal/create\", {\n      method: \"POST\",\n      body: JSON.stringify({ gameId, p1: agent_id })\n    }));\n    \n    if (!response.ok) {\n      throw new Error(\"Failed to create game room\");\n    }\n    \n    return Response.json({\n      success: true,\n      data: {\n        game_id: gameId,\n        player: \"p1\",\n        status: \"waiting\",\n        ws_url: `wss://${new URL(request.url).host}/api/games/${gameId}/ws?player=p1`\n      }\n    });\n  } catch (error) {\n    console.error(\"Create game error:\", error);\n    return Response.json({ success: false, error: { code: -1, message: String(error) } }, { status: 500 });\n  }\n}\n\n// \u52A0\u5165\u6E38\u620F\nexport async function joinGame(request: Request, env: Env, gameId: string): Promise<Response> {\n  try {\n    const { agent_id } = await request.json() as { agent_id: string };\n    \n    if (!agent_id) {\n      return Response.json({ success: false, error: { code: 1000, message: \"\u7F3A\u5C11agent_id\" } }, { status: 400 });\n    }\n    \n    // \u66F4\u65B0 TiDB\n    const result = await executeUpdate(env, queries.joinGame, [agent_id, gameId]);\n    \n    if (result.affectedRows === 0) {\n      return Response.json({ success: false, error: { code: 1001, message: \"\u6E38\u620F\u4E0D\u5B58\u5728\u6216\u5DF2\u6EE1\" } }, { status: 404 });\n    }\n    \n    // \u901A\u77E5 Durable Object\n    const roomId = env.GAME_ROOM.idFromName(gameId);\n    const room = env.GAME_ROOM.get(roomId);\n    \n    const response = await room.fetch(new Request(\"http://internal/join\", {\n      method: \"POST\",\n      body: JSON.stringify({ agent_id })\n    }));\n    \n    const data = await response.json() as ApiResponse;\n    \n    if (!data.success) {\n      return Response.json(data, { status: 400 });\n    }\n    \n    return Response.json({\n      success: true,\n      data: {\n        game_id: gameId,\n        player: \"p2\",\n        status: \"selecting\",\n        ws_url: `wss://${new URL(request.url).host}/api/games/${gameId}/ws?player=p2`\n      }\n    });\n  } catch (error) {\n    console.error(\"Join game error:\", error);\n    return Response.json({ success: false, error: { code: -1, message: String(error) } }, { status: 500 });\n  }\n}\n\n// \u83B7\u53D6\u7B49\u5F85\u4E2D\u7684\u6E38\u620F\u5217\u8868\nexport async function getWaitingGames(request: Request, env: Env): Promise<Response> {\n  try {\n    const url = new URL(request.url);\n    const limit = parseInt(url.searchParams.get(\"limit\") || \"10\");\n    \n    const games = await executeQuery<{\n      id: string;\n      p1_agent_id: string;\n      created_at: string;\n      p1_name: string;\n      p1_elo: number;\n    }>(env, queries.getWaitingGames, [Math.min(limit, 50)]);\n    \n    return Response.json({\n      success: true,\n      data: { games }\n    });\n  } catch (error) {\n    console.error(\"Get waiting games error:\", error);\n    return Response.json({ success: false, error: { code: -1, message: String(error) } }, { status: 500 });\n  }\n}\n\n// \u83B7\u53D6\u6E38\u620F\u4FE1\u606F\nexport async function getGameInfo(request: Request, env: Env, gameId: string): Promise<Response> {\n  try {\n    const games = await executeQuery<{\n      id: string;\n      p1_agent_id: string;\n      p2_agent_id: string;\n      status: string;\n      winner: string;\n      win_reason: string;\n      total_turns: number;\n      p1_name: string;\n      p1_elo: number;\n      p2_name: string;\n      p2_elo: number;\n      started_at: string;\n      finished_at: string;\n      created_at: string;\n    }>(env, queries.getGame, [gameId]);\n    \n    if (games.length === 0) {\n      return Response.json({ success: false, error: { code: 1001, message: \"\u6E38\u620F\u4E0D\u5B58\u5728\" } }, { status: 404 });\n    }\n    \n    return Response.json({\n      success: true,\n      data: games[0]\n    });\n  } catch (error) {\n    console.error(\"Get game info error:\", error);\n    return Response.json({ success: false, error: { code: -1, message: String(error) } }, { status: 500 });\n  }\n}\n\n// \u83B7\u53D6\u6E38\u620F\u5386\u53F2\nexport async function getGameHistory(request: Request, env: Env): Promise<Response> {\n  try {\n    const url = new URL(request.url);\n    const agentId = url.searchParams.get(\"agent_id\");\n    const limit = parseInt(url.searchParams.get(\"limit\") || \"20\");\n    \n    if (!agentId) {\n      return Response.json({ success: false, error: { code: 1000, message: \"\u7F3A\u5C11agent_id\" } }, { status: 400 });\n    }\n    \n    const games = await executeQuery<{\n      id: string;\n      status: string;\n      winner: string;\n      win_reason: string;\n      total_turns: number;\n      started_at: string;\n      finished_at: string;\n      p1_name: string;\n      p2_name: string;\n    }>(env, queries.getGameHistory, [agentId, agentId, Math.min(limit, 100)]);\n    \n    return Response.json({\n      success: true,\n      data: { games }\n    });\n  } catch (error) {\n    console.error(\"Get game history error:\", error);\n    return Response.json({ success: false, error: { code: -1, message: String(error) } }, { status: 500 });\n  }\n}\n\n// \u83B7\u53D6\u6392\u884C\u699C\nexport async function getLeaderboard(request: Request, env: Env): Promise<Response> {\n  try {\n    const url = new URL(request.url);\n    const limit = parseInt(url.searchParams.get(\"limit\") || \"50\");\n    \n    const leaderboard = await executeQuery<{\n      id: string;\n      name: string;\n      elo_rating: number;\n      games_played: number;\n      games_won: number;\n      win_rate: number;\n    }>(env, queries.getLeaderboard, [Math.min(limit, 100)]);\n    \n    return Response.json({\n      success: true,\n      data: { leaderboard }\n    });\n  } catch (error) {\n    console.error(\"Get leaderboard error:\", error);\n    return Response.json({ success: false, error: { code: -1, message: String(error) } }, { status: 500 });\n  }\n}\n\n// WebSocket \u8FDE\u63A5\u5904\u7406\nexport async function handleWebSocket(request: Request, env: Env, gameId: string): Promise<Response> {\n  const url = new URL(request.url);\n  const player = url.searchParams.get(\"player\") as PlayerSide;\n  \n  if (!player || (player !== \"p1\" && player !== \"p2\")) {\n    return new Response(\"Invalid player parameter\", { status: 400 });\n  }\n  \n  const roomId = env.GAME_ROOM.idFromName(gameId);\n  const room = env.GAME_ROOM.get(roomId);\n  \n  // \u8F6C\u53D1\u5230 Durable Object\n  return room.fetch(new Request(`http://internal/ws?player=${player}`, {\n    headers: request.headers\n  }));\n}\n", "import { Env, ApiResponse, PlayerSide, ActionType } from \"../types\";\nimport { executeUpdate, queries } from \"../db/tidb\";\n\n// Ban\u6B66\u5C06\nexport async function banGeneral(request: Request, env: Env, gameId: string, player: PlayerSide): Promise<Response> {\n  try {\n    const { general_id } = await request.json() as { general_id: number };\n    \n    if (typeof general_id !== \"number\" || general_id < 1 || general_id > 30) {\n      return Response.json({ success: false, error: { code: 1010, message: \"\u65E0\u6548\u6B66\u5C06ID\" } }, { status: 400 });\n    }\n    \n    const roomId = env.GAME_ROOM.idFromName(gameId);\n    const room = env.GAME_ROOM.get(roomId);\n    \n    const response = await room.fetch(new Request(\"http://internal/ban\", {\n      method: \"POST\",\n      body: JSON.stringify({ player, general_id })\n    }));\n    \n    const data = await response.json() as ApiResponse;\n    \n    // \u8BB0\u5F55Ban\u7EDF\u8BA1\n    if (data.success) {\n      try {\n        await executeUpdate(env, queries.updateGeneralBanStats, [general_id]);\n      } catch (e) {\n        console.error(\"Failed to update ban stats:\", e);\n      }\n    }\n    \n    return Response.json(data, { status: data.success ? 200 : 400 });\n  } catch (error) {\n    console.error(\"Ban general error:\", error);\n    return Response.json({ success: false, error: { code: -1, message: String(error) } }, { status: 500 });\n  }\n}\n\n// Pick\u6B66\u5C06\nexport async function pickGeneral(request: Request, env: Env, gameId: string, player: PlayerSide): Promise<Response> {\n  try {\n    const { general_id } = await request.json() as { general_id: number };\n    \n    if (typeof general_id !== \"number\" || general_id < 1 || general_id > 30) {\n      return Response.json({ success: false, error: { code: 1010, message: \"\u65E0\u6548\u6B66\u5C06ID\" } }, { status: 400 });\n    }\n    \n    const roomId = env.GAME_ROOM.idFromName(gameId);\n    const room = env.GAME_ROOM.get(roomId);\n    \n    const response = await room.fetch(new Request(\"http://internal/pick\", {\n      method: \"POST\",\n      body: JSON.stringify({ player, general_id })\n    }));\n    \n    return new Response(response.body, {\n      status: response.status,\n      headers: response.headers\n    });\n  } catch (error) {\n    console.error(\"Pick general error:\", error);\n    return Response.json({ success: false, error: { code: -1, message: String(error) } }, { status: 500 });\n  }\n}\n\n// \u90E8\u7F72\u6B66\u5C06\nexport async function deployGenerals(request: Request, env: Env, gameId: string, player: PlayerSide): Promise<Response> {\n  try {\n    const { deployments } = await request.json() as { deployments: { general_id: number; x: number; y: number }[] };\n    \n    if (!Array.isArray(deployments) || deployments.length === 0) {\n      return Response.json({ success: false, error: { code: 1000, message: \"\u7F3A\u5C11\u90E8\u7F72\u4FE1\u606F\" } }, { status: 400 });\n    }\n    \n    // \u9A8C\u8BC1\u90E8\u7F72\u6570\u636E\u683C\u5F0F\n    for (const dep of deployments) {\n      if (typeof dep.general_id !== \"number\" || typeof dep.x !== \"number\" || typeof dep.y !== \"number\") {\n        return Response.json({ success: false, error: { code: 1000, message: \"\u90E8\u7F72\u6570\u636E\u683C\u5F0F\u9519\u8BEF\" } }, { status: 400 });\n      }\n      if (dep.x < 0 || dep.x >= 100 || dep.y < 0 || dep.y >= 100) {\n        return Response.json({ success: false, error: { code: 1013, message: \"\u5750\u6807\u8D85\u51FA\u5730\u56FE\u8303\u56F4\" } }, { status: 400 });\n      }\n    }\n    \n    const roomId = env.GAME_ROOM.idFromName(gameId);\n    const room = env.GAME_ROOM.get(roomId);\n    \n    const response = await room.fetch(new Request(\"http://internal/deploy\", {\n      method: \"POST\",\n      body: JSON.stringify({ player, deployments })\n    }));\n    \n    return new Response(response.body, {\n      status: response.status,\n      headers: response.headers\n    });\n  } catch (error) {\n    console.error(\"Deploy generals error:\", error);\n    return Response.json({ success: false, error: { code: -1, message: String(error) } }, { status: 500 });\n  }\n}\n\n// \u6267\u884C\u6E38\u620F\u64CD\u4F5C\nexport async function executeAction(request: Request, env: Env, gameId: string, player: PlayerSide): Promise<Response> {\n  try {\n    const body = await request.json() as {\n      action: ActionType;\n      instance_id?: string;\n      target_x?: number;\n      target_y?: number;\n      target_instance_id?: string;\n      skill_target?: string;\n    };\n    \n    const { action, instance_id, target_x, target_y, target_instance_id, skill_target } = body;\n    \n    // \u9A8C\u8BC1action\u7C7B\u578B\n    const validActions: ActionType[] = [\"MOVE\", \"ATTACK\", \"SKILL\", \"WAIT\", \"RETREAT\", \"END_TURN\"];\n    if (!validActions.includes(action)) {\n      return Response.json({ success: false, error: { code: 1008, message: \"\u65E0\u6548\u64CD\u4F5C\u7C7B\u578B\" } }, { status: 400 });\n    }\n    \n    // \u6839\u636Eaction\u7C7B\u578B\u9A8C\u8BC1\u5FC5\u8981\u53C2\u6570\n    if (action === \"MOVE\") {\n      if (!instance_id || typeof target_x !== \"number\" || typeof target_y !== \"number\") {\n        return Response.json({ success: false, error: { code: 1000, message: \"\u79FB\u52A8\u64CD\u4F5C\u9700\u8981instance_id\u548C\u76EE\u6807\u5750\u6807\" } }, { status: 400 });\n      }\n    }\n    \n    if (action === \"ATTACK\") {\n      if (!instance_id || !target_instance_id) {\n        return Response.json({ success: false, error: { code: 1000, message: \"\u653B\u51FB\u64CD\u4F5C\u9700\u8981instance_id\u548Ctarget_instance_id\" } }, { status: 400 });\n      }\n    }\n    \n    if (action === \"SKILL\" || action === \"WAIT\" || action === \"RETREAT\") {\n      if (!instance_id) {\n        return Response.json({ success: false, error: { code: 1000, message: \"\u9700\u8981\u6307\u5B9A\u6B66\u5C06instance_id\" } }, { status: 400 });\n      }\n    }\n    \n    const roomId = env.GAME_ROOM.idFromName(gameId);\n    const room = env.GAME_ROOM.get(roomId);\n    \n    const response = await room.fetch(new Request(\"http://internal/action\", {\n      method: \"POST\",\n      body: JSON.stringify({\n        player,\n        action,\n        instance_id,\n        target_x,\n        target_y,\n        target_instance_id,\n        skill_target\n      })\n    }));\n    \n    const data = await response.json() as ApiResponse;\n    \n    // \u8BB0\u5F55\u64CD\u4F5C\u65E5\u5FD7\n    if (data.success) {\n      try {\n        // \u83B7\u53D6\u5F53\u524D\u56DE\u5408\u6570\uFF08\u4ECE\u54CD\u5E94\u6570\u636E\u4E2D\uFF09\n        const turn = data.data?.turn || 0;\n        await executeUpdate(env, queries.logAction, [\n          gameId,\n          turn,\n          player,\n          action,\n          JSON.stringify(body),\n          JSON.stringify(data.data)\n        ]);\n      } catch (e) {\n        console.error(\"Failed to log action:\", e);\n      }\n    }\n    \n    return Response.json(data, { status: data.success ? 200 : 400 });\n  } catch (error) {\n    console.error(\"Execute action error:\", error);\n    return Response.json({ success: false, error: { code: -1, message: String(error) } }, { status: 500 });\n  }\n}\n\n// \u83B7\u53D6\u53EF\u79FB\u52A8\u8303\u56F4\nexport async function getMoveableArea(request: Request, env: Env, gameId: string, player: PlayerSide): Promise<Response> {\n  try {\n    const url = new URL(request.url);\n    const instanceId = url.searchParams.get(\"instance_id\");\n    \n    if (!instanceId) {\n      return Response.json({ success: false, error: { code: 1000, message: \"\u7F3A\u5C11instance_id\" } }, { status: 400 });\n    }\n    \n    // \u83B7\u53D6\u6E38\u620F\u72B6\u6001\n    const roomId = env.GAME_ROOM.idFromName(gameId);\n    const room = env.GAME_ROOM.get(roomId);\n    \n    const stateResponse = await room.fetch(new Request(`http://internal/state?player=${player}`));\n    const stateData = await stateResponse.json() as ApiResponse;\n    \n    if (!stateData.success || !stateData.data) {\n      return Response.json({ success: false, error: { code: 1001, message: \"\u83B7\u53D6\u6E38\u620F\u72B6\u6001\u5931\u8D25\" } }, { status: 400 });\n    }\n    \n    // \u8FD9\u91CC\u5E94\u8BE5\u8C03\u7528movement\u670D\u52A1\u8BA1\u7B97\u53EF\u79FB\u52A8\u8303\u56F4\n    // \u7B80\u5316\u5904\u7406\uFF1A\u8FD4\u56DE\u72B6\u6001\u4F9B\u5BA2\u6237\u7AEF\u8BA1\u7B97\n    return Response.json({\n      success: true,\n      data: { message: \"\u8BF7\u5728\u5BA2\u6237\u7AEF\u6839\u636E\u6E38\u620F\u72B6\u6001\u8BA1\u7B97\u53EF\u79FB\u52A8\u8303\u56F4\" }\n    });\n  } catch (error) {\n    console.error(\"Get moveable area error:\", error);\n    return Response.json({ success: false, error: { code: -1, message: String(error) } }, { status: 500 });\n  }\n}\n\n// \u83B7\u53D6\u53EF\u653B\u51FB\u76EE\u6807\nexport async function getAttackTargets(request: Request, env: Env, gameId: string, player: PlayerSide): Promise<Response> {\n  try {\n    const url = new URL(request.url);\n    const instanceId = url.searchParams.get(\"instance_id\");\n    \n    if (!instanceId) {\n      return Response.json({ success: false, error: { code: 1000, message: \"\u7F3A\u5C11instance_id\" } }, { status: 400 });\n    }\n    \n    // \u83B7\u53D6\u6E38\u620F\u72B6\u6001\n    const roomId = env.GAME_ROOM.idFromName(gameId);\n    const room = env.GAME_ROOM.get(roomId);\n    \n    const stateResponse = await room.fetch(new Request(`http://internal/state?player=${player}`));\n    const stateData = await stateResponse.json() as ApiResponse;\n    \n    if (!stateData.success || !stateData.data) {\n      return Response.json({ success: false, error: { code: 1001, message: \"\u83B7\u53D6\u6E38\u620F\u72B6\u6001\u5931\u8D25\" } }, { status: 400 });\n    }\n    \n    // \u8FD9\u91CC\u5E94\u8BE5\u8C03\u7528combat\u670D\u52A1\u8BA1\u7B97\u53EF\u653B\u51FB\u76EE\u6807\n    // \u7B80\u5316\u5904\u7406\uFF1A\u8FD4\u56DE\u72B6\u6001\u4F9B\u5BA2\u6237\u7AEF\u8BA1\u7B97\n    return Response.json({\n      success: true,\n      data: { message: \"\u8BF7\u5728\u5BA2\u6237\u7AEF\u6839\u636E\u6E38\u620F\u72B6\u6001\u8BA1\u7B97\u53EF\u653B\u51FB\u76EE\u6807\" }\n    });\n  } catch (error) {\n    console.error(\"Get attack targets error:\", error);\n    return Response.json({ success: false, error: { code: -1, message: String(error) } }, { status: 500 });\n  }\n}\n", "import { Env, ApiResponse, PlayerSide, GameStateResponse } from \"../types\";\nimport { getGeneralById } from \"../data/generals\";\nimport { executeQuery, queries } from \"../db/tidb\";\nimport { getVisibleEnemies } from \"../services/vision\";\n\n// \u83B7\u53D6\u6E38\u620F\u72B6\u6001\nexport async function getGameState(request: Request, env: Env, gameId: string, player: PlayerSide): Promise<Response> {\n  try {\n    const roomId = env.GAME_ROOM.idFromName(gameId);\n    const room = env.GAME_ROOM.get(roomId);\n    \n    const response = await room.fetch(new Request(`http://internal/state?player=${player}`));\n    const data = await response.json() as ApiResponse;\n    \n    if (!data.success || !data.data) {\n      return Response.json(data, { status: 400 });\n    }\n    \n    // \u683C\u5F0F\u5316\u54CD\u5E94\n    const gameState = data.data;\n    const myGenerals = player === \"p1\" ? gameState.p1_generals : gameState.p2_generals;\n    const enemyGenerals = player === \"p1\" ? gameState.p2_generals : gameState.p1_generals;\n    \n    // \u6784\u9020\u73A9\u5BB6\u89C6\u89D2\u7684\u54CD\u5E94\n    const formattedResponse: GameStateResponse = {\n      game_id: gameState.game_id,\n      status: gameState.status,\n      turn: gameState.turn,\n      current_player: gameState.current_player,\n      my_player: player,\n      \n      my_generals: myGenerals.map((g: any) => {\n        const data = getGeneralById(g.general_id);\n        return {\n          instance_id: g.instance_id,\n          general_id: g.general_id,\n          name: data?.name || \"Unknown\",\n          current_hp: g.current_hp,\n          max_hp: data?.base_hp || 0,\n          atk: (data?.base_atk || 0) + g.atk_modifier,\n          def: (data?.base_def || 0) + g.def_modifier,\n          mov: (data?.base_mov || 0) + g.mov_modifier,\n          position: g.position,\n          has_acted: g.has_acted,\n          buffs: g.buffs.map((b: any) => b.type),\n        };\n      }),\n      \n      visible_enemies: enemyGenerals\n        .filter((e: any) => e.is_alive)\n        .map((e: any) => {\n          const data = getGeneralById(e.general_id);\n          return {\n            instance_id: e.instance_id,\n            general_id: e.general_id,\n            name: data?.name || \"Unknown\",\n            current_hp: e.current_hp,\n            max_hp: data?.base_hp || 0,\n            position: e.position,\n          };\n        }),\n      \n      city: {\n        holder: gameState.city_holder,\n        hold_turns: gameState.city_hold_turns,\n      },\n      \n      action_cooldown: {\n        can_act: true, // \u51B7\u5374\u68C0\u67E5\u5728action handler\u4E2D\u5904\u7406\n        next_action_time: 0,\n      },\n      \n      pick_phase: gameState.pick_phase,\n      banned_generals: gameState.banned_generals,\n      my_picks: player === \"p1\" ? gameState.p1_picks : gameState.p2_picks,\n      enemy_picks: player === \"p1\" ? gameState.p2_picks : gameState.p1_picks,\n      \n      winner: gameState.winner,\n      win_reason: gameState.win_reason,\n    };\n    \n    return Response.json({ success: true, data: formattedResponse });\n  } catch (error) {\n    console.error(\"Get game state error:\", error);\n    return Response.json({ success: false, error: { code: -1, message: String(error) } }, { status: 500 });\n  }\n}\n\n// \u83B7\u53D6\u5730\u56FE\u6570\u636E\nexport async function getMapData(request: Request, env: Env): Promise<Response> {\n  try {\n    // \u8FD4\u56DE\u5730\u56FE\u914D\u7F6E\u4FE1\u606F\n    const mapInfo = {\n      width: 100,\n      height: 100,\n      terrains: {\n        plain: { mov_cost: 1, def_bonus: 0 },\n        forest: { mov_cost: 2, def_bonus: 1 },\n        mountain: { mov_cost: 3, def_bonus: 2 },\n        river: { mov_cost: 999, def_bonus: 0 },\n        bridge: { mov_cost: 1, def_bonus: 0 },\n        road: { mov_cost: 0.5, def_bonus: 0 },\n        city: { mov_cost: 1, def_bonus: 2 },\n      },\n      special_areas: {\n        p1_spawn: { x1: 0, y1: 0, x2: 19, y2: 19 },\n        p2_spawn: { x1: 80, y1: 80, x2: 99, y2: 99 },\n        city_area: { x1: 48, y1: 48, x2: 52, y2: 52 },\n        city_gates: [\n          { x: 48, y: 50 },\n          { x: 52, y: 50 },\n          { x: 50, y: 48 },\n          { x: 50, y: 52 },\n        ],\n      },\n      rivers: {\n        north: { y: 25, bridges: [{ x: 33 }, { x: 66 }] },\n        south: { y: 75, bridges: [{ x: 33 }, { x: 66 }] },\n      },\n    };\n    \n    return Response.json({ success: true, data: mapInfo });\n  } catch (error) {\n    console.error(\"Get map data error:\", error);\n    return Response.json({ success: false, error: { code: -1, message: String(error) } }, { status: 500 });\n  }\n}\n\n// \u83B7\u53D6\u6B66\u5C06\u5217\u8868\nexport async function getGeneralsList(request: Request, env: Env): Promise<Response> {\n  try {\n    const { GENERALS } = await import(\"../data/generals\");\n    \n    return Response.json({\n      success: true,\n      data: {\n        generals: GENERALS.map(g => ({\n          id: g.id,\n          name: g.name,\n          faction: g.faction,\n          type: g.type,\n          base_hp: g.base_hp,\n          base_atk: g.base_atk,\n          base_def: g.base_def,\n          base_mov: g.base_mov,\n          skill_name: g.skill_name,\n          skill_desc: g.skill_desc,\n          skill_type: g.skill_type,\n        }))\n      }\n    });\n  } catch (error) {\n    console.error(\"Get generals list error:\", error);\n    return Response.json({ success: false, error: { code: -1, message: String(error) } }, { status: 500 });\n  }\n}\n\n// \u83B7\u53D6\u6B66\u5C06\u7EDF\u8BA1\nexport async function getGeneralStats(request: Request, env: Env): Promise<Response> {\n  try {\n    const stats = await executeQuery<{\n      general_id: number;\n      total_picks: number;\n      total_wins: number;\n      total_bans: number;\n      win_rate: number;\n    }>(env, queries.getGeneralStats, []);\n    \n    // \u5408\u5E76\u6B66\u5C06\u57FA\u672C\u4FE1\u606F\n    const { GENERALS } = await import(\"../data/generals\");\n    const statsWithInfo = stats.map(s => {\n      const general = GENERALS.find(g => g.id === s.general_id);\n      return {\n        ...s,\n        name: general?.name || \"Unknown\",\n        faction: general?.faction || \"Unknown\",\n      };\n    });\n    \n    return Response.json({\n      success: true,\n      data: { stats: statsWithInfo }\n    });\n  } catch (error) {\n    console.error(\"Get general stats error:\", error);\n    return Response.json({ success: false, error: { code: -1, message: String(error) } }, { status: 500 });\n  }\n}\n\n// \u83B7\u53D6\u5BF9\u5C40\u56DE\u653E\nexport async function getGameReplay(request: Request, env: Env, gameId: string): Promise<Response> {\n  try {\n    // \u83B7\u53D6\u6E38\u620F\u4FE1\u606F\n    const games = await executeQuery<any>(env, queries.getGame, [gameId]);\n    \n    if (games.length === 0) {\n      return Response.json({ success: false, error: { code: 1001, message: \"\u6E38\u620F\u4E0D\u5B58\u5728\" } }, { status: 404 });\n    }\n    \n    const game = games[0];\n    \n    // \u83B7\u53D6\u64CD\u4F5C\u65E5\u5FD7\n    const actionLogs = await executeQuery<{\n      turn: number;\n      player: string;\n      action_type: string;\n      action_data: string;\n      result: string;\n      created_at: string;\n    }>(env, queries.getActionLogs, [gameId]);\n    \n    return Response.json({\n      success: true,\n      data: {\n        game: {\n          id: game.id,\n          p1_name: game.p1_name,\n          p2_name: game.p2_name,\n          winner: game.winner,\n          win_reason: game.win_reason,\n          total_turns: game.total_turns,\n          p1_generals: game.p1_generals,\n          p2_generals: game.p2_generals,\n          banned_generals: game.banned_generals,\n        },\n        actions: actionLogs.map(log => ({\n          turn: log.turn,\n          player: log.player,\n          action_type: log.action_type,\n          action_data: typeof log.action_data === \"string\" ? JSON.parse(log.action_data) : log.action_data,\n          result: typeof log.result === \"string\" ? JSON.parse(log.result) : log.result,\n          timestamp: log.created_at,\n        }))\n      }\n    });\n  } catch (error) {\n    console.error(\"Get game replay error:\", error);\n    return Response.json({ success: false, error: { code: -1, message: String(error) } }, { status: 500 });\n  }\n}\n\n// \u83B7\u53D6\u9009\u5C06\u9636\u6BB5\u4FE1\u606F\nexport async function getPickPhaseInfo(request: Request, env: Env): Promise<Response> {\n  try {\n    const { PICK_ORDER } = await import(\"../types\");\n    \n    return Response.json({\n      success: true,\n      data: {\n        phases: PICK_ORDER,\n        description: {\n          total_phases: 10,\n          bans_per_player: 2,\n          picks_per_player: 5,\n        }\n      }\n    });\n  } catch (error) {\n    console.error(\"Get pick phase info error:\", error);\n    return Response.json({ success: false, error: { code: -1, message: String(error) } }, { status: 500 });\n  }\n}\n\n// \u5065\u5EB7\u68C0\u67E5\nexport async function healthCheck(request: Request, env: Env): Promise<Response> {\n  return Response.json({\n    success: true,\n    data: {\n      status: \"ok\",\n      timestamp: new Date().toISOString(),\n      environment: env.ENVIRONMENT || \"development\",\n    }\n  });\n}\n", "import type { Middleware } from \"./common\";\n\nconst drainBody: Middleware = async (request, env, _ctx, middlewareCtx) => {\n\ttry {\n\t\treturn await middlewareCtx.next(request, env);\n\t} finally {\n\t\ttry {\n\t\t\tif (request.body !== null && !request.bodyUsed) {\n\t\t\t\tconst reader = request.body.getReader();\n\t\t\t\twhile (!(await reader.read()).done) {}\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tconsole.error(\"Failed to drain the unused request body.\", e);\n\t\t}\n\t}\n};\n\nexport default drainBody;\n", "import type { Middleware } from \"./common\";\n\ninterface JsonError {\n\tmessage?: string;\n\tname?: string;\n\tstack?: string;\n\tcause?: JsonError;\n}\n\nfunction reduceError(e: any): JsonError {\n\treturn {\n\t\tname: e?.name,\n\t\tmessage: e?.message ?? String(e),\n\t\tstack: e?.stack,\n\t\tcause: e?.cause === undefined ? undefined : reduceError(e.cause),\n\t};\n}\n\n// See comment in `bundle.ts` for details on why this is needed\nconst jsonError: Middleware = async (request, env, _ctx, middlewareCtx) => {\n\ttry {\n\t\treturn await middlewareCtx.next(request, env);\n\t} catch (e: any) {\n\t\tconst error = reduceError(e);\n\t\treturn Response.json(error, {\n\t\t\tstatus: 500,\n\t\t\theaders: { \"MF-Experimental-Error-Stack\": \"true\" },\n\t\t});\n\t}\n};\n\nexport default jsonError;\n", "export type Awaitable<T> = T | Promise<T>;\n// TODO: allow dispatching more events?\nexport type Dispatcher = (\n\ttype: \"scheduled\",\n\tinit: { cron?: string }\n) => Awaitable<void>;\n\nexport type IncomingRequest = Request<\n\tunknown,\n\tIncomingRequestCfProperties<unknown>\n>;\n\nexport interface MiddlewareContext {\n\tdispatch: Dispatcher;\n\tnext(request: IncomingRequest, env: any): Awaitable<Response>;\n}\n\nexport type Middleware = (\n\trequest: IncomingRequest,\n\tenv: any,\n\tctx: ExecutionContext,\n\tmiddlewareCtx: MiddlewareContext\n) => Awaitable<Response>;\n\nconst __facade_middleware__: Middleware[] = [];\n\n// The register functions allow for the insertion of one or many middleware,\n// We register internal middleware first in the stack, but have no way of controlling\n// the order that addMiddleware is run in service workers so need an internal function.\nexport function __facade_register__(...args: (Middleware | Middleware[])[]) {\n\t__facade_middleware__.push(...args.flat());\n}\nexport function __facade_registerInternal__(\n\t...args: (Middleware | Middleware[])[]\n) {\n\t__facade_middleware__.unshift(...args.flat());\n}\n\nfunction __facade_invokeChain__(\n\trequest: IncomingRequest,\n\tenv: any,\n\tctx: ExecutionContext,\n\tdispatch: Dispatcher,\n\tmiddlewareChain: Middleware[]\n): Awaitable<Response> {\n\tconst [head, ...tail] = middlewareChain;\n\tconst middlewareCtx: MiddlewareContext = {\n\t\tdispatch,\n\t\tnext(newRequest, newEnv) {\n\t\t\treturn __facade_invokeChain__(newRequest, newEnv, ctx, dispatch, tail);\n\t\t},\n\t};\n\treturn head(request, env, ctx, middlewareCtx);\n}\n\nexport function __facade_invoke__(\n\trequest: IncomingRequest,\n\tenv: any,\n\tctx: ExecutionContext,\n\tdispatch: Dispatcher,\n\tfinalMiddleware: Middleware\n): Awaitable<Response> {\n\treturn __facade_invokeChain__(request, env, ctx, dispatch, [\n\t\t...__facade_middleware__,\n\t\tfinalMiddleware,\n\t]);\n}\n"],
  "mappings": "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",
  "names": ["posKey", "data", "GENERALS"]
}
